<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 900px;
            margin: auto;
        }
        .active-nav {
            color: #4f46e5;
        }
        .active-nav-bg {
            background-color: #eef2ff;
        }
        .delete-btn {
            background-color: #fca5a5;
            color: #991b1b;
        }
        .delete-btn:hover {
            background-color: #f87171;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="fixed inset-0 bg-gray-200 bg-opacity-75 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-blue-500 border-opacity-75"></div>
    </div>
    
    <!-- Login/Signup Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h3 id="auth-modal-title" class="text-2xl font-bold text-center mb-6 text-gray-800">Sign in</h3>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="auth-email" class="block text-sm font-medium text-gray-700">Email address</label>
                    <input type="email" id="auth-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="auth-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="auth-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <button type="submit" id="auth-submit-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors duration-200">Sign in</button>
            </form>
            <p id="auth-toggle-link" class="text-center text-sm mt-4 text-gray-600 cursor-pointer">
                Don't have an account? <span class="font-medium text-indigo-600 hover:text-indigo-800">Sign up</span>
            </p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="container bg-white rounded-xl shadow-lg m-4 p-6 flex-grow relative hidden">

        <!-- Header and User Info -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">My Portfolio</h1>
            <div class="flex items-center space-x-2">
                <div class="flex items-center space-x-2 bg-gray-50 text-gray-600 px-3 py-1 rounded-full text-sm">
                    <span id="user-id-display" class="truncate">Authenticating...</span>
                </div>
                <button id="logout-btn" class="text-sm text-red-500 hover:text-red-700 transition-colors duration-200 font-medium">Log out</button>
            </div>
        </header>

        <!-- Main Content Area -->
        <div id="content-area" class="pb-24">
            <!-- Dashboard View -->
            <div id="dashboard-page" class="page">
                <section class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-indigo-50 p-6 rounded-xl shadow-inner border border-indigo-200">
                        <h2 class="text-lg text-indigo-800 font-semibold mb-2">Total Portfolio Value</h2>
                        <p id="total-value" class="text-4xl font-bold text-indigo-600">$0.00</p>
                    </div>
                    <div class="bg-green-50 p-6 rounded-xl shadow-inner border border-green-200">
                        <h2 class="text-lg text-green-800 font-semibold mb-2">Overall Gain/Loss</h2>
                        <p id="overall-gain-loss" class="text-4xl font-bold text-green-600">$0.00</p>
                        <span id="overall-gain-loss-pct" class="text-green-500 text-sm font-medium"> (0.00%)</span>
                    </div>
                </section>
                
                <section class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-blue-50 p-6 rounded-xl shadow-inner border border-blue-200">
                        <h2 class="text-lg text-blue-800 font-semibold mb-2">Time-Weighted Return (TWR)</h2>
                        <p id="twr-value" class="text-4xl font-bold text-blue-600">0.00%</p>
                        <p class="text-xs text-gray-500 mt-2">A measure of compound growth, unaffected by deposits/withdrawals.</p>
                    </div>
                    <div class="bg-blue-50 p-6 rounded-xl shadow-inner border border-blue-200">
                        <h2 class="text-lg text-blue-800 font-semibold mb-2">Money-Weighted Return (MWR)</h2>
                        <p id="mwr-value" class="text-4xl font-bold text-blue-600">0.00%</p>
                        <p class="text-xs text-gray-500 mt-2">The return rate that accounts for timing of cash flows.</p>
                    </div>
                </section>

                <section class="bg-white p-6 rounded-xl shadow border border-gray-100 mb-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Asset Allocation</h2>
                    <div class="w-full h-64 flex items-center justify-center">
                        <p id="chart-placeholder" class="text-gray-400">Add a transaction to see your asset allocation here.</p>
                        <canvas id="allocation-chart" class="w-full h-full hidden"></canvas>
                    </div>
                </section>

                <section class="flex justify-center">
                    <button id="get-ai-insights-btn" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-medium shadow-md hover:bg-purple-700 transition-colors duration-200">
                        Get AI Portfolio Summary âœ¨
                    </button>
                </section>
            </div>

            <!-- Portfolio View -->
            <div id="portfolio-page" class="page hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">My Investments</h2>
                    <button id="add-investment-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium shadow hover:bg-blue-700 transition-colors duration-200">
                        + Add New
                    </button>
                </div>
                <div class="flex items-center space-x-2 mb-4">
                    <span class="text-sm font-medium text-gray-700">Filter By:</span>
                    <button data-filter="all" class="filter-btn text-sm px-3 py-1 rounded-full bg-indigo-200 text-indigo-800 font-semibold">All</button>
                    <button data-filter="US" class="filter-btn text-sm px-3 py-1 rounded-full bg-gray-200 text-gray-700">US</button>
                    <button data-filter="Malaysia" class="filter-btn text-sm px-3 py-1 rounded-full bg-gray-200 text-gray-700">Malaysia</button>
                    <button data-filter="Stock" class="filter-btn text-sm px-3 py-1 rounded-full bg-gray-200 text-gray-700">Stocks</button>
                    <button data-filter="ETF" class="filter-btn text-sm px-3 py-1 rounded-full bg-gray-200 text-gray-700">ETFs</button>
                </div>
                <div id="investments-list" class="space-y-4">
                    <!-- Investment items will be rendered here -->
                </div>
                <div id="empty-state" class="text-center text-gray-400 mt-8 hidden">
                    <p class="mb-2">You don't have any investments yet.</p>
                    <p>Click "Add New" to get started!</p>
                </div>
            </div>

            <!-- Transactions View -->
            <div id="transactions-page" class="page hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Transaction History</h2>
                <div id="transactions-list" class="space-y-4">
                    <!-- Transaction items will be rendered here -->
                </div>
                <div id="empty-transactions-state" class="text-center text-gray-400 mt-8 hidden">
                    <p class="mb-2">No transactions recorded.</p>
                </div>
            </div>

            <!-- Markets View -->
            <div id="markets-page" class="page hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Global Markets</h2>
                <div class="bg-gray-50 p-6 rounded-xl shadow-inner text-center text-gray-400">
                    <p>This section would display live market data, news, and indices.</p>
                    <p>This is a placeholder as real-time market data requires a separate API integration.</p>
                </div>
            </div>

            <!-- Profile/Settings View -->
            <div id="profile-page" class="page hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Profile & Settings</h2>
                <div class="bg-gray-50 p-6 rounded-xl shadow-inner">
                    <p class="font-medium text-gray-700 mb-2">Your User ID:</p>
                    <p id="profile-user-id" class="text-sm font-mono break-all text-gray-500">Not available in demo mode</p>
                </div>
                <div class="mt-6 bg-red-50 p-6 rounded-xl shadow-inner border border-red-200">
                    <h3 class="text-lg font-semibold text-red-800 mb-2">Danger Zone</h3>
                    <p class="text-sm text-red-700 mb-4">
                        This action will permanently delete all of your data from the app.
                    </p>
                    <button id="delete-data-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium shadow hover:bg-red-700 transition-colors duration-200">
                        Delete My Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Adding/Editing an Investment -->
    <div id="investment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800">Add New Transaction</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">&times;</button>
            </div>
            <form id="investment-form" class="space-y-4">
                <div>
                    <label for="transaction-date" class="block text-sm font-medium text-gray-700">Date</label>
                    <input type="date" id="transaction-date" name="transaction-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Transaction Type</label>
                    <div class="mt-1 flex space-x-2">
                        <button type="button" id="type-buy-btn" class="flex-1 py-2 rounded-lg font-medium shadow-sm transition-colors duration-200 bg-indigo-600 text-white">Buy</button>
                        <button type="button" id="type-sell-btn" class="flex-1 py-2 rounded-lg font-medium shadow-sm transition-colors duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300">Sell</button>
                    </div>
                </div>
                <div>
                    <label for="market" class="block text-sm font-medium text-gray-700">Market</label>
                    <select id="market" name="market" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="US">US</option>
                        <option value="Malaysia">Malaysia</option>
                    </select>
                </div>
                <div>
                    <label for="asset-type" class="block text-sm font-medium text-gray-700">Asset Type</label>
                    <select id="asset-type" name="asset-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="Stock">Stock</option>
                        <option value="ETF">ETF</option>
                    </select>
                </div>
                <div>
                    <label for="ticker" class="block text-sm font-medium text-gray-700">Ticker Symbol</label>
                    <input type="text" id="ticker" name="ticker" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="shares" class="block text-sm font-medium text-gray-700">Number of Shares</label>
                    <input type="number" id="shares" name="shares" required min="0.01" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div id="buy-price-group" class="price-group">
                    <label for="buy-price" class="block text-sm font-medium text-gray-700">Buy Price (USD/MYR)</label>
                    <input type="number" id="buy-price" name="buy-price" required min="0.01" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div id="sell-price-group" class="price-group hidden">
                    <label for="sell-price" class="block text-sm font-medium text-gray-700">Sell Price (USD/MYR)</label>
                    <input type="number" id="sell-price" name="sell-price" required min="0.01" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <input type="hidden" id="transaction-id">
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors duration-200 mt-4">Save Transaction</button>
            </form>
        </div>
    </div>

    <!-- Modal for Detailed Investment View -->
    <div id="details-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 id="details-modal-title" class="text-xl font-bold text-gray-800"></h3>
                <button id="close-details-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">&times;</button>
            </div>
            <div class="space-y-4">
                <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                    <h4 class="font-semibold text-gray-700 mb-2">Price History (Simulated)</h4>
                    <div class="w-full h-48">
                        <canvas id="price-chart"></canvas>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-500">Quantity Owned</p>
                        <p id="details-shares" class="text-lg font-bold text-gray-800"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-500">Average Buy Price</p>
                        <p id="details-buy-price" class="text-lg font-bold text-gray-800"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-500">Total Cost</p>
                        <p id="details-total-cost" class="text-lg font-bold text-gray-800"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-500">Current Market Value</p>
                        <p id="details-current-value" class="text-lg font-bold text-gray-800"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm col-span-2">
                        <p class="text-sm text-gray-500">Unrealized Gain/Loss</p>
                        <p id="details-gain-loss" class="text-lg font-bold text-gray-800"></p>
                    </div>
                </div>
                <!-- New section for Transaction Log -->
                <div class="mt-6">
                    <h4 class="font-semibold text-xl text-gray-700 mb-2">Transaction History</h4>
                    <div id="details-transactions-list" class="space-y-4">
                        <!-- Transactions for this specific ticker will be rendered here -->
                    </div>
                    <div id="empty-details-transactions-state" class="text-center text-gray-400 mt-4 hidden">
                        <p>No transactions for this holding.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Message Box Modal -->
    <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
            <p id="message-box-text" class="text-gray-800 text-lg mb-4"></p>
            <div id="message-box-actions" class="flex justify-center space-x-4">
                <button id="message-box-ok-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors duration-200">OK</button>
            </div>
        </div>
    </div>

    <!-- AI Response Modal -->
    <div id="ai-response-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 id="ai-modal-title" class="text-xl font-bold text-gray-800">AI Insights</h3>
                <button id="close-ai-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">&times;</button>
            </div>
            <div id="ai-response-content" class="text-gray-700 prose max-w-none">
                <div class="flex items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-2 border-t-2 border-blue-500 border-opacity-75"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-2xl border-t border-gray-200 z-30">
        <ul class="flex justify-around items-center h-16 text-gray-500 text-sm">
            <li>
                <button id="nav-dashboard" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200 active-nav-bg active-nav">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <span class="mt-1">Dashboard</span>
                </button>
            </li>
            <li>
                <button id="nav-portfolio" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-2v2m-4-2v2m4-2h.01M12 18a6 6 0 100-12 6 6 0 000 12z" />
                    </svg>
                    <span class="mt-1">Portfolio</span>
                </button>
            </li>
            <li>
                <button id="nav-transactions" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="mt-1">Transactions</span>
                </button>
            </li>
            <li>
                <button id="nav-markets" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8L11 20" />
                    </svg>
                    <span class="mt-1">Markets</span>
                </button>
            </li>
            <li>
                <button id="nav-profile" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span class="mt-1">Profile</span>
                </button>
            </li>
        </ul>
    </nav>

    <!-- External Libraries (Firebase and Chart.js) -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { Chart, DoughnutController, ArcElement, LineController, CategoryScale, LinearScale, PointElement, LineElement, Tooltip, Legend } from 'https://cdn.jsdelivr.net/npm/chart.js@4.4.3/+esm';

        // Register Chart.js components
        Chart.register(DoughnutController, ArcElement, LineController, CategoryScale, LinearScale, PointElement, LineElement, Tooltip, Legend);
        
        // --- Firebase & App State Initialization ---
        let app, db, auth, userId, unsubscribe;
        // The __app_id and __firebase_config variables are provided by the canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Let's set the log level to debug for now
        setLogLevel('debug');
        
        let transactionsData = [];
        let groupedHoldings = {};
        let allocationChart = null;
        let priceChart = null;
        let currentFilter = 'all';
        let currentTxType = 'Buy';
        let currentInvestment = null; // Store the currently viewed investment for the details modal

        // --- DOM Elements ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const appContainer = document.getElementById('app-container');
        const authModal = document.getElementById('auth-modal');
        const authModalTitle = document.getElementById('auth-modal-title');
        const authForm = document.getElementById('auth-form');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authToggleLink = document.getElementById('auth-toggle-link');
        const logoutBtn = document.getElementById('logout-btn');
        const userIdDisplay = document.getElementById('user-id-display');
        const profileUserIdDisplay = document.getElementById('profile-user-id');
        const navItems = document.querySelectorAll('.nav-item');
        const pages = document.querySelectorAll('.page');
        const addInvestmentBtn = document.getElementById('add-investment-btn');
        const investmentModal = document.getElementById('investment-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const investmentForm = document.getElementById('investment-form');
        const investmentsList = document.getElementById('investments-list');
        const emptyState = document.getElementById('empty-state');
        const totalValueEl = document.getElementById('total-value');
        const overallGainLossEl = document.getElementById('overall-gain-loss');
        const overallGainLossPctEl = document.getElementById('overall-gain-loss-pct');
        const twrValueEl = document.getElementById('twr-value');
        const mwrValueEl = document.getElementById('mwr-value');
        const transactionsList = document.getElementById('transactions-list');
        const emptyTransactionsState = document.getElementById('empty-transactions-state');
        const deleteDataBtn = document.getElementById('delete-data-btn');
        const messageBox = document.getElementById('message-box');
        const messageBoxText = document.getElementById('message-box-text');
        const messageBoxActions = document.getElementById('message-box-actions');
        const allocationChartCtx = document.getElementById('allocation-chart').getContext('2d');
        const chartPlaceholder = document.getElementById('chart-placeholder');
        const getAiInsightsBtn = document.getElementById('get-ai-insights-btn');
        const aiResponseModal = document.getElementById('ai-response-modal');
        const closeAiModalBtn = document.getElementById('close-ai-modal-btn');
        const aiModalTitle = document.getElementById('ai-modal-title');
        const aiResponseContent = document.getElementById('ai-response-content');
        const filterBtns = document.querySelectorAll('.filter-btn');
        
        // Detail Modal Elements
        const detailsModal = document.getElementById('details-modal');
        const closeDetailsModalBtn = document.getElementById('close-details-modal-btn');
        const detailsModalTitle = document.getElementById('details-modal-title');
        const detailsSharesEl = document.getElementById('details-shares');
        const detailsBuyPriceEl = document.getElementById('details-buy-price');
        const detailsTotalCostEl = document.getElementById('details-total-cost');
        const detailsCurrentValueEl = document.getElementById('details-current-value');
        const detailsGainLossEl = document.getElementById('details-gain-loss');
        const priceChartCtx = document.getElementById('price-chart').getContext('2d');
        const detailsTransactionsList = document.getElementById('details-transactions-list');
        const emptyDetailsTransactionsState = document.getElementById('empty-details-transactions-state');
        
        // Transaction Form Elements
        const modalTitle = document.getElementById('modal-title');
        const transactionIdInput = document.getElementById('transaction-id');
        const transactionDateInput = document.getElementById('transaction-date');
        const typeBuyBtn = document.getElementById('type-buy-btn');
        const typeSellBtn = document.getElementById('type-sell-btn');
        const buyPriceGroup = document.getElementById('buy-price-group');
        const sellPriceGroup = document.getElementById('sell-price-group');
        const tickerInput = document.getElementById('ticker');
        const sharesInput = document.getElementById('shares');
        const buyPriceInput = document.getElementById('buy-price');
        const sellPriceInput = document.getElementById('sell-price');
        const marketSelect = document.getElementById('market');
        const assetTypeSelect = document.getElementById('asset-type');
        
        // --- Firebase Functions ---
        const getCollectionRef = () => {
            if (!userId) return null;
            // IMPORTANT: Use the /artifacts/{appId}/users/{userId}/... structure
            const collectionPath = `/artifacts/${appId}/users/${userId}/transactions`;
            return collection(db, collectionPath);
        };
        
        const listenForTransactions = () => {
            if (unsubscribe) {
                unsubscribe();
            }
            const collectionRef = getCollectionRef();
            if (!collectionRef) {
                console.error("Collection reference is null, cannot listen for updates.");
                return;
            }
            unsubscribe = onSnapshot(collectionRef, (querySnapshot) => {
                const transactions = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    transactions.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp.toDate() // Convert Firestore Timestamp to JS Date
                    });
                });
                transactionsData = transactions;
                groupedHoldings = groupHoldingsByTicker(transactionsData);
                renderAllViews();
            }, (error) => {
                console.error("Error fetching transactions:", error);
            });
        };
        
        const addTransaction = async (transaction) => {
            const collectionRef = getCollectionRef();
            if (!collectionRef) {
                console.error("Not authenticated, cannot add transaction.");
                return;
            }
            await addDoc(collectionRef, transaction);
        };

        const updateTransaction = async (id, updatedTransaction) => {
            const collectionRef = getCollectionRef();
            if (!collectionRef) {
                console.error("Not authenticated, cannot update transaction.");
                return;
            }
            const docRef = doc(collectionRef, id);
            await setDoc(docRef, updatedTransaction);
        };

        const deleteTransaction = async (id) => {
            const collectionRef = getCollectionRef();
            if (!collectionRef) {
                console.error("Not authenticated, cannot delete transaction.");
                return;
            }
            const docRef = doc(collectionRef, id);
            await deleteDoc(docRef);
        };
        
        // --- App Logic & UI Functions ---
        const showMessageBox = (message, actions, onConfirm = null) => {
            messageBoxText.textContent = message;
            messageBoxActions.innerHTML = '';
            actions.forEach(action => {
                const btn = document.createElement('button');
                btn.textContent = action.text;
                btn.className = `py-2 px-4 rounded-lg font-medium transition-colors duration-200 ${action.class}`;
                btn.addEventListener('click', () => {
                    messageBox.classList.add('hidden');
                    if (action.callback) {
                        action.callback();
                    }
                });
                messageBoxActions.appendChild(btn);
            });
            messageBox.classList.remove('hidden');
        };

        const showLoading = (show) => {
            loadingSpinner.classList.toggle('hidden', !show);
        };

        const showPage = (pageId) => {
            pages.forEach(page => {
                page.classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');

            navItems.forEach(item => {
                item.classList.remove('active-nav-bg', 'active-nav');
            });
            document.getElementById(`nav-${pageId.split('-')[0]}`).classList.add('active-nav-bg', 'active-nav');
        };

        const showAuthModal = (show, isSignup = false) => {
            authModalTitle.textContent = isSignup ? 'Sign up' : 'Sign in';
            authSubmitBtn.textContent = isSignup ? 'Sign up' : 'Sign in';
            authToggleLink.innerHTML = isSignup
                ? `Already have an account? <span class="font-medium text-indigo-600 hover:text-indigo-800">Sign in</span>`
                : `Don't have an account? <span class="font-medium text-indigo-600 hover:text-indigo-800">Sign up</span>`;
            authModal.classList.toggle('hidden', !show);
        };

        const renderTransactions = () => {
            transactionsList.innerHTML = '';
            if (transactionsData.length === 0) {
                emptyTransactionsState.classList.remove('hidden');
            } else {
                emptyTransactionsState.classList.add('hidden');
                transactionsData.forEach(tx => {
                    const txElement = document.createElement('div');
                    const txColor = tx.type === 'Buy' ? 'bg-blue-50 border-blue-200' : 'bg-red-50 border-red-200';
                    const txTextColor = tx.type === 'Buy' ? 'text-blue-800' : 'text-red-800';
                    txElement.className = `flex items-center justify-between p-4 rounded-xl shadow-sm border ${txColor}`;
                    txElement.innerHTML = `
                        <div class="flex-1">
                            <div class="font-semibold text-lg ${txTextColor}">${tx.type} ${tx.shares} shares of ${tx.ticker}</div>
                            <div class="text-sm text-gray-500">${tx.timestamp.toLocaleDateString()} at ${tx.price.toFixed(2)} ${tx.market === 'US' ? 'USD' : 'MYR'}</div>
                        </div>
                        <button class="delete-tx-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm hover:bg-gray-300 transition-colors duration-200" data-id="${tx.id}">Delete</button>
                    `;
                    transactionsList.appendChild(txElement);
                });
            }
        };

        const renderPortfolio = () => {
            investmentsList.innerHTML = '';
            const filteredHoldings = Object.values(groupedHoldings).filter(holding => {
                if (currentFilter === 'all') return true;
                return holding.market === currentFilter || holding.assetType === currentFilter;
            });
            if (filteredHoldings.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                filteredHoldings.forEach(holding => {
                    const totalCost = holding.averagePrice * holding.shares;
                    const currentValue = holding.currentPrice * holding.shares;
                    const gainLoss = currentValue - totalCost;
                    const gainLossClass = gainLoss >= 0 ? 'text-green-600' : 'text-red-600';
                    const investmentElement = document.createElement('div');
                    investmentElement.className = "investment-card bg-white p-4 rounded-xl shadow border border-gray-100 cursor-pointer transition-transform duration-200 hover:scale-[1.01]";
                    investmentElement.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-bold text-lg">${holding.ticker} <span class="text-xs font-normal text-gray-500">${holding.assetType} - ${holding.market}</span></h3>
                            <span class="font-bold text-xl">${currentValue.toFixed(2)} ${holding.market === 'US' ? 'USD' : 'MYR'}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm text-gray-600">
                            <span>Avg. Price: ${holding.averagePrice.toFixed(2)}</span>
                            <span>Shares: ${holding.shares.toFixed(2)}</span>
                            <span class="${gainLossClass}">Gain/Loss: ${gainLoss.toFixed(2)}</span>
                        </div>
                    `;
                    investmentElement.addEventListener('click', () => showInvestmentDetails(holding));
                    investmentsList.appendChild(investmentElement);
                });
            }
        };

        const renderDashboard = () => {
            const totalValue = Object.values(groupedHoldings).reduce((sum, holding) => sum + holding.currentPrice * holding.shares, 0);
            const totalCost = Object.values(groupedHoldings).reduce((sum, holding) => sum + holding.averagePrice * holding.shares, 0);
            const overallGainLoss = totalValue - totalCost;
            const overallGainLossPct = totalCost > 0 ? (overallGainLoss / totalCost) * 100 : 0;

            totalValueEl.textContent = `$${totalValue.toFixed(2)}`;
            overallGainLossEl.textContent = `$${overallGainLoss.toFixed(2)}`;
            overallGainLossEl.className = overallGainLoss >= 0 ? 'text-4xl font-bold text-green-600' : 'text-4xl font-bold text-red-600';
            overallGainLossPctEl.textContent = ` (${overallGainLossPct.toFixed(2)}%)`;
            overallGainLossPctEl.className = overallGainLoss >= 0 ? 'text-green-500 text-sm font-medium' : 'text-red-500 text-sm font-medium';
            twrValueEl.textContent = calculateTWR().toFixed(2) + '%';
            mwrValueEl.textContent = calculateMWR().toFixed(2) + '%';

            renderAllocationChart();
        };

        const renderAllViews = () => {
            renderDashboard();
            renderPortfolio();
            renderTransactions();
        };
        
        const showInvestmentDetails = (holding) => {
            currentInvestment = holding;
            detailsModalTitle.textContent = `${holding.ticker} Details`;
            detailsSharesEl.textContent = holding.shares.toFixed(2);
            detailsBuyPriceEl.textContent = `${holding.averagePrice.toFixed(2)} ${holding.market === 'US' ? 'USD' : 'MYR'}`;
            const totalCost = holding.averagePrice * holding.shares;
            const currentValue = holding.currentPrice * holding.shares;
            const gainLoss = currentValue - totalCost;
            detailsTotalCostEl.textContent = `${totalCost.toFixed(2)} ${holding.market === 'US' ? 'USD' : 'MYR'}`;
            detailsCurrentValueEl.textContent = `${currentValue.toFixed(2)} ${holding.market === 'US' ? 'USD' : 'MYR'}`;
            detailsGainLossEl.textContent = `${gainLoss.toFixed(2)} ${holding.market === 'US' ? 'USD' : 'MYR'} (${(gainLoss / totalCost * 100).toFixed(2)}%)`;
            detailsGainLossEl.className = `text-lg font-bold ${gainLoss >= 0 ? 'text-green-600' : 'text-red-600'}`;
            
            // Render specific transactions for this ticker
            const tickerTransactions = transactionsData.filter(tx => tx.ticker === holding.ticker).sort((a,b) => b.timestamp - a.timestamp);
            detailsTransactionsList.innerHTML = '';
            if (tickerTransactions.length > 0) {
                emptyDetailsTransactionsState.classList.add('hidden');
                tickerTransactions.forEach(tx => {
                    const txElement = document.createElement('div');
                    const txColor = tx.type === 'Buy' ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800';
                    txElement.className = `flex justify-between items-center p-3 rounded-lg ${txColor}`;
                    txElement.innerHTML = `
                        <div class="font-semibold">${tx.type} ${tx.shares.toFixed(2)} shares at ${tx.price.toFixed(2)}</div>
                        <div class="text-sm text-gray-600">${tx.timestamp.toLocaleDateString()}</div>
                    `;
                    detailsTransactionsList.appendChild(txElement);
                });
            } else {
                emptyDetailsTransactionsState.classList.remove('hidden');
            }

            renderPriceChart();
            detailsModal.classList.remove('hidden');
        };

        const renderAllocationChart = () => {
            const tickers = Object.keys(groupedHoldings);
            if (tickers.length > 0) {
                const values = tickers.map(ticker => groupedHoldings[ticker].currentPrice * groupedHoldings[ticker].shares);
                const backgroundColors = [
                    '#4f46e5', '#34d399', '#f97316', '#a855f7', '#06b6d4',
                    '#f43f5e', '#22c55e', '#fbbf24', '#8b5cf6', '#ef4444'
                ];
                chartPlaceholder.classList.add('hidden');
                document.getElementById('allocation-chart').classList.remove('hidden');

                if (allocationChart) {
                    allocationChart.data.labels = tickers;
                    allocationChart.data.datasets[0].data = values;
                    allocationChart.update();
                } else {
                    allocationChart = new Chart(allocationChartCtx, {
                        type: 'doughnut',
                        data: {
                            labels: tickers,
                            datasets: [{
                                data: values,
                                backgroundColor: backgroundColors,
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = (value / total * 100).toFixed(2) + '%';
                                            return `${label}: $${value.toFixed(2)} (${percentage})`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } else {
                if (allocationChart) {
                    allocationChart.destroy();
                    allocationChart = null;
                }
                chartPlaceholder.classList.remove('hidden');
                document.getElementById('allocation-chart').classList.add('hidden');
            }
        };

        const renderPriceChart = () => {
            if (priceChart) {
                priceChart.destroy();
            }
            // Generate simulated price data based on the earliest transaction date
            const tickerTransactions = transactionsData.filter(tx => tx.ticker === currentInvestment.ticker).sort((a,b) => a.timestamp - b.timestamp);
            if (tickerTransactions.length === 0) return;

            const earliestDate = tickerTransactions[0].timestamp;
            const today = new Date();
            const dates = [];
            const prices = [];

            let currentDate = new Date(earliestDate);
            let currentPrice = tickerTransactions[0].price;

            while(currentDate <= today) {
                dates.push(currentDate.toLocaleDateString());
                
                // Find a transaction on this date
                const tx = tickerTransactions.find(t => t.timestamp.toLocaleDateString() === currentDate.toLocaleDateString());
                if(tx) {
                    currentPrice = tx.price;
                }
                
                // Simulate price movement
                prices.push(currentPrice * (1 + (Math.random() - 0.5) * 0.05));
                
                currentDate.setDate(currentDate.getDate() + 10); // Add 10 days for a more spread out chart
            }

            priceChart = new Chart(priceChartCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Simulated Price',
                        data: prices,
                        borderColor: '#4f46e5',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false,
                        }
                    },
                    scales: {
                        x: {
                            display: false // Hide x-axis labels to avoid clutter
                        },
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        };

        // --- Calculation Functions ---
        const groupHoldingsByTicker = (transactions) => {
            const holdings = {};
            transactions.forEach(tx => {
                const ticker = tx.ticker;
                if (!holdings[ticker]) {
                    holdings[ticker] = {
                        ticker: ticker,
                        market: tx.market,
                        assetType: tx.assetType,
                        shares: 0,
                        totalCost: 0,
                        currentPrice: parseFloat((Math.random() * 100 + 10).toFixed(2)) // Simulated current price
                    };
                }
                if (tx.type === 'Buy') {
                    holdings[ticker].shares += tx.shares;
                    holdings[ticker].totalCost += tx.shares * tx.price;
                } else if (tx.type === 'Sell') {
                    holdings[ticker].shares -= tx.shares;
                    holdings[ticker].totalCost -= tx.shares * tx.price; // Simplified, not a perfect avg calculation
                }
            });
            // Filter out holdings with zero or negative shares
            Object.keys(holdings).forEach(key => {
                if (holdings[key].shares <= 0) {
                    delete holdings[key];
                } else {
                    holdings[key].averagePrice = holdings[key].totalCost / holdings[key].shares;
                }
            });
            return holdings;
        };

        const calculateTWR = () => {
            // Placeholder for a complex TWR calculation
            const txDates = transactionsData.map(tx => tx.timestamp.getTime());
            const uniqueSortedDates = [...new Set(txDates)].sort((a,b) => a-b);
            
            let totalReturn = 1;
            let startValue = 0;
            let endValue = 0;

            if (transactionsData.length > 0) {
                // Simplified calculation based on first transaction and current value
                const firstTx = transactionsData.sort((a,b) => a.timestamp - b.timestamp)[0];
                startValue = firstTx.shares * firstTx.price;
                endValue = Object.values(groupedHoldings).reduce((sum, holding) => sum + holding.currentPrice * holding.shares, 0);
            }

            if (startValue > 0) {
                totalReturn = (endValue - startValue) / startValue;
            }

            return totalReturn * 100;
        };

        const calculateMWR = () => {
            // Placeholder for a complex MWR (IRR) calculation
            const totalCost = Object.values(groupedHoldings).reduce((sum, holding) => sum + holding.averagePrice * holding.shares, 0);
            const totalValue = Object.values(groupedHoldings).reduce((sum, holding) => sum + holding.currentPrice * holding.shares, 0);
            return (totalValue - totalCost) / totalCost * 100;
        };
        
        // --- Event Listeners ---
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(true);
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            try {
                if (authModalTitle.textContent === 'Sign up') {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
                showAuthModal(false);
                appContainer.classList.remove('hidden');
            } catch (error) {
                showMessageBox(`Authentication failed: ${error.message}`, [{ text: 'OK', class: 'bg-indigo-600 text-white' }]);
            } finally {
                showLoading(false);
            }
        });

        authToggleLink.addEventListener('click', () => {
            const isSignup = authModalTitle.textContent === 'Sign in';
            showAuthModal(true, isSignup);
        });

        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
            showMessageBox('You have been logged out.', [{ text: 'OK', class: 'bg-indigo-600 text-white' }]);
            appContainer.classList.add('hidden');
            showAuthModal(true);
        });

        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                const pageId = item.id.replace('nav-', '') + '-page';
                showPage(pageId);
            });
        });

        addInvestmentBtn.addEventListener('click', () => {
            modalTitle.textContent = 'Add New Transaction';
            investmentForm.reset();
            transactionIdInput.value = '';
            showInvestmentModal(true);
        });
        
        const showInvestmentModal = (show) => {
            investmentModal.classList.toggle('hidden', !show);
        };
        
        closeModalBtn.addEventListener('click', () => showInvestmentModal(false));
        
        typeBuyBtn.addEventListener('click', () => {
            currentTxType = 'Buy';
            typeBuyBtn.classList.replace('bg-gray-200', 'bg-indigo-600');
            typeBuyBtn.classList.replace('text-gray-700', 'text-white');
            typeSellBtn.classList.replace('bg-indigo-600', 'bg-gray-200');
            typeSellBtn.classList.replace('text-white', 'text-gray-700');
            buyPriceGroup.classList.remove('hidden');
            sellPriceGroup.classList.add('hidden');
        });
        
        typeSellBtn.addEventListener('click', () => {
            currentTxType = 'Sell';
            typeSellBtn.classList.replace('bg-gray-200', 'bg-indigo-600');
            typeSellBtn.classList.replace('text-gray-700', 'text-white');
            typeBuyBtn.classList.replace('bg-indigo-600', 'bg-gray-200');
            typeBuyBtn.classList.replace('text-white', 'text-gray-700');
            buyPriceGroup.classList.add('hidden');
            sellPriceGroup.classList.remove('hidden');
        });

        investmentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const transactionId = transactionIdInput.value;
            const price = parseFloat(currentTxType === 'Buy' ? buyPriceInput.value : sellPriceInput.value);
            const transaction = {
                ticker: tickerInput.value.toUpperCase(),
                shares: parseFloat(sharesInput.value),
                price: price,
                timestamp: new Date(transactionDateInput.value),
                type: currentTxType,
                market: marketSelect.value,
                assetType: assetTypeSelect.value,
            };
            try {
                if (transactionId) {
                    await updateTransaction(transactionId, transaction);
                } else {
                    await addTransaction(transaction);
                }
                showInvestmentModal(false);
            } catch (error) {
                console.error("Error saving transaction: ", error);
                showMessageBox("Failed to save transaction.", [{ text: 'OK', class: 'bg-indigo-600 text-white' }]);
            }
        });
        
        investmentsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('investment-card')) {
                const ticker = e.target.querySelector('h3').textContent.trim();
                const holding = groupedHoldings[ticker];
                if (holding) {
                    showInvestmentDetails(holding);
                }
            }
        });

        transactionsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-tx-btn')) {
                const id = e.target.dataset.id;
                showMessageBox('Are you sure you want to delete this transaction?', [
                    { text: 'Cancel', class: 'bg-gray-200 text-gray-700 hover:bg-gray-300' },
                    { text: 'Delete', class: 'bg-red-600 text-white hover:bg-red-700', callback: () => deleteTransaction(id) }
                ]);
            }
        });
        
        closeDetailsModalBtn.addEventListener('click', () => {
            detailsModal.classList.add('hidden');
        });
        
        deleteDataBtn.addEventListener('click', () => {
            showMessageBox('This will permanently delete ALL of your portfolio data. Are you sure?', [
                { text: 'No, cancel', class: 'bg-gray-200 text-gray-700 hover:bg-gray-300' },
                { text: 'Yes, delete', class: 'bg-red-600 text-white hover:bg-red-700', callback: async () => {
                    const collectionRef = getCollectionRef();
                    if (!collectionRef) return;
                    const q = collection(db, collectionRef.path);
                    const querySnapshot = await getDocs(q);
                    const batch = writeBatch(db);
                    querySnapshot.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    showMessageBox('All data deleted.', [{ text: 'OK', class: 'bg-indigo-600 text-white' }]);
                }}
            ]);
        });
        
        getAiInsightsBtn.addEventListener('click', async () => {
            if (transactionsData.length === 0) {
                showMessageBox("You need to add at least one transaction to get AI insights.", [{ text: 'OK', class: 'bg-indigo-600 text-white' }]);
                return;
            }
            
            aiResponseModal.classList.remove('hidden');
            aiResponseContent.innerHTML = `<div class="flex items-center justify-center"><div class="animate-spin rounded-full h-8 w-8 border-2 border-t-2 border-blue-500 border-opacity-75"></div></div>`;
            
            const portfolioSummary = JSON.stringify(Object.values(groupedHoldings).map(h => ({
                ticker: h.ticker,
                shares: h.shares,
                averagePrice: h.averagePrice,
                currentPrice: h.currentPrice,
                market: h.market
            })));
            
            const systemPrompt = "Act as a financial analyst. Provide a concise, single-paragraph summary of the user's portfolio performance, highlighting key metrics like total value, overall gain/loss, and a brief insight based on the data. Avoid technical jargon and use simple language. Do not invent any numbers. Stick strictly to the provided data. Your tone should be helpful and informative.";
            const userQuery = `Based on this portfolio data, provide a summary: ${portfolioSummary}`;

            try {
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };
                
                const apiKey = ""
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    aiResponseContent.innerHTML = `<p>${text}</p>`;
                } else {
                    aiResponseContent.innerHTML = `<p class="text-red-500">Error generating insights. Please try again.</p>`;
                }
            } catch (error) {
                console.error("AI API call failed:", error);
                aiResponseContent.innerHTML = `<p class="text-red-500">Could not connect to the insights service. Please try again later.</p>`;
            }
        });
        
        closeAiModalBtn.addEventListener('click', () => {
            aiResponseModal.classList.add('hidden');
        });
        
        filterBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const newFilter = e.target.dataset.filter;
                currentFilter = newFilter;
                filterBtns.forEach(b => {
                    b.classList.remove('bg-indigo-200', 'text-indigo-800', 'font-semibold');
                    b.classList.add('bg-gray-200', 'text-gray-700');
                });
                e.target.classList.remove('bg-gray-200', 'text-gray-700');
                e.target.classList.add('bg-indigo-200', 'text-indigo-800', 'font-semibold');
                renderPortfolio();
            });
        });
        
        // Corrected Initialization Function
        const init = () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase configuration is missing. The app cannot run.");
                }
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                onAuthStateChanged(auth, async (user) => {
                    showLoading(false);
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User: ${userId.slice(0, 8)}...`;
                        profileUserIdDisplay.textContent = userId;
                        appContainer.classList.remove('hidden');
                        showAuthModal(false);
                        listenForTransactions(); // Start listening for data changes
                    } else {
                        userId = null;
                        userIdDisplay.textContent = `Not signed in`;
                        profileUserIdDisplay.textContent = 'Not authenticated';
                        appContainer.classList.add('hidden');
                        showAuthModal(true);
                        
                        // Attempt to sign in with the custom token or anonymously
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } catch (error) {
                                console.error("Custom token sign-in failed:", error);
                                showMessageBox(`Authentication failed. Please sign in.`, [{ text: 'OK', class: 'bg-indigo-600 text-white' }]);
                            }
                        } else {
                            try {
                                await signInAnonymously(auth);
                            } catch (error) {
                                console.error("Anonymous sign-in failed:", error);
                                showMessageBox(`Anonymous sign-in failed. Please try again.`, [{ text: 'OK', class: 'bg-indigo-600 text-white' }]);
                            }
                        }
                    }
                });
            } catch (error) {
                showLoading(false);
                console.error("Firebase Initialization Error:", error);
                showMessageBox(`Startup Error: ${error.message}`, [{ text: 'OK', class: 'bg-red-600 text-white' }]);
            }
        };

        // Start the application
        window.onload = init;
    </script>
</body>
</html>
