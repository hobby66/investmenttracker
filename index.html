<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 900px;
            margin: auto;
        }
        .active-nav {
            color: #4f46e5;
        }
        .active-nav-bg {
            background-color: #eef2ff;
        }
        .delete-btn {
            background-color: #fca5a5;
            color: #991b1b;
        }
        .delete-btn:hover {
            background-color: #f87171;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="fixed inset-0 bg-gray-200 bg-opacity-75 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-blue-500 border-opacity-75"></div>
    </div>
    
    <!-- Login/Signup Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h3 id="auth-modal-title" class="text-2xl font-bold text-center mb-6 text-gray-800">Sign in</h3>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="auth-email" class="block text-sm font-medium text-gray-700">Email address</label>
                    <input type="email" id="auth-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="auth-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="auth-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <button type="submit" id="auth-submit-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors duration-200">Sign in</button>
            </form>
            <p id="auth-toggle-link" class="text-center text-sm mt-4 text-gray-600 cursor-pointer">
                Don't have an account? <span class="font-medium text-indigo-600 hover:text-indigo-800">Sign up</span>
            </p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="container bg-white rounded-xl shadow-lg m-4 p-6 flex-grow relative hidden">

        <!-- Header and User Info -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">My Portfolio</h1>
            <div class="flex items-center space-x-2">
                <div class="flex items-center space-x-2 bg-gray-50 text-gray-600 px-3 py-1 rounded-full text-sm">
                    <span id="user-id-display" class="truncate">Authenticating...</span>
                </div>
                <button id="logout-btn" class="text-sm text-red-500 hover:text-red-700 transition-colors duration-200 font-medium">Log out</button>
            </div>
        </header>

        <!-- Main Content Area -->
        <div id="content-area" class="pb-24">
            <!-- Dashboard View -->
            <div id="dashboard-page" class="page">
                <section class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-indigo-50 p-6 rounded-xl shadow-inner border border-indigo-200">
                        <h2 class="text-lg text-indigo-800 font-semibold mb-2">Total Portfolio Value</h2>
                        <p id="total-value" class="text-4xl font-bold text-indigo-600">$0.00</p>
                    </div>
                    <div class="bg-green-50 p-6 rounded-xl shadow-inner border border-green-200">
                        <h2 class="text-lg text-green-800 font-semibold mb-2">Overall Gain/Loss</h2>
                        <p id="overall-gain-loss" class="text-4xl font-bold text-green-600">$0.00</p>
                        <span id="overall-gain-loss-pct" class="text-green-500 text-sm font-medium"> (0.00%)</span>
                    </div>
                </section>
                
                <section class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-blue-50 p-6 rounded-xl shadow-inner border border-blue-200">
                        <h2 class="text-lg text-blue-800 font-semibold mb-2">Time-Weighted Return (TWR)</h2>
                        <p id="twr-value" class="text-4xl font-bold text-blue-600">0.00%</p>
                        <p class="text-xs text-gray-500 mt-2">A measure of compound growth, unaffected by deposits/withdrawals.</p>
                    </div>
                    <div class="bg-blue-50 p-6 rounded-xl shadow-inner border border-blue-200">
                        <h2 class="text-lg text-blue-800 font-semibold mb-2">Money-Weighted Return (MWR)</h2>
                        <p id="mwr-value" class="text-4xl font-bold text-blue-600">0.00%</p>
                        <p class="text-xs text-gray-500 mt-2">The return rate that accounts for timing of cash flows.</p>
                    </div>
                </section>

                <section class="bg-white p-6 rounded-xl shadow border border-gray-100 mb-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Asset Allocation</h2>
                    <div class="w-full h-64 flex items-center justify-center">
                        <p id="chart-placeholder" class="text-gray-400">Add a transaction to see your asset allocation here.</p>
                        <canvas id="allocation-chart" class="w-full h-full hidden"></canvas>
                    </div>
                </section>

                <section class="flex justify-center">
                    <button id="get-ai-insights-btn" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-medium shadow-md hover:bg-purple-700 transition-colors duration-200">
                        Get AI Portfolio Summary âœ¨
                    </button>
                </section>
            </div>

            <!-- Portfolio View -->
            <div id="portfolio-page" class="page hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">My Investments</h2>
                    <button id="add-investment-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium shadow hover:bg-blue-700 transition-colors duration-200">
                        + Add New
                    </button>
                </div>
                <div class="flex items-center space-x-2 mb-4">
                    <span class="text-sm font-medium text-gray-700">Filter By:</span>
                    <button data-filter="all" class="filter-btn text-sm px-3 py-1 rounded-full bg-indigo-200 text-indigo-800 font-semibold">All</button>
                    <button data-filter="US" class="filter-btn text-sm px-3 py-1 rounded-full bg-gray-200 text-gray-700">US</button>
                    <button data-filter="Malaysia" class="filter-btn text-sm px-3 py-1 rounded-full bg-gray-200 text-gray-700">Malaysia</button>
                    <button data-filter="Stock" class="filter-btn text-sm px-3 py-1 rounded-full bg-gray-200 text-gray-700">Stocks</button>
                    <button data-filter="ETF" class="filter-btn text-sm px-3 py-1 rounded-full bg-gray-200 text-gray-700">ETFs</button>
                </div>
                <div id="investments-list" class="space-y-4">
                    <!-- Investment items will be rendered here -->
                </div>
                <div id="empty-state" class="text-center text-gray-400 mt-8 hidden">
                    <p class="mb-2">You don't have any investments yet.</p>
                    <p>Click "Add New" to get started!</p>
                </div>
            </div>

            <!-- Transactions View -->
            <div id="transactions-page" class="page hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Transaction History</h2>
                <div id="transactions-list" class="space-y-4">
                    <!-- Transaction items will be rendered here -->
                </div>
                <div id="empty-transactions-state" class="text-center text-gray-400 mt-8 hidden">
                    <p class="mb-2">No transactions recorded.</p>
                </div>
            </div>

            <!-- Markets View -->
            <div id="markets-page" class="page hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Global Markets</h2>
                <div class="bg-gray-50 p-6 rounded-xl shadow-inner text-center text-gray-400">
                    <p>This section would display live market data, news, and indices.</p>
                    <p>This is a placeholder as real-time market data requires a separate API integration.</p>
                </div>
            </div>

            <!-- Profile/Settings View -->
            <div id="profile-page" class="page hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Profile & Settings</h2>
                <div class="bg-gray-50 p-6 rounded-xl shadow-inner">
                    <p class="font-medium text-gray-700 mb-2">Your User ID:</p>
                    <p id="profile-user-id" class="text-sm font-mono break-all text-gray-500">Not available in demo mode</p>
                </div>
                <div class="mt-6 bg-red-50 p-6 rounded-xl shadow-inner border border-red-200">
                    <h3 class="text-lg font-semibold text-red-800 mb-2">Danger Zone</h3>
                    <p class="text-sm text-red-700 mb-4">
                        This action will permanently delete all of your data from the app.
                    </p>
                    <button id="delete-data-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium shadow hover:bg-red-700 transition-colors duration-200">
                        Delete My Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Adding/Editing an Investment -->
    <div id="investment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800">Add New Transaction</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">&times;</button>
            </div>
            <form id="investment-form" class="space-y-4">
                <div>
                    <label for="transaction-date" class="block text-sm font-medium text-gray-700">Date</label>
                    <input type="date" id="transaction-date" name="transaction-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Transaction Type</label>
                    <div class="mt-1 flex space-x-2">
                        <button type="button" id="type-buy-btn" class="flex-1 py-2 rounded-lg font-medium shadow-sm transition-colors duration-200 bg-indigo-600 text-white">Buy</button>
                        <button type="button" id="type-sell-btn" class="flex-1 py-2 rounded-lg font-medium shadow-sm transition-colors duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300">Sell</button>
                    </div>
                </div>
                <div>
                    <label for="market" class="block text-sm font-medium text-gray-700">Market</label>
                    <select id="market" name="market" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="US">US</option>
                        <option value="Malaysia">Malaysia</option>
                    </select>
                </div>
                <div>
                    <label for="asset-type" class="block text-sm font-medium text-gray-700">Asset Type</label>
                    <select id="asset-type" name="asset-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="Stock">Stock</option>
                        <option value="ETF">ETF</option>
                    </select>
                </div>
                <div>
                    <label for="ticker" class="block text-sm font-medium text-gray-700">Ticker Symbol</label>
                    <input type="text" id="ticker" name="ticker" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="shares" class="block text-sm font-medium text-gray-700">Number of Shares</label>
                    <input type="number" id="shares" name="shares" required min="0.01" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div id="buy-price-group" class="price-group">
                    <label for="buy-price" class="block text-sm font-medium text-gray-700">Buy Price (USD/MYR)</label>
                    <input type="number" id="buy-price" name="buy-price" required min="0.01" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div id="sell-price-group" class="price-group hidden">
                    <label for="sell-price" class="block text-sm font-medium text-gray-700">Sell Price (USD/MYR)</label>
                    <input type="number" id="sell-price" name="sell-price" required min="0.01" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <input type="hidden" id="transaction-id">
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors duration-200 mt-4">Save Transaction</button>
            </form>
        </div>
    </div>

    <!-- Modal for Detailed Investment View -->
    <div id="details-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 id="details-modal-title" class="text-xl font-bold text-gray-800"></h3>
                <button id="close-details-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">&times;</button>
            </div>
            <div class="space-y-4">
                <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                    <h4 class="font-semibold text-gray-700 mb-2">Price History (Simulated)</h4>
                    <div class="w-full h-48">
                        <canvas id="price-chart"></canvas>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-500">Quantity Owned</p>
                        <p id="details-shares" class="text-lg font-bold text-gray-800"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-500">Average Buy Price</p>
                        <p id="details-buy-price" class="text-lg font-bold text-gray-800"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-500">Total Cost</p>
                        <p id="details-total-cost" class="text-lg font-bold text-gray-800"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-500">Current Market Value</p>
                        <p id="details-current-value" class="text-lg font-bold text-gray-800"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm col-span-2">
                        <p class="text-sm text-gray-500">Unrealized Gain/Loss</p>
                        <p id="details-gain-loss" class="text-lg font-bold text-gray-800"></p>
                    </div>
                </div>
                <!-- New section for Transaction Log -->
                <div class="mt-6">
                    <h4 class="font-semibold text-xl text-gray-700 mb-2">Transaction History</h4>
                    <div id="details-transactions-list" class="space-y-4">
                        <!-- Transactions for this specific ticker will be rendered here -->
                    </div>
                    <div id="empty-details-transactions-state" class="text-center text-gray-400 mt-4 hidden">
                        <p>No transactions for this holding.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Message Box Modal -->
    <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
            <p id="message-box-text" class="text-gray-800 text-lg mb-4"></p>
            <div id="message-box-actions" class="flex justify-center space-x-4">
                <button id="message-box-ok-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors duration-200">OK</button>
            </div>
        </div>
    </div>

    <!-- AI Response Modal -->
    <div id="ai-response-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 id="ai-modal-title" class="text-xl font-bold text-gray-800">AI Insights</h3>
                <button id="close-ai-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">&times;</button>
            </div>
            <div id="ai-response-content" class="text-gray-700 prose max-w-none">
                <div class="flex items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-2 border-t-2 border-blue-500 border-opacity-75"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-2xl border-t border-gray-200 z-30">
        <ul class="flex justify-around items-center h-16 text-gray-500 text-sm">
            <li>
                <button id="nav-dashboard" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200 active-nav-bg active-nav">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <span class="mt-1">Dashboard</span>
                </button>
            </li>
            <li>
                <button id="nav-portfolio" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-2v2m-4-2v2m4-2h.01M12 18a6 6 0 100-12 6 6 0 000 12z" />
                    </svg>
                    <span class="mt-1">Portfolio</span>
                </button>
            </li>
            <li>
                <button id="nav-transactions" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="mt-1">Transactions</span>
                </button>
            </li>
            <li>
                <button id="nav-markets" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8L11 20" />
                    </svg>
                    <span class="mt-1">Markets</span>
                </button>
            </li>
            <li>
                <button id="nav-profile" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span class="mt-1">Profile</span>
                </button>
            </li>
        </ul>
    </nav>

    <!-- External Libraries (Firebase and Chart.js) -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { Chart, DoughnutController, ArcElement, LineController, CategoryScale, LinearScale, PointElement, LineElement, Tooltip, Legend } from 'https://cdn.jsdelivr.net/npm/chart.js@4.4.3/+esm';

        // Register Chart.js components
        Chart.register(DoughnutController, ArcElement, LineController, CategoryScale, LinearScale, PointElement, LineElement, Tooltip, Legend);
        
        // --- Firebase & App State Initialization ---
        let app, db, auth, userId, unsubscribe;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Firebase & App State Initialization
		let app, db, auth, userId, unsubscribe;
		const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Replace this with a unique ID for your app
		const firebaseConfig = {
		  apiKey: "AIzaSyBUkADc0TTBrM0STMhTLzA6htyYgiOdsro",
		  authDomain: "investmenttracker-af126.firebaseapp.com",
		  projectId: "yinvestmenttracker-af126",
		  storageBucket: "investmenttracker-af126.firebasestorage.app",
		  messagingSenderId: "782078886994",
		  appId: "1:782078886994:web:8d02aed4ddd2f62b198b8b",
		  measurementId: "G-NVNMZPPC3H"
		};

        let transactionsData = [];
        let groupedHoldings = {};
        let allocationChart = null;
        let priceChart = null;
        let currentFilter = 'all';
        let currentTxType = 'Buy';

        // --- DOM Elements ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const appContainer = document.getElementById('app-container');
        const authModal = document.getElementById('auth-modal');
        const authModalTitle = document.getElementById('auth-modal-title');
        const authForm = document.getElementById('auth-form');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authToggleLink = document.getElementById('auth-toggle-link');
        const logoutBtn = document.getElementById('logout-btn');
        const userIdDisplay = document.getElementById('user-id-display');
        const profileUserIdDisplay = document.getElementById('profile-user-id');
        const navItems = document.querySelectorAll('.nav-item');
        const pages = document.querySelectorAll('.page');
        const addInvestmentBtn = document.getElementById('add-investment-btn');
        const investmentModal = document.getElementById('investment-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const investmentForm = document.getElementById('investment-form');
        const investmentsList = document.getElementById('investments-list');
        const emptyState = document.getElementById('empty-state');
        const totalValueEl = document.getElementById('total-value');
        const overallGainLossEl = document.getElementById('overall-gain-loss');
        const overallGainLossPctEl = document.getElementById('overall-gain-loss-pct');
        const twrValueEl = document.getElementById('twr-value');
        const mwrValueEl = document.getElementById('mwr-value');
        const transactionsList = document.getElementById('transactions-list');
        const emptyTransactionsState = document.getElementById('empty-transactions-state');
        const deleteDataBtn = document.getElementById('delete-data-btn');
        const messageBox = document.getElementById('message-box');
        const messageBoxText = document.getElementById('message-box-text');
        const messageBoxActions = document.getElementById('message-box-actions');
        const allocationChartCtx = document.getElementById('allocation-chart').getContext('2d');
        const chartPlaceholder = document.getElementById('chart-placeholder');
        const getAiInsightsBtn = document.getElementById('get-ai-insights-btn');
        const aiResponseModal = document.getElementById('ai-response-modal');
        const closeAiModalBtn = document.getElementById('close-ai-modal-btn');
        const aiModalTitle = document.getElementById('ai-modal-title');
        const aiResponseContent = document.getElementById('ai-response-content');
        const filterBtns = document.querySelectorAll('.filter-btn');
        
        // Detail Modal Elements
        const detailsModal = document.getElementById('details-modal');
        const closeDetailsModalBtn = document.getElementById('close-details-modal-btn');
        const detailsModalTitle = document.getElementById('details-modal-title');
        const detailsSharesEl = document.getElementById('details-shares');
        const detailsBuyPriceEl = document.getElementById('details-buy-price');
        const detailsTotalCostEl = document.getElementById('details-total-cost');
        const detailsCurrentValueEl = document.getElementById('details-current-value');
        const detailsGainLossEl = document.getElementById('details-gain-loss');
        const priceChartCtx = document.getElementById('price-chart').getContext('2d');
        const detailsTransactionsList = document.getElementById('details-transactions-list');
        const emptyDetailsTransactionsState = document.getElementById('empty-details-transactions-state');
        
        // Transaction Form Elements
        const modalTitle = document.getElementById('modal-title');
        const transactionIdInput = document.getElementById('transaction-id');
        const transactionDateInput = document.getElementById('transaction-date');
        const typeBuyBtn = document.getElementById('type-buy-btn');
        const typeSellBtn = document.getElementById('type-sell-btn');
        const buyPriceGroup = document.getElementById('buy-price-group');
        const sellPriceGroup = document.getElementById('sell-price-group');
        const tickerInput = document.getElementById('ticker');
        const sharesInput = document.getElementById('shares');
        const buyPriceInput = document.getElementById('buy-price');
        const sellPriceInput = document.getElementById('sell-price');
        const marketSelect = document.getElementById('market');
        const assetTypeSelect = document.getElementById('asset-type');
        
        // --- Firebase Functions ---
        const getCollectionRef = () => {
            if (!userId) return null;
            const collectionPath = `/artifacts/${appId}/users/${userId}/transactions`;
            return collection(db, collectionPath);
        };

        const listenForTransactions = () => {
            if (unsubscribe) {
                unsubscribe();
            }
            const collectionRef = getCollectionRef();
            if (!collectionRef) {
                console.error("Collection reference is null, cannot listen for updates.");
                return;
            }
            unsubscribe = onSnapshot(collectionRef, (querySnapshot) => {
                const transactions = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    transactions.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp.toDate() // Convert Firestore Timestamp to JS Date
                    });
                });
                transactionsData = transactions;
                groupedHoldings = groupHoldingsByTicker(transactionsData);
                renderAllViews();
            });
        };
        
        const addTransaction = async (transaction) => {
            const collectionRef = getCollectionRef();
            if (!collectionRef) {
                console.error("Not authenticated, cannot add transaction.");
                return;
            }
            await addDoc(collectionRef, transaction);
        };

        const updateTransaction = async (id, updatedTransaction) => {
            const collectionRef = getCollectionRef();
            if (!collectionRef) {
                console.error("Not authenticated, cannot update transaction.");
                return;
            }
            const docRef = doc(collectionRef, id);
            await setDoc(docRef, updatedTransaction);
        };

        const deleteTransaction = async (id) => {
            const collectionRef = getCollectionRef();
            if (!collectionRef) {
                console.error("Not authenticated, cannot delete transaction.");
                return;
            }
            const docRef = doc(collectionRef, id);
            await deleteDoc(docRef);
        };

        const deleteAllData = async () => {
            const collectionRef = getCollectionRef();
            if (!collectionRef) return;
            const q = query(collectionRef);
            const querySnapshot = await getDocs(q);
            const batch = writeBatch(db);
            querySnapshot.forEach((doc) => {
                batch.delete(doc.ref);
            });
            await batch.commit();
        };

        // --- App Initialization and Authentication ---
        window.onload = function() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                return;
            }
            
            // Handle authentication state
            onAuthStateChanged(auth, (user) => {
                loadingSpinner.classList.add('hidden');
                if (user) {
                    userId = user.uid;
                    appContainer.classList.remove('hidden');
                    authModal.classList.add('hidden');
                    userIdDisplay.textContent = userId.length > 10 ? userId.substring(0, 10) + '...' : userId;
                    profileUserIdDisplay.textContent = userId;
                    listenForTransactions();
                } else {
                    appContainer.classList.add('hidden');
                    authModal.classList.remove('hidden');
                    if (unsubscribe) {
                         unsubscribe();
                    }
                }
            });
        };

        const renderAllViews = () => {
            renderDashboard();
            renderPortfolio();
            renderTransactions();
        };
        
        // --- Data Grouping and Calculation ---
        const groupHoldingsByTicker = (transactions) => {
            const holdings = {};
            const tickersWithShares = new Set();
            transactions.forEach(tx => {
                if (tx.type === 'Buy') {
                    tickersWithShares.add(tx.ticker);
                } else if (tx.type === 'Sell') {
                    const buyTxs = transactions.filter(t => t.ticker === tx.ticker && t.type === 'Buy');
                    const sellTxs = transactions.filter(t => t.ticker === tx.ticker && t.type === 'Sell');
                    const totalBuyShares = buyTxs.reduce((sum, t) => sum + parseFloat(t.shares), 0);
                    const totalSellShares = sellTxs.reduce((sum, t) => sum + parseFloat(t.shares), 0);
                    if (totalBuyShares > totalSellShares) {
                        tickersWithShares.add(tx.ticker);
                    } else {
                        tickersWithShares.delete(tx.ticker);
                    }
                }
            });

            tickersWithShares.forEach(ticker => {
                const tickerTxs = transactions.filter(tx => tx.ticker.toLowerCase() === ticker.toLowerCase());
                let totalShares = 0;
                let totalCost = 0;
                let market = '';
                let assetType = '';

                tickerTxs.forEach(tx => {
                    if (tx.type === 'Buy') {
                        totalShares += parseFloat(tx.shares);
                        totalCost += (parseFloat(tx.shares) * parseFloat(tx.buyPrice));
                    } else if (tx.type === 'Sell') {
                        totalShares -= parseFloat(tx.shares);
                        if (holdings[ticker]) {
                            const avgBuyPrice = holdings[ticker].avgBuyPrice;
                            totalCost -= (parseFloat(tx.shares) * avgBuyPrice);
                        }
                    }
                    if (tx.market) market = tx.market;
                    if (tx.assetType) assetType = tx.assetType;
                });
                
                const avgBuyPrice = totalShares > 0 ? (totalCost / totalShares) : 0;
                const currentPrice = avgBuyPrice * (1 + (Math.random() - 0.5) * 0.2); // Placeholder for live price
                const currentValue = currentPrice * totalShares;
                
                holdings[ticker] = {
                    ticker,
                    shares: totalShares,
                    avgBuyPrice: avgBuyPrice,
                    totalCost: totalCost,
                    market: market,
                    assetType: assetType,
                    currentPrice: currentPrice,
                    currentValue: currentValue,
                    gainLoss: currentValue - totalCost
                };
            });
            return holdings;
        };

        const calculateTotalPortfolioValue = () => {
            let totalValue = 0;
            let totalCost = 0;
            let marketAllocation = {};

            Object.values(groupedHoldings).forEach(holding => {
                totalValue += holding.currentValue;
                totalCost += holding.totalCost;
                
                const market = holding.market;
                if (!marketAllocation[market]) {
                    marketAllocation[market] = 0;
                }
                marketAllocation[market] += holding.currentValue;
            });
            return { totalValue, totalCost, marketAllocation };
        };

        // --- UI Rendering Functions ---
        const showPage = (pageId) => {
            pages.forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
        };

        const setActiveNav = (navId) => {
            navItems.forEach(item => {
                item.classList.remove('active-nav-bg', 'active-nav');
                item.classList.add('hover:bg-gray-200');
            });
            const activeItem = document.getElementById(navId);
            activeItem.classList.add('active-nav-bg', 'active-nav');
            activeItem.classList.remove('hover:bg-gray-200');
        };

        const calculatePerformanceMetrics = () => {
            const { totalValue, totalCost } = calculateTotalPortfolioValue();
            const gainLoss = totalValue - totalCost;
            const gainLossPct = totalCost > 0 ? (gainLoss / totalCost) * 100 : 0;
            
            // Simplified TWR/MWR calculations for demo
            const simplifiedReturn = totalCost > 0 ? (totalValue - totalCost) / totalCost : 0;
            twrValueEl.textContent = `${(simplifiedReturn * 100).toFixed(2)}%`;
            mwrValueEl.textContent = `${(simplifiedReturn * 100).toFixed(2)}%`;
        };

        const renderDashboard = () => {
            const { totalValue, totalCost, marketAllocation } = calculateTotalPortfolioValue();
            
            totalValueEl.textContent = `$${totalValue.toFixed(2)}`;
            const gainLoss = totalValue - totalCost;
            const gainLossPct = totalCost > 0 ? (gainLoss / totalCost) * 100 : 0;
            overallGainLossEl.textContent = `$${gainLoss.toFixed(2)}`;
            overallGainLossPctEl.textContent = ` (${gainLossPct.toFixed(2)}%)`;
            
            if (gainLoss >= 0) {
                overallGainLossEl.classList.add('text-green-600');
                overallGainLossEl.classList.remove('text-red-600');
                overallGainLossPctEl.classList.add('text-green-500');
                overallGainLossPctEl.classList.remove('text-red-500');
            } else {
                overallGainLossEl.classList.add('text-red-600');
                overallGainLossEl.classList.remove('text-green-600');
                overallGainLossPctEl.classList.add('text-red-500');
                overallGainLossPctEl.classList.remove('text-green-500');
            }
            
            calculatePerformanceMetrics();

            if (Object.keys(marketAllocation).length > 0 && totalValue > 0) {
                chartPlaceholder.classList.add('hidden');
                document.getElementById('allocation-chart').classList.remove('hidden');
                if (allocationChart) {
                    allocationChart.destroy();
                }
                const data = {
                    labels: Object.keys(marketAllocation),
                    datasets: [{
                        data: Object.values(marketAllocation),
                        backgroundColor: ['#4F46E5', '#F59E0B', '#10B981'],
                        hoverOffset: 4
                    }]
                };
                allocationChart = new Chart(allocationChartCtx, {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
                                        const percentage = (value / total * 100).toFixed(2);
                                        return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                if (allocationChart) {
                    allocationChart.destroy();
                    allocationChart = null;
                }
                chartPlaceholder.classList.remove('hidden');
                document.getElementById('allocation-chart').classList.add('hidden');
            }
        };

        const renderPortfolio = () => {
            investmentsList.innerHTML = '';
            const holdingsArray = Object.values(groupedHoldings);
            
            const filteredHoldings = holdingsArray.filter(item => {
                if (currentFilter === 'all') return true;
                if (currentFilter === 'US' || currentFilter === 'Malaysia') {
                    return item.market === currentFilter;
                }
                if (currentFilter === 'Stock' || currentFilter === 'ETF') {
                    return item.assetType === currentFilter;
                }
                return false;
            });
            
            if (filteredHoldings.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            filteredHoldings.forEach(item => {
                if (item.shares <= 0) return;
                
                const gainLossPct = item.totalCost > 0 ? (item.gainLoss / item.totalCost) * 100 : 0;
                const gainLossColor = item.gainLoss >= 0 ? 'text-green-600' : 'text-red-600';
                
                const itemHtml = `
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm flex flex-col sm:flex-row justify-between items-center border border-gray-100 cursor-pointer hover:bg-gray-100 transition-colors" data-ticker="${item.ticker}">
                        <div class="flex-grow">
                            <h3 class="text-lg font-bold text-gray-800">${item.ticker.toUpperCase()}</h3>
                            <p class="text-sm text-gray-500">${item.assetType} â€¢ ${item.market}</p>
                            <p class="text-sm text-gray-500">Shares: ${item.shares}</p>
                            <p class="text-sm text-gray-500">Avg Buy Price: $${item.avgBuyPrice.toFixed(2)}</p>
                        </div>
                        <div class="mt-4 sm:mt-0 text-left sm:text-right">
                            <p class="text-sm font-medium text-gray-600">Current Price: <span class="font-bold text-gray-800">$${item.currentPrice.toFixed(2)}</span></p>
                            <p class="text-sm font-medium text-gray-600">Total Value: <span class="font-bold text-gray-800">$${item.currentValue.toFixed(2)}</span></p>
                            <p class="text-sm font-medium text-gray-600">Unrealized Gain/Loss: <span class="${gainLossColor} font-bold">$${item.gainLoss.toFixed(2)} (${gainLossPct.toFixed(2)}%)</span></p>
                        </div>
                        <button class="get-ai-ticker-insights-btn mt-4 sm:mt-0 sm:ml-4 bg-purple-100 text-purple-600 px-3 py-1 text-sm rounded-full font-medium shadow-sm hover:bg-purple-200 transition-colors" data-ticker="${item.ticker}" data-asset-type="${item.assetType}" data-market="${item.market}" onclick="event.stopPropagation()">
                            AI Insights âœ¨
                        </button>
                    </div>
                `;
                investmentsList.innerHTML += itemHtml;
            });

            document.querySelectorAll('#investments-list > div').forEach(item => {
                item.addEventListener('click', (e) => {
                    const ticker = e.currentTarget.dataset.ticker;
                    const holding = groupedHoldings[ticker];
                    if (holding) {
                        showInvestmentDetail(holding);
                    }
                });
            });

            document.querySelectorAll('.get-ai-ticker-insights-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const ticker = e.currentTarget.dataset.ticker;
                    const assetType = e.currentTarget.dataset.assetType;
                    const market = e.currentTarget.dataset.market;
                    getAITickerInsights(ticker, assetType, market);
                });
            });
        };
        
        const showInvestmentDetail = (holding) => {
            detailsModalTitle.textContent = `${holding.ticker.toUpperCase()} (${holding.assetType} on ${holding.market})`;
            
            // Filter transactions for this specific ticker
            const tickerTxs = transactionsData.filter(tx => tx.ticker.toLowerCase() === holding.ticker.toLowerCase()).sort((a,b) => b.timestamp.getTime() - a.timestamp.getTime());
            
            const totalBuyCost = tickerTxs.filter(tx => tx.type === 'Buy').reduce((sum, tx) => sum + (parseFloat(tx.shares) * parseFloat(tx.buyPrice)), 0);
            
            detailsSharesEl.textContent = holding.shares.toFixed(2);
            detailsBuyPriceEl.textContent = `$${holding.avgBuyPrice.toFixed(2)}`;
            detailsTotalCostEl.textContent = `$${totalBuyCost.toFixed(2)}`;
            detailsCurrentValueEl.textContent = `$${holding.currentValue.toFixed(2)}`;
            const gainLossColor = holding.gainLoss >= 0 ? 'text-green-600' : 'text-red-600';
            const gainLossPct = holding.totalCost > 0 ? (holding.gainLoss / holding.totalCost) * 100 : 0;
            detailsGainLossEl.innerHTML = `<span class="${gainLossColor}">$${holding.gainLoss.toFixed(2)} (${gainLossPct.toFixed(2)}%)</span>`;
            
            // Simulate price history for the chart
            const labels = Array.from({ length: 30 }, (_, i) => `Day ${i + 1}`);
            const data = {
                labels: labels,
                datasets: [{
                    label: 'Price (Simulated)',
                    data: Array.from({ length: 30 }, (_, i) => holding.avgBuyPrice + (Math.sin(i / 5) * 2 + (Math.random() - 0.5) * 1)),
                    borderColor: '#4F46E5',
                    tension: 0.1
                }]
            };

            if (priceChart) {
                priceChart.destroy();
            }

            priceChart = new Chart(priceChartCtx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });
            
            renderDetailsTransactions(tickerTxs);
            detailsModal.classList.remove('hidden');
        };
        
        const renderDetailsTransactions = (transactions) => {
            detailsTransactionsList.innerHTML = '';
            if (transactions.length === 0) {
                emptyDetailsTransactionsState.classList.remove('hidden');
                return;
            }
            emptyDetailsTransactionsState.classList.add('hidden');
            transactions.forEach(tx => {
                const txType = tx.type;
                const colorClass = txType === 'Buy' ? 'text-green-600' : 'text-red-600';
                
                const price = txType === 'Buy' ? parseFloat(tx.buyPrice) : parseFloat(tx.sellPrice);
                const costOrProceeds = txType === 'Buy' ? (parseFloat(tx.shares) * parseFloat(tx.buyPrice)) : (parseFloat(tx.shares) * parseFloat(tx.sellPrice));
                const costLabel = txType === 'Buy' ? 'Total Cost' : 'Total Proceeds';
                const priceLabel = txType === 'Buy' ? 'Buy price' : 'Sell price';

                const itemHtml = `
                    <div class="bg-gray-100 p-4 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <p class="font-bold text-lg text-gray-800">${tx.ticker.toUpperCase()}</p>
                                <p class="text-sm text-gray-500">${tx.assetType} â€¢ ${tx.market} â€¢ ${new Date(tx.timestamp).toLocaleDateString()}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <p class="font-bold text-2xl ${colorClass}">${txType}</p>
                            </div>
                        </div>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between">
                                <span class="font-medium text-gray-700">Shares:</span>
                                <span class="text-gray-800">${parseFloat(tx.shares).toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-medium text-gray-700">${priceLabel} per share:</span>
                                <span class="text-gray-800">$${price.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between font-bold text-md mt-2 pt-2 border-t border-gray-200">
                                <span class="text-gray-700">${costLabel}:</span>
                                <span class="text-gray-800">$${costOrProceeds.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `;
                detailsTransactionsList.innerHTML += itemHtml;
            });
        };

        const renderTransactions = () => {
            transactionsList.innerHTML = '';
            const sortedTransactions = [...transactionsData].sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());
            
            if (sortedTransactions.length === 0) {
                emptyTransactionsState.classList.remove('hidden');
                return;
            }
            emptyTransactionsState.classList.add('hidden');

            sortedTransactions.forEach(tx => {
                const txType = tx.type;
                const colorClass = txType === 'Buy' ? 'text-green-600' : 'text-red-600';
                const price = txType === 'Buy' ? parseFloat(tx.buyPrice) : parseFloat(tx.sellPrice);
                const costOrProceeds = txType === 'Buy' ? (parseFloat(tx.shares) * price) : (parseFloat(tx.shares) * price);
                const costLabel = txType === 'Buy' ? 'Total Cost' : 'Total Proceeds';
                const priceLabel = txType === 'Buy' ? 'Buy price' : 'Sell price';
                
                const itemHtml = `
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm flex flex-col sm:flex-row justify-between items-center border border-gray-100 relative">
                        <div class="flex-grow">
                            <p class="font-bold text-lg text-gray-800">${tx.ticker.toUpperCase()}</p>
                            <p class="text-sm text-gray-500">${tx.assetType} â€¢ ${tx.market} â€¢ ${new Date(tx.timestamp).toLocaleDateString()}</p>
                            <p class="text-sm font-medium text-gray-600 mt-2">Shares: <span class="text-gray-800">${parseFloat(tx.shares).toFixed(2)}</span></p>
                            <p class="text-sm font-medium text-gray-600">${priceLabel}: <span class="text-gray-800">$${price.toFixed(2)}</span></p>
                        </div>
                        <div class="mt-4 sm:mt-0 text-left sm:text-right">
                            <p class="font-bold text-2xl ${colorClass}">${txType}</p>
                            <p class="text-sm font-medium text-gray-600">${costLabel}: <span class="font-bold text-gray-800">$${costOrProceeds.toFixed(2)}</span></p>
                        </div>
                        <div class="flex space-x-2 absolute top-4 right-4 sm:static sm:ml-4 sm:space-x-2">
                            <button class="edit-transaction-btn bg-yellow-100 text-yellow-600 px-2 py-1 rounded-full font-medium text-sm hover:bg-yellow-200 transition-colors" data-id="${tx.id}">Edit</button>
                            <button class="delete-transaction-btn delete-btn px-2 py-1 rounded-full font-medium text-sm hover:bg-red-500 transition-colors" data-id="${tx.id}">Delete</button>
                        </div>
                    </div>
                `;
                transactionsList.innerHTML += itemHtml;
            });
            
            document.querySelectorAll('.edit-transaction-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const txId = e.currentTarget.dataset.id;
                    const transactionToEdit = transactionsData.find(tx => tx.id === txId);
                    if (transactionToEdit) {
                        editTransactionUI(transactionToEdit);
                    }
                });
            });

            document.querySelectorAll('.delete-transaction-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const txId = e.currentTarget.dataset.id;
                    showMessageBox("Are you sure you want to delete this transaction?", () => deleteTransaction(txId), true);
                });
            });
        };
        
        // --- UI Functions ---
        const showMessageBox = (message, onConfirm = null, isConfirm = false) => {
            messageBoxText.textContent = message;
            messageBoxActions.innerHTML = '';

            const okBtn = document.createElement('button');
            okBtn.textContent = isConfirm ? 'Cancel' : 'OK';
            okBtn.className = 'bg-gray-400 text-gray-800 py-2 px-4 rounded-lg font-medium hover:bg-gray-500 transition-colors duration-200';
            okBtn.onclick = () => messageBox.classList.add('hidden');
            
            messageBoxActions.appendChild(okBtn);

            if (isConfirm) {
                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = 'Delete';
                confirmBtn.className = 'bg-red-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-red-700 transition-colors duration-200';
                confirmBtn.onclick = () => {
                    if (onConfirm) onConfirm();
                    messageBox.classList.add('hidden');
                };
                messageBoxActions.insertBefore(confirmBtn, okBtn);
            }
            
            messageBox.classList.remove('hidden');
        };

        const showAIResponseModal = (title, content) => {
            aiModalTitle.textContent = title;
            aiResponseContent.innerHTML = content;
            aiResponseModal.classList.remove('hidden');
        };

        const getAIPortfolioSummary = async () => {
            showAIResponseModal('AI Portfolio Summary', `
                <div class="flex items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-2 border-t-2 border-blue-500 border-opacity-75"></div>
                </div>
            `);

            const portfolioSummary = Object.values(groupedHoldings).map(item =>
                `Ticker: ${item.ticker.toUpperCase()}, Shares: ${item.shares}, Buy Price: ${item.avgBuyPrice.toFixed(2)}, Market: ${item.market}`
            ).join('\n');
            
            await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate API delay
            const demoText = "This is a dummy AI insight for your portfolio. The portfolio appears to be well-diversified with a mix of US stocks and ETFs, and a single Malaysian ETF. However, the performance is heavily reliant on a single stock. Consider diversifying further into other sectors to mitigate risk. Your portfolio's overall health seems to be stable but with a slight unrealized gain, it's a good time to re-evaluate your holdings based on your risk tolerance.";
            aiResponseContent.innerHTML = `<p>${demoText}</p>`;
        };

        const getAITickerInsights = async (ticker, assetType, market) => {
            showAIResponseModal(`AI Insights for ${ticker.toUpperCase()}`, `
                <div class="flex items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-2 border-t-2 border-blue-500 border-opacity-75"></div>
                </div>
            `);
            
            await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate API delay
            const demoText = `This is a dummy AI insight for ${ticker}. The company is a leading player in the ${assetType} space, known for its strong market presence in the ${market} region. Recent performance has been volatile but shows long-term growth potential.`;
            aiResponseContent.innerHTML = `<p>${demoText}</p>`;
        };

        const editTransactionUI = (transaction) => {
            modalTitle.textContent = 'Edit Transaction';
            transactionIdInput.value = transaction.id;
            transactionDateInput.value = transaction.timestamp.toISOString().split('T')[0];
            tickerInput.value = transaction.ticker;
            sharesInput.value = transaction.shares;
            marketSelect.value = transaction.market;
            assetTypeSelect.value = transaction.assetType;
            
            if (transaction.type === 'Buy') {
                toggleTransactionType('Buy');
                buyPriceInput.value = transaction.buyPrice;
            } else {
                toggleTransactionType('Sell');
                sellPriceInput.value = transaction.sellPrice;
            }

            investmentModal.classList.remove('hidden');
        };

        // --- Event Listeners ---
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const pageId = item.id.replace('nav-', '') + '-page';
                showPage(pageId);
                setActiveNav(item.id);
            });
        });

        addInvestmentBtn.addEventListener('click', () => {
            modalTitle.textContent = 'Add New Transaction';
            investmentForm.reset();
            transactionIdInput.value = '';
            toggleTransactionType('Buy');
            investmentModal.classList.remove('hidden');
        });

        closeModalBtn.addEventListener('click', () => {
            investmentModal.classList.add('hidden');
        });
        
        closeDetailsModalBtn.addEventListener('click', () => {
            detailsModal.classList.add('hidden');
        });

        closeAiModalBtn.addEventListener('click', () => {
            aiResponseModal.classList.add('hidden');
        });

        investmentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const txId = transactionIdInput.value;
            const newTransaction = {
                type: currentTxType,
                market: marketSelect.value,
                assetType: assetTypeSelect.value,
                ticker: tickerInput.value.toUpperCase(),
                shares: parseFloat(sharesInput.value),
                buyPrice: parseFloat(buyPriceInput.value) || null,
                sellPrice: parseFloat(sellPriceInput.value) || null,
                timestamp: new Date(transactionDateInput.value),
                totalFees: 3.50, // Hardcoded for this demo
                feesBreakdown: { commission: 1.50, platform: 1.00, settlement: 0.50, stampDuty: 0.50 }
            };
            
            if (txId) {
                // Update existing transaction
                await updateTransaction(txId, newTransaction);
            } else {
                // Add new transaction
                await addTransaction(newTransaction);
            }
            investmentModal.classList.add('hidden');
        });
        
        typeBuyBtn.addEventListener('click', () => toggleTransactionType('Buy'));
        typeSellBtn.addEventListener('click', () => toggleTransactionType('Sell'));
        
        const toggleTransactionType = (type) => {
            currentTxType = type;
            if (type === 'Buy') {
                typeBuyBtn.classList.add('bg-indigo-600', 'text-white');
                typeBuyBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                typeSellBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                typeSellBtn.classList.remove('bg-indigo-600', 'text-white');
                buyPriceGroup.classList.remove('hidden');
                sellPriceGroup.classList.add('hidden');
            } else {
                typeSellBtn.classList.add('bg-indigo-600', 'text-white');
                typeSellBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                typeBuyBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                typeBuyBtn.classList.remove('bg-indigo-600', 'text-white');
                sellPriceGroup.classList.remove('hidden');
                buyPriceGroup.classList.add('hidden');
            }
        };

        deleteDataBtn.addEventListener('click', () => {
            showMessageBox("This will permanently delete all your data. Are you sure?", async () => {
                await deleteAllData();
                showMessageBox("All your data has been deleted.");
            }, true);
        });
        
        getAiInsightsBtn.addEventListener('click', getAIPortfolioSummary);
        
        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                filterBtns.forEach(b => {
                    b.classList.remove('bg-indigo-200', 'text-indigo-800', 'font-semibold');
                    b.classList.add('bg-gray-200', 'text-gray-700');
                });
                btn.classList.add('bg-indigo-200', 'text-indigo-800', 'font-semibold');
                btn.classList.remove('bg-gray-200', 'text-gray-700');
                currentFilter = btn.dataset.filter;
                renderPortfolio();
            });
        });

        // --- AUTHENTICATION LOGIC ---
        let isSigningUp = false;

        authToggleLink.addEventListener('click', () => {
            isSigningUp = !isSigningUp;
            authModalTitle.textContent = isSigningUp ? 'Sign up' : 'Sign in';
            authSubmitBtn.textContent = isSigningUp ? 'Sign up' : 'Sign in';
            authToggleLink.innerHTML = isSigningUp ? 'Already have an account? <span class="font-medium text-indigo-600 hover:text-indigo-800">Sign in</span>' : 'Don\'t have an account? <span class="font-medium text-indigo-600 hover:text-indigo-800">Sign up</span>';
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            authSubmitBtn.disabled = true;
            authSubmitBtn.textContent = 'Loading...';

            try {
                if (isSigningUp) {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                let errorMessage = 'An unexpected error occurred.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Email already in use. Please sign in or use a different email.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password is too weak. Please choose a stronger password.';
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = 'Invalid email or password.';
                }
                showMessageBox(errorMessage);
            } finally {
                authSubmitBtn.disabled = false;
                authSubmitBtn.textContent = isSigningUp ? 'Sign up' : 'Sign in';
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showMessageBox("You have been logged out successfully.");
            } catch (error) {
                showMessageBox("Failed to log out. Please try again.");
            }
        });
    </script>
</body>
</html>
