<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 900px;
            margin: auto;
        }
        .active-nav {
            color: #4f46e5;
        }
        .active-nav-bg {
            background-color: #eef2ff;
        }
        .delete-btn {
            background-color: #fca5a5;
            color: #991b1b;
        }
        .delete-btn:hover {
            background-color: #f87171;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="fixed inset-0 bg-gray-200 bg-opacity-75 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-blue-500 border-opacity-75"></div>
    </div>
    
    <!-- Login/Signup Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h3 id="auth-modal-title" class="text-2xl font-bold text-center mb-6 text-gray-800">Sign in</h3>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="auth-email" class="block text-sm font-medium text-gray-700">Email address</label>
                    <input type="email" id="auth-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="auth-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="auth-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <button type="submit" id="auth-submit-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors duration-200">Sign in</button>
            </form>
            <p id="auth-toggle-link" class="text-center text-sm mt-4 text-gray-600 cursor-pointer">
                Don't have an account? <span class="font-medium text-indigo-600 hover:text-indigo-800">Sign up</span>
            </p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="container bg-white rounded-xl shadow-lg m-4 p-6 flex-grow relative hidden">

        <!-- Header and User Info -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">My Portfolio</h1>
            <div class="flex items-center space-x-2">
                <div class="flex items-center space-x-2 bg-gray-50 text-gray-600 px-3 py-1 rounded-full text-sm">
                    <span id="user-id-display" class="truncate">Authenticating...</span>
                </div>
                <button id="logout-btn" class="text-sm text-red-500 hover:text-red-700 transition-colors duration-200 font-medium">Log out</button>
            </div>
        </header>

        <!-- Main Content Area -->
        <div id="content-area" class="pb-24">
            <!-- Dashboard View -->
            <div id="dashboard-page" class="page">
                <section class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-indigo-50 p-6 rounded-xl shadow-inner border border-indigo-200">
                        <h2 class="text-lg text-indigo-800 font-semibold mb-2">Total Portfolio Value</h2>
                        <p id="total-value" class="text-4xl font-bold text-indigo-600">$0.00</p>
                    </div>
                    <div class="bg-green-50 p-6 rounded-xl shadow-inner border border-green-200">
                        <h2 class="text-lg text-green-800 font-semibold mb-2">Overall Gain/Loss</h2>
                        <p id="overall-gain-loss" class="text-4xl font-bold text-green-600">$0.00</p>
                        <span id="overall-gain-loss-pct" class="text-green-500 text-sm font-medium"> (0.00%)</span>
                    </div>
                </section>
                
                <section class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-blue-50 p-6 rounded-xl shadow-inner border border-blue-200">
                        <h2 class="text-lg text-blue-800 font-semibold mb-2">Time-Weighted Return (TWR)</h2>
                        <p id="twr-value" class="text-4xl font-bold text-blue-600">0.00%</p>
                        <p class="text-xs text-gray-500 mt-2">A measure of compound growth, unaffected by deposits/withdrawals.</p>
                    </div>
                    <div class="bg-blue-50 p-6 rounded-xl shadow-inner border border-blue-200">
                        <h2 class="text-lg text-blue-800 font-semibold mb-2">Money-Weighted Return (MWR)</h2>
                        <p id="mwr-value" class="text-4xl font-bold text-blue-600">0.00%</p>
                        <p class="text-xs text-gray-500 mt-2">The return rate that accounts for timing of cash flows.</p>
                    </div>
                </section>

                <section class="bg-white p-6 rounded-xl shadow border border-gray-100 mb-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Asset Allocation</h2>
                    <div class="w-full h-64 flex items-center justify-center">
                        <p id="chart-placeholder" class="text-gray-400">Add a transaction to see your asset allocation here.</p>
                        <canvas id="allocation-chart" class="w-full h-full hidden"></canvas>
                    </div>
                </section>

                <section class="flex justify-center">
                    <button id="get-ai-insights-btn" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-medium shadow-md hover:bg-purple-700 transition-colors duration-200">
                        Get AI Portfolio Summary âœ¨
                    </button>
                </section>
            </div>

            <!-- Portfolio View -->
            <div id="portfolio-page" class="page hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">My Investments</h2>
                    <button id="add-investment-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium shadow hover:bg-blue-700 transition-colors duration-200">
                        + Add New
                    </button>
                </div>
                <div class="flex items-center space-x-2 mb-4">
                    <span class="text-sm font-medium text-gray-700">Filter By:</span>
                    <button data-filter="all" class="filter-btn text-sm px-3 py-1 rounded-full bg-indigo-200 text-indigo-800 font-semibold">All</button>
                    <button data-filter="US" class="filter-btn text-sm px-3 py-1 rounded-full bg-gray-200 text-gray-700">US</button>
                    <button data-filter="Malaysia" class="filter-btn text-sm px-3 py-1 rounded-full bg-gray-200 text-gray-700">Malaysia</button>
                    <button data-filter="Stock" class="filter-btn text-sm px-3 py-1 rounded-full bg-gray-200 text-gray-700">Stocks</button>
                    <button data-filter="ETF" class="filter-btn text-sm px-3 py-1 rounded-full bg-gray-200 text-gray-700">ETFs</button>
                </div>
                <div id="investments-list" class="space-y-4">
                    <!-- Investment items will be rendered here -->
                </div>
                <div id="empty-state" class="text-center text-gray-400 mt-8 hidden">
                    <p class="mb-2">You don't have any investments yet.</p>
                    <p>Click "Add New" to get started!</p>
                </div>
            </div>

            <!-- Transactions View -->
            <div id="transactions-page" class="page hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Transaction History</h2>
                <div id="transactions-list" class="space-y-4">
                    <!-- Transaction items will be rendered here -->
                </div>
                <div id="empty-transactions-state" class="text-center text-gray-400 mt-8 hidden">
                    <p class="mb-2">No transactions recorded.</p>
                </div>
            </div>

            <!-- Markets View -->
            <div id="markets-page" class="page hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Global Markets</h2>
                <div class="bg-gray-50 p-6 rounded-xl shadow-inner text-center text-gray-400">
                    <p>This section would display live market data, news, and indices.</p>
                    <p>This is a placeholder as real-time market data requires a separate API integration.</p>
                </div>
            </div>

            <!-- Profile/Settings View -->
            <div id="profile-page" class="page hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Profile & Settings</h2>
                <div class="bg-gray-50 p-6 rounded-xl shadow-inner">
                    <p class="font-medium text-gray-700 mb-2">Your User ID:</p>
                    <p id="profile-user-id" class="text-sm font-mono break-all text-gray-500">Not available in demo mode</p>
                </div>
                <div class="mt-6 bg-red-50 p-6 rounded-xl shadow-inner border border-red-200">
                    <h3 class="text-lg font-semibold text-red-800 mb-2">Danger Zone</h3>
                    <p class="text-sm text-red-700 mb-4">
                        This action will permanently delete all of your data from the app.
                    </p>
                    <button id="delete-data-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium shadow hover:bg-red-700 transition-colors duration-200">
                        Delete My Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Adding/Editing an Investment -->
    <div id="investment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800">Add New Transaction</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">&times;</button>
            </div>
            <form id="investment-form" class="space-y-4">
                <div>
                    <label for="transaction-date" class="block text-sm font-medium text-gray-700">Date</label>
                    <input type="date" id="transaction-date" name="transaction-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Transaction Type</label>
                    <div class="mt-1 flex space-x-2">
                        <button type="button" id="type-buy-btn" class="flex-1 py-2 rounded-lg font-medium shadow-sm transition-colors duration-200 bg-indigo-600 text-white">Buy</button>
                        <button type="button" id="type-sell-btn" class="flex-1 py-2 rounded-lg font-medium shadow-sm transition-colors duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300">Sell</button>
                    </div>
                </div>
                <div>
                    <label for="market" class="block text-sm font-medium text-gray-700">Market</label>
                    <select id="market" name="market" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="US">US</option>
                        <option value="Malaysia">Malaysia</option>
                    </select>
                </div>
                <div>
                    <label for="asset-type" class="block text-sm font-medium text-gray-700">Asset Type</label>
                    <select id="asset-type" name="asset-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="Stock">Stock</option>
                        <option value="ETF">ETF</option>
                    </select>
                </div>
                <div>
                    <label for="ticker" class="block text-sm font-medium text-gray-700">Ticker Symbol</label>
                    <input type="text" id="ticker" name="ticker" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="shares" class="block text-sm font-medium text-gray-700">Number of Shares</label>
                    <input type="number" id="shares" name="shares" required min="0.01" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div id="buy-price-group" class="price-group">
                    <label for="buy-price" class="block text-sm font-medium text-gray-700">Buy Price (USD/MYR)</label>
                    <input type="number" id="buy-price" name="buy-price" required min="0.01" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div id="sell-price-group" class="price-group hidden">
                    <label for="sell-price" class="block text-sm font-medium text-gray-700">Sell Price (USD/MYR)</label>
                    <input type="number" id="sell-price" name="sell-price" required min="0.01" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <input type="hidden" id="transaction-id">
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors duration-200 mt-4">Save Transaction</button>
            </form>
        </div>
    </div>

    <!-- Modal for Detailed Investment View -->
    <div id="details-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 id="details-modal-title" class="text-xl font-bold text-gray-800"></h3>
                <button id="close-details-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">&times;</button>
            </div>
            <div class="space-y-4">
                <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                    <h4 class="font-semibold text-gray-700 mb-2">Price History (Simulated)</h4>
                    <div class="w-full h-48">
                        <canvas id="price-chart"></canvas>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-500">Quantity Owned</p>
                        <p id="details-shares" class="text-lg font-bold text-gray-800"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-500">Average Buy Price</p>
                        <p id="details-buy-price" class="text-lg font-bold text-gray-800"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-500">Total Cost</p>
                        <p id="details-total-cost" class="text-lg font-bold text-gray-800"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-500">Current Market Value</p>
                        <p id="details-current-value" class="text-lg font-bold text-gray-800"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm col-span-2">
                        <p class="text-sm text-gray-500">Unrealized Gain/Loss</p>
                        <p id="details-gain-loss" class="text-lg font-bold text-gray-800"></p>
                    </div>
                </div>
                <!-- New section for Transaction Log -->
                <div class="mt-6">
                    <h4 class="font-semibold text-xl text-gray-700 mb-2">Transaction History</h4>
                    <div id="details-transactions-list" class="space-y-4">
                        <!-- Transactions for this specific ticker will be rendered here -->
                    </div>
                    <div id="empty-details-transactions-state" class="text-center text-gray-400 mt-4 hidden">
                        <p>No transactions for this holding.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Message Box Modal -->
    <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
            <p id="message-box-text" class="text-gray-800 text-lg mb-4"></p>
            <div id="message-box-actions" class="flex justify-center space-x-4">
                <button id="message-box-ok-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors duration-200">OK</button>
            </div>
        </div>
    </div>

    <!-- AI Response Modal -->
    <div id="ai-response-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 id="ai-modal-title" class="text-xl font-bold text-gray-800">AI Insights</h3>
                <button id="close-ai-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">&times;</button>
            </div>
            <div id="ai-response-content" class="text-gray-700 prose max-w-none">
                <div class="flex items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-2 border-t-2 border-blue-500 border-opacity-75"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-2xl border-t border-gray-200 z-30">
        <ul class="flex justify-around items-center h-16 text-gray-500 text-sm">
            <li>
                <button id="nav-dashboard" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200 active-nav-bg active-nav">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <span class="mt-1">Dashboard</span>
                </button>
            </li>
            <li>
                <button id="nav-portfolio" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-2v2m-4-2v2m4-2h.01M12 18a6 6 0 100-12 6 6 0 000 12z" />
                    </svg>
                    <span class="mt-1">Portfolio</span>
                </button>
            </li>
            <li>
                <button id="nav-transactions" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="mt-1">Transactions</span>
                </button>
            </li>
            <li>
                <button id="nav-markets" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8L11 20" />
                    </svg>
                    <span class="mt-1">Markets</span>
                </button>
            </li>
            <li>
                <button id="nav-profile" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span class="mt-1">Profile</span>
                </button>
            </li>
        </ul>
    </nav>

    <!-- External Libraries (Firebase and Chart.js) -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, setLogLevel, getDocs, writeBatch, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { Chart, DoughnutController, ArcElement, LineController, CategoryScale, LinearScale, PointElement, LineElement, Tooltip, Legend } from 'https://cdn.jsdelivr.net/npm/chart.js@4.4.3/+esm';
        
        // Register Chart.js components
        Chart.register(DoughnutController, ArcElement, LineController, CategoryScale, LinearScale, PointElement, LineElement, Tooltip, Legend);
        
        // --- Firebase & App State Initialization ---
        let app, db, auth, userId, unsubscribe;
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
		  apiKey: "AIzaSyBUkADc0TTBrM0STMhTLzA6htyYgiOdsro",
		  authDomain: "investmenttracker-af126.firebaseapp.com",
		  projectId: "yinvestmenttracker-af126",
		  storageBucket: "investmenttracker-af126.firebasestorage.app",
		  messagingSenderId: "782078886994",
		  appId: "1:782078886994:web:8d02aed4ddd2f62b198b8b",
		  measurementId: "G-NVNMZPPC3H"
		};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // API key for the Gemini API call
        const apiKey = "";
        const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + apiKey;

        // Set log level to debug for now
        setLogLevel('debug');
        
        let transactionsData = [];
        let groupedHoldings = {};
        let allocationChart = null;
        let priceChart = null;
        let currentFilter = 'all';
        let currentTxType = 'Buy';
        let currentInvestment = null; // Store the currently viewed investment for the details modal

        // --- DOM Elements ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const appContainer = document.getElementById('app-container');
        const authModal = document.getElementById('auth-modal');
        const authModalTitle = document.getElementById('auth-modal-title');
        const authForm = document.getElementById('auth-form');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authToggleLink = document.getElementById('auth-toggle-link');
        const logoutBtn = document.getElementById('logout-btn');
        const userIdDisplay = document.getElementById('user-id-display');
        const profileUserIdDisplay = document.getElementById('profile-user-id');
        const navItems = document.querySelectorAll('.nav-item');
        const pages = document.querySelectorAll('.page');
        const addInvestmentBtn = document.getElementById('add-investment-btn');
        const investmentModal = document.getElementById('investment-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const investmentForm = document.getElementById('investment-form');
        const investmentsList = document.getElementById('investments-list');
        const emptyState = document.getElementById('empty-state');
        const totalValueEl = document.getElementById('total-value');
        const overallGainLossEl = document.getElementById('overall-gain-loss');
        const overallGainLossPctEl = document.getElementById('overall-gain-loss-pct');
        const twrValueEl = document.getElementById('twr-value');
        const mwrValueEl = document.getElementById('mwr-value');
        const transactionsList = document.getElementById('transactions-list');
        const emptyTransactionsState = document.getElementById('empty-transactions-state');
        const deleteDataBtn = document.getElementById('delete-data-btn');
        const messageBox = document.getElementById('message-box');
        const messageBoxText = document.getElementById('message-box-text');
        const messageBoxActions = document.getElementById('message-box-actions');
        const allocationChartCtx = document.getElementById('allocation-chart').getContext('2d');
        const chartPlaceholder = document.getElementById('chart-placeholder');
        const getAiInsightsBtn = document.getElementById('get-ai-insights-btn');
        const aiResponseModal = document.getElementById('ai-response-modal');
        const closeAiModalBtn = document.getElementById('close-ai-modal-btn');
        const aiModalTitle = document.getElementById('ai-modal-title');
        const aiResponseContent = document.getElementById('ai-response-content');
        const filterBtns = document.querySelectorAll('.filter-btn');
        
        // Detail Modal Elements
        const detailsModal = document.getElementById('details-modal');
        const closeDetailsModalBtn = document.getElementById('close-details-modal-btn');
        const detailsModalTitle = document.getElementById('details-modal-title');
        const detailsSharesEl = document.getElementById('details-shares');
        const detailsBuyPriceEl = document.getElementById('details-buy-price');
        const detailsTotalCostEl = document.getElementById('details-total-cost');
        const detailsCurrentValueEl = document.getElementById('details-current-value');
        const detailsGainLossEl = document.getElementById('details-gain-loss');
        const priceChartCtx = document.getElementById('price-chart').getContext('2d');
        const detailsTransactionsList = document.getElementById('details-transactions-list');
        const emptyDetailsTransactionsState = document.getElementById('empty-details-transactions-state');
        
        // Transaction Form Elements
        const modalTitle = document.getElementById('modal-title');
        const transactionIdInput = document.getElementById('transaction-id');
        const transactionDateInput = document.getElementById('transaction-date');
        const typeBuyBtn = document.getElementById('type-buy-btn');
        const typeSellBtn = document.getElementById('type-sell-btn');
        const buyPriceGroup = document.getElementById('buy-price-group');
        const sellPriceGroup = document.getElementById('sell-price-group');
        const tickerInput = document.getElementById('ticker');
        const sharesInput = document.getElementById('shares');
        const buyPriceInput = document.getElementById('buy-price');
        const sellPriceInput = document.getElementById('sell-price');
        const marketSelect = document.getElementById('market');
        const assetTypeSelect = document.getElementById('asset-type');
        
        // --- Firebase Functions ---
        const getCollectionRef = () => {
            if (!userId) return null;
            // IMPORTANT: Use the /artifacts/{appId}/users/{userId}/... structure for private data
            const collectionPath = `/artifacts/${appId}/users/${userId}/transactions`;
            return collection(db, collectionPath);
        };
        
        const listenForTransactions = () => {
            if (unsubscribe) {
                unsubscribe();
            }
            const collectionRef = getCollectionRef();
            if (!collectionRef) {
                console.error("Collection reference is null, cannot listen for updates.");
                return;
            }
            unsubscribe = onSnapshot(collectionRef, (querySnapshot) => {
                const transactions = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    transactions.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp.toDate() // Convert Firestore Timestamp to JS Date
                    });
                });
                transactionsData = transactions;
                groupedHoldings = groupHoldingsByTicker(transactionsData);
                renderAllViews();
            }, (error) => {
                console.error("Error fetching transactions:", error);
            });
        };
        
        const addTransaction = async (transaction) => {
            const collectionRef = getCollectionRef();
            if (!collectionRef) {
                console.error("Not authenticated, cannot add transaction.");
                return;
            }
            await addDoc(collectionRef, transaction);
        };

        const updateTransaction = async (id, updatedTransaction) => {
            const collectionRef = getCollectionRef();
            const docRef = doc(collectionRef, id);
            await setDoc(docRef, updatedTransaction, { merge: true });
        };

        const deleteTransaction = async (id) => {
            const collectionRef = getCollectionRef();
            const docRef = doc(collectionRef, id);
            await deleteDoc(docRef);
        };

        const deleteUserTransactions = async () => {
            const collectionRef = getCollectionRef();
            if (!collectionRef) {
                console.error("Not authenticated, cannot delete data.");
                return;
            }
            showLoading();
            const batch = writeBatch(db);
            const querySnapshot = await getDocs(collectionRef);
            querySnapshot.forEach(d => {
                batch.delete(d.ref);
            });
            await batch.commit();
            hideLoading();
            showMessageBox("Your data has been successfully deleted.");
        };

        // --- Helper Functions ---
        const showLoading = () => loadingSpinner.classList.remove('hidden');
        const hideLoading = () => loadingSpinner.classList.add('hidden');
        const showAuthModal = () => authModal.classList.remove('hidden');
        const hideAuthModal = () => authModal.classList.add('hidden');
        const showAppContainer = () => appContainer.classList.remove('hidden');
        const hideAppContainer = () => appContainer.classList.add('hidden');
        const showInvestmentModal = () => investmentModal.classList.remove('hidden');
        const hideInvestmentModal = () => investmentModal.classList.add('hidden');
        const showDetailsModal = () => detailsModal.classList.remove('hidden');
        const hideDetailsModal = () => detailsModal.classList.add('hidden');
        const showAiModal = () => aiResponseModal.classList.remove('hidden');
        const hideAiModal = () => aiResponseModal.classList.add('hidden');

        const formatCurrency = (value) => {
            const formatter = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            });
            return formatter.format(value);
        };

        const showMessageBox = (message, isConfirm = false, onConfirm = () => {}) => {
            messageBoxText.textContent = message;
            messageBoxActions.innerHTML = '';
            
            const okBtn = document.createElement('button');
            okBtn.textContent = 'OK';
            okBtn.className = 'bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors duration-200';
            okBtn.onclick = () => messageBox.classList.add('hidden');
            messageBoxActions.appendChild(okBtn);

            if (isConfirm) {
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Cancel';
                cancelBtn.className = 'bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-300 transition-colors duration-200';
                cancelBtn.onclick = () => messageBox.classList.add('hidden');
                messageBoxActions.prepend(cancelBtn);

                okBtn.onclick = () => {
                    onConfirm();
                    messageBox.classList.add('hidden');
                };
            }
            messageBox.classList.remove('hidden');
        };

        const calculateCurrentPrice = (avgPrice) => {
            // This is a simple mock function. In a real app, you would fetch this from a live API.
            const volatility = 0.1; // 10% volatility
            const randomFactor = (Math.random() - 0.5) * 2 * volatility;
            return avgPrice * (1 + randomFactor);
        };

        const groupHoldingsByTicker = (transactions) => {
            const holdings = {};
            transactions.sort((a, b) => a.timestamp - b.timestamp);

            transactions.forEach(tx => {
                const ticker = tx.ticker.toUpperCase();
                if (!holdings[ticker]) {
                    holdings[ticker] = {
                        ticker: ticker,
                        market: tx.market,
                        assetType: tx.assetType,
                        totalShares: 0,
                        totalCost: 0,
                        buyTransactions: [],
                        sellTransactions: [],
                        cashFlows: []
                    };
                }

                holdings[ticker].cashFlows.push({
                    date: tx.timestamp,
                    amount: (tx.type === 'Buy' ? -1 : 1) * (tx.shares * (tx.price || tx.buyPrice || tx.sellPrice))
                });
                
                if (tx.type === 'Buy') {
                    holdings[ticker].totalShares += tx.shares;
                    holdings[ticker].totalCost += tx.shares * tx.price;
                    holdings[ticker].buyTransactions.push(tx);
                } else if (tx.type === 'Sell') {
                    holdings[ticker].totalShares -= tx.shares;
                    // Adjust totalCost on sell. This is a simple approximation.
                    const avgCost = holdings[ticker].totalCost / (holdings[ticker].totalShares + tx.shares);
                    holdings[ticker].totalCost -= tx.shares * avgCost;
                    holdings[ticker].sellTransactions.push(tx);
                }
            });

            // Calculate average price and remove tickers with zero shares
            const filteredHoldings = {};
            for (const ticker in holdings) {
                if (holdings[ticker].totalShares > 0) {
                    const holding = holdings[ticker];
                    holding.avgPrice = holding.totalCost / holding.totalShares;
                    holding.currentPrice = calculateCurrentPrice(holding.avgPrice);
                    holding.currentValue = holding.totalShares * holding.currentPrice;
                    holding.gainLoss = holding.currentValue - holding.totalCost;
                    filteredHoldings[ticker] = holding;
                }
            }
            return filteredHoldings;
        };

        const calculateTWR = (transactions) => {
            if (transactions.length === 0) return 0;

            let twr = 1;
            let timePeriods = [];
            
            // Sort transactions by date
            const sortedTransactions = [...transactions].sort((a, b) => a.timestamp - b.timestamp);

            let lastDate = sortedTransactions[0].timestamp;
            let portfolioValue = 0;
            
            // Initial investment
            if (sortedTransactions[0].type === 'Buy') {
                 portfolioValue += sortedTransactions[0].shares * sortedTransactions[0].price;
            }

            for (let i = 1; i < sortedTransactions.length; i++) {
                const currentDate = sortedTransactions[i].timestamp;
                const tx = sortedTransactions[i];
                const daysPassed = (currentDate - lastDate) / (1000 * 60 * 60 * 24);

                // Assuming daily compounding for simplicity
                const returnRate = (calculateCurrentPrice(portfolioValue/1) / portfolioValue) - 1;
                twr *= (1 + returnRate);

                if (tx.type === 'Buy') {
                    portfolioValue += tx.shares * tx.price;
                } else if (tx.type === 'Sell') {
                    portfolioValue -= tx.shares * tx.price;
                }

                lastDate = currentDate;
            }

            // Final period calculation
            const finalValue = Object.values(groupedHoldings).reduce((sum, h) => sum + h.currentValue, 0);
            if (portfolioValue > 0) {
                 const finalReturn = (finalValue / portfolioValue) - 1;
                 twr *= (1 + finalReturn);
            }
           
            return (twr - 1) * 100;
        };
        
        const calculateMWR = (transactions) => {
            if (transactions.length === 0) return 0;
            const cashFlows = transactions.map(tx => ({
                date: tx.timestamp,
                amount: (tx.type === 'Buy' ? -1 : 1) * (tx.shares * tx.price)
            })).sort((a,b) => a.date - b.date);

            const finalValue = Object.values(groupedHoldings).reduce((sum, h) => sum + h.currentValue, 0);
            if (finalValue > 0) {
                cashFlows.push({ date: new Date(), amount: finalValue });
            }

            // Simplified IRR calculation, not precise but demonstrates the concept
            const irr = (rate) => {
                let npv = 0;
                const today = new Date();
                cashFlows.forEach(cf => {
                    const days = (today - cf.date) / (1000 * 60 * 60 * 24);
                    npv += cf.amount / Math.pow(1 + rate, days / 365);
                });
                return npv;
            };

            // Newton-Raphson method for finding IRR
            let rate = 0.1;
            for (let i = 0; i < 20; i++) {
                const npv = irr(rate);
                const derivative = (irr(rate + 0.0001) - npv) / 0.0001;
                rate = rate - npv / derivative;
            }
            return rate * 100;
        };

        const renderPortfolio = (holdings) => {
            investmentsList.innerHTML = '';
            const filteredHoldings = Object.values(holdings).filter(h => {
                if (currentFilter === 'all') return true;
                if (currentFilter === 'Stock' || currentFilter === 'ETF') return h.assetType === currentFilter;
                return h.market === currentFilter;
            });

            if (filteredHoldings.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                filteredHoldings.forEach(holding => {
                    const gainLoss = holding.currentValue - holding.totalCost;
                    const gainLossPct = (gainLoss / holding.totalCost) * 100;
                    const gainLossColor = gainLoss >= 0 ? 'text-green-600' : 'text-red-600';

                    const itemHtml = `
                        <div class="bg-gray-50 p-4 rounded-xl shadow border border-gray-100 flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">${holding.ticker} <span class="text-sm font-medium text-gray-500">(${holding.assetType})</span></h3>
                                <p class="text-sm text-gray-500">${holding.market}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-medium text-gray-700">Shares: ${holding.totalShares.toFixed(2)}</p>
                                <p class="text-sm font-medium text-gray-700">Value: ${formatCurrency(holding.currentValue)}</p>
                                <p class="font-bold ${gainLossColor}">${gainLoss >= 0 ? '+' : ''}${formatCurrency(gainLoss)} (${gainLossPct.toFixed(2)}%)</p>
                            </div>
                            <button class="details-btn bg-blue-500 text-white px-3 py-1 rounded-lg text-sm" data-ticker="${holding.ticker}">Details</button>
                        </div>
                    `;
                    investmentsList.innerHTML += itemHtml;
                });
            }
        };

        const renderTransactions = (transactions) => {
            transactionsList.innerHTML = '';
            if (transactions.length === 0) {
                emptyTransactionsState.classList.remove('hidden');
                return;
            }
            emptyTransactionsState.classList.add('hidden');

            transactions.sort((a, b) => b.timestamp - a.timestamp).forEach(tx => {
                const price = tx.price || tx.buyPrice || tx.sellPrice;
                const typeColor = tx.type === 'Buy' ? 'text-green-600' : 'text-red-600';
                const typeBg = tx.type === 'Buy' ? 'bg-green-100' : 'bg-red-100';
                const icon = tx.type === 'Buy' ? '&#x2B06;&#xFE0F;' : '&#x2B07;&#xFE0F;';
                const itemHtml = `
                    <div class="bg-gray-50 p-4 rounded-xl shadow border border-gray-100 flex justify-between items-center">
                        <div>
                            <p class="text-sm font-medium text-gray-500">${tx.timestamp.toLocaleDateString()}</p>
                            <h3 class="text-lg font-bold text-gray-800">${tx.ticker.toUpperCase()}</h3>
                            <p class="text-sm text-gray-700">${tx.shares} shares @ ${formatCurrency(price)}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-sm font-semibold ${typeColor} ${typeBg} px-2 py-1 rounded-full">${tx.type}</span>
                            <p class="text-lg font-bold text-gray-800">${formatCurrency(tx.shares * price)}</p>
                        </div>
                    </div>
                `;
                transactionsList.innerHTML += itemHtml;
            });
        };

        const renderDashboard = () => {
            const totalValue = Object.values(groupedHoldings).reduce((sum, h) => sum + h.currentValue, 0);
            const totalCost = Object.values(groupedHoldings).reduce((sum, h) => sum + h.totalCost, 0);
            const overallGainLoss = totalValue - totalCost;
            const overallGainLossPct = totalCost > 0 ? (overallGainLoss / totalCost) * 100 : 0;
            const gainLossColor = overallGainLoss >= 0 ? 'text-green-600' : 'text-red-600';

            totalValueEl.textContent = formatCurrency(totalValue);
            overallGainLossEl.textContent = `${overallGainLoss >= 0 ? '+' : ''}${formatCurrency(overallGainLoss)}`;
            overallGainLossEl.className = `text-4xl font-bold ${gainLossColor}`;
            overallGainLossPctEl.textContent = ` (${overallGainLossPct.toFixed(2)}%)`;
            overallGainLossPctEl.className = `${gainLossColor} text-sm font-medium`;

            const twr = calculateTWR(transactionsData);
            const mwr = calculateMWR(transactionsData);
            twrValueEl.textContent = `${twr.toFixed(2)}%`;
            mwrValueEl.textContent = `${mwr.toFixed(2)}%`;
            
            updateAllocationChart();
        };
        
        const renderAllViews = () => {
            renderDashboard();
            renderPortfolio(groupedHoldings);
            renderTransactions(transactionsData);
        };
        
        const updateAllocationChart = () => {
            const labels = Object.keys(groupedHoldings);
            const data = labels.map(ticker => groupedHoldings[ticker].currentValue);
            
            if (data.length === 0) {
                if (allocationChart) {
                    allocationChart.destroy();
                    allocationChart = null;
                }
                chartPlaceholder.classList.remove('hidden');
                document.getElementById('allocation-chart').classList.add('hidden');
                return;
            }

            chartPlaceholder.classList.add('hidden');
            document.getElementById('allocation-chart').classList.remove('hidden');

            const backgroundColors = [
                '#4f46e5', '#3b82f6', '#10b981', '#f59e0b', '#ef4444',
                '#6366f1', '#2563eb', '#059669', '#d97706', '#dc2626'
            ];

            const chartData = {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors,
                    hoverOffset: 4
                }]
            };

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                const total = tooltipItem.dataset.data.reduce((sum, val) => sum + val, 0);
                                const value = tooltipItem.raw;
                                const percentage = ((value / total) * 100).toFixed(2);
                                return `${tooltipItem.label}: ${formatCurrency(value)} (${percentage}%)`;
                            }
                        }
                    }
                }
            };
            
            if (allocationChart) {
                allocationChart.data = chartData;
                allocationChart.update();
            } else {
                allocationChart = new Chart(allocationChartCtx, {
                    type: 'doughnut',
                    data: chartData,
                    options: chartOptions,
                });
            }
        };

        const renderPriceChart = (ticker, transactions) => {
            if (priceChart) {
                priceChart.destroy();
            }
            
            const relevantTransactions = transactions.filter(tx => tx.ticker.toUpperCase() === ticker.toUpperCase()).sort((a, b) => a.timestamp - b.timestamp);
            
            let cumulativeShares = 0;
            let cumulativeCost = 0;
            
            const labels = [];
            const buyPrices = [];
            const currentPrices = [];
            const dataPoints = [];
            
            relevantTransactions.forEach(tx => {
                const price = tx.price || tx.buyPrice || tx.sellPrice;
                if (tx.type === 'Buy') {
                    cumulativeShares += tx.shares;
                    cumulativeCost += tx.shares * price;
                } else {
                    cumulativeShares -= tx.shares;
                    // For sell, re-calculate the cumulative cost based on average price
                    const avgCostBeforeSell = cumulativeCost / (cumulativeShares + tx.shares);
                    cumulativeCost -= tx.shares * avgCostBeforeSell;
                }

                dataPoints.push({
                    x: tx.timestamp.getTime(),
                    y: cumulativeCost / cumulativeShares || 0,
                    label: `Avg Cost: ${formatCurrency(cumulativeCost / cumulativeShares || 0)}`
                });
            });

            // Add the final data point for the current value
            const holding = groupedHoldings[ticker.toUpperCase()];
            if (holding) {
                dataPoints.push({
                    x: new Date().getTime(),
                    y: holding.currentPrice,
                    label: `Current Price: ${formatCurrency(holding.currentPrice)}`
                });
            }

            // Create the chart
            priceChart = new Chart(priceChartCtx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Average Buy Price',
                            data: dataPoints,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            fill: false,
                            tension: 0.1,
                            segment: {
                                borderColor: ctx => {
                                    const index = ctx.p0DataIndex;
                                    const nextIndex = ctx.p1DataIndex;
                                    const isPositive = dataPoints[nextIndex].y >= dataPoints[index].y;
                                    return isPositive ? 'rgba(16, 185, 129, 1)' : 'rgba(239, 68, 68, 1)';
                                },
                            }
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            ticks: {
                                source: 'data'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Price'
                            },
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: (tooltipItems) => new Date(tooltipItems[0].raw.x).toLocaleDateString(),
                                label: (tooltipItem) => tooltipItem.raw.label
                            }
                        }
                    }
                }
            });
        };
        
        const getAiInsights = async () => {
            const currentHoldings = Object.values(groupedHoldings);
            if (currentHoldings.length === 0) {
                showMessageBox("Please add some transactions to your portfolio before getting insights.");
                return;
            }

            const portfolioSummary = currentHoldings.map(h => ({
                ticker: h.ticker,
                market: h.market,
                assetType: h.assetType,
                shares: h.totalShares,
                avgPrice: h.avgPrice,
                currentPrice: h.currentPrice,
                gainLoss: h.gainLoss,
                gainLossPercentage: (h.gainLoss / h.totalCost) * 100
            }));
            
            const prompt = `Act as a world-class financial analyst. You are provided with a simplified JSON object representing a user's investment portfolio. Your task is to provide a concise, single-paragraph summary of the key findings. Do not include financial advice, but instead focus on the current state of the portfolio. Also, do not generate any code, tables, or lists. Just provide a single paragraph of text.
            \n\nPortfolio data: ${JSON.stringify(portfolioSummary)}`;

            aiResponseContent.innerHTML = `<div class="flex items-center justify-center"><div class="animate-spin rounded-full h-8 w-8 border-2 border-t-2 border-blue-500 border-opacity-75"></div></div>`;
            showAiModal();

            try {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: {
                        parts: [{ text: "Act as a world-class financial analyst. Provide a concise, single-paragraph summary of the key findings based on the provided data." }]
                    },
                };
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "No insights could be generated at this time.";
                
                aiResponseContent.innerHTML = `<p>${text}</p>`;

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                aiResponseContent.innerHTML = `<p class="text-red-600">Failed to generate insights. Please try again later.</p>`;
            }
        };

        // --- Event Listeners ---
        const setupListeners = () => {
            // Navigation
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    navItems.forEach(n => {
                        n.classList.remove('active-nav', 'active-nav-bg');
                        n.classList.add('text-gray-500');
                    });
                    item.classList.add('active-nav', 'active-nav-bg');
                    item.classList.remove('text-gray-500');
                    
                    const targetPageId = item.id.replace('nav-', '') + '-page';
                    pages.forEach(page => {
                        page.classList.add('hidden');
                        if (page.id === targetPageId) {
                            page.classList.remove('hidden');
                        }
                    });
                });
            });

            // Authentication
            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading();
                const email = authEmailInput.value;
                const password = authPasswordInput.value;
                const isSignUp = authModalTitle.textContent.includes('Sign up');
                try {
                    if (isSignUp) {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (error) {
                    console.error("Auth error:", error);
                    showMessageBox(error.message);
                } finally {
                    hideLoading();
                }
            });

            authToggleLink.addEventListener('click', () => {
                const isSignUp = authModalTitle.textContent.includes('Sign up');
                authModalTitle.textContent = isSignUp ? 'Sign in' : 'Sign up';
                authSubmitBtn.textContent = isSignUp ? 'Sign in' : 'Sign up';
                authToggleLink.innerHTML = isSignUp ? `Don't have an account? <span class="font-medium text-indigo-600 hover:text-indigo-800">Sign up</span>` : `Already have an account? <span class="font-medium text-indigo-600 hover:text-indigo-800">Sign in</span>`;
            });

            logoutBtn.addEventListener('click', async () => {
                await signOut(auth);
                showMessageBox("You have been logged out.");
            });

            // Transaction Form Modal
            addInvestmentBtn.addEventListener('click', () => {
                modalTitle.textContent = 'Add New Transaction';
                investmentForm.reset();
                buyPriceGroup.classList.remove('hidden');
                sellPriceGroup.classList.add('hidden');
                currentTxType = 'Buy';
                typeBuyBtn.className = 'flex-1 py-2 rounded-lg font-medium shadow-sm transition-colors duration-200 bg-indigo-600 text-white';
                typeSellBtn.className = 'flex-1 py-2 rounded-lg font-medium shadow-sm transition-colors duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300';
                transactionIdInput.value = '';
                showInvestmentModal();
            });

            closeModalBtn.addEventListener('click', () => hideInvestmentModal());

            typeBuyBtn.addEventListener('click', () => {
                currentTxType = 'Buy';
                buyPriceGroup.classList.remove('hidden');
                sellPriceGroup.classList.add('hidden');
                typeBuyBtn.className = 'flex-1 py-2 rounded-lg font-medium shadow-sm transition-colors duration-200 bg-indigo-600 text-white';
                typeSellBtn.className = 'flex-1 py-2 rounded-lg font-medium shadow-sm transition-colors duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300';
            });

            typeSellBtn.addEventListener('click', () => {
                currentTxType = 'Sell';
                buyPriceGroup.classList.add('hidden');
                sellPriceGroup.classList.remove('hidden');
                typeSellBtn.className = 'flex-1 py-2 rounded-lg font-medium shadow-sm transition-colors duration-200 bg-indigo-600 text-white';
                typeBuyBtn.className = 'flex-1 py-2 rounded-lg font-medium shadow-sm transition-colors duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300';
            });
            
            investmentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading();
                const newTransaction = {
                    date: transactionDateInput.value,
                    type: currentTxType,
                    market: marketSelect.value,
                    assetType: assetTypeSelect.value,
                    ticker: tickerInput.value.toUpperCase(),
                    shares: parseFloat(sharesInput.value),
                    price: currentTxType === 'Buy' ? parseFloat(buyPriceInput.value) : parseFloat(sellPriceInput.value),
                    timestamp: Timestamp.fromDate(new Date(transactionDateInput.value))
                };
                try {
                    if (transactionIdInput.value) {
                        await updateTransaction(transactionIdInput.value, newTransaction);
                        showMessageBox("Transaction updated successfully!");
                    } else {
                        await addTransaction(newTransaction);
                        showMessageBox("Transaction added successfully!");
                    }
                } catch (error) {
                    console.error("Error saving transaction:", error);
                    showMessageBox("Failed to save transaction.");
                } finally {
                    hideLoading();
                    hideInvestmentModal();
                }
            });

            // Details Modal
            investmentsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('details-btn')) {
                    const ticker = e.target.dataset.ticker;
                    currentInvestment = groupedHoldings[ticker.toUpperCase()];
                    if (!currentInvestment) return;
                    
                    detailsModalTitle.textContent = `${ticker.toUpperCase()} (${currentInvestment.assetType}) Details`;
                    detailsSharesEl.textContent = currentInvestment.totalShares.toFixed(2);
                    detailsBuyPriceEl.textContent = formatCurrency(currentInvestment.avgPrice);
                    detailsTotalCostEl.textContent = formatCurrency(currentInvestment.totalCost);
                    detailsCurrentValueEl.textContent = formatCurrency(currentInvestment.currentValue);
                    
                    const gainLossColor = currentInvestment.gainLoss >= 0 ? 'text-green-600' : 'text-red-600';
                    const gainLossText = `${currentInvestment.gainLoss >= 0 ? '+' : ''}${formatCurrency(currentInvestment.gainLoss)} (${((currentInvestment.gainLoss / currentInvestment.totalCost) * 100).toFixed(2)}%)`;
                    detailsGainLossEl.textContent = gainLossText;
                    detailsGainLossEl.className = `text-lg font-bold ${gainLossColor}`;
                    
                    // Render specific transactions for this ticker
                    renderDetailsTransactions(ticker);
                    renderPriceChart(ticker, transactionsData);
                    
                    showDetailsModal();
                }
            });

            const renderDetailsTransactions = (ticker) => {
                detailsTransactionsList.innerHTML = '';
                const txns = transactionsData.filter(tx => tx.ticker.toUpperCase() === ticker.toUpperCase()).sort((a, b) => b.timestamp - a.timestamp);
                
                if (txns.length === 0) {
                    emptyDetailsTransactionsState.classList.remove('hidden');
                    return;
                }
                emptyDetailsTransactionsState.classList.add('hidden');
                
                txns.forEach(tx => {
                    const price = tx.price || tx.buyPrice || tx.sellPrice;
                    const itemHtml = `
                        <div class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm">
                            <div>
                                <p class="text-sm font-medium text-gray-500">${new Date(tx.timestamp).toLocaleDateString()}</p>
                                <p class="font-semibold text-gray-800">${tx.type} ${tx.shares} shares @ ${formatCurrency(price)}</p>
                            </div>
                        </div>
                    `;
                    detailsTransactionsList.innerHTML += itemHtml;
                });
            };

            closeDetailsModalBtn.addEventListener('click', () => hideDetailsModal());

            // Delete User Data
            deleteDataBtn.addEventListener('click', () => {
                showMessageBox("Are you sure you want to delete all your portfolio data? This cannot be undone.", true, deleteUserTransactions);
            });
            
            // AI Insights
            getAiInsightsBtn.addEventListener('click', getAiInsights);
            closeAiModalBtn.addEventListener('click', () => hideAiModal());
            
            // Filter buttons
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterBtns.forEach(f => f.classList.remove('bg-indigo-200', 'text-indigo-800', 'font-semibold'));
                    btn.classList.add('bg-indigo-200', 'text-indigo-800', 'font-semibold');
                    currentFilter = btn.dataset.filter;
                    renderPortfolio(groupedHoldings);
                });
            });
        };

        // --- Main App Initialization Logic ---
        const initializeApp = async () => {
            showLoading();
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User: ${userId}`;
                        profileUserIdDisplay.textContent = userId;
                        hideAuthModal();
                        showAppContainer();
                        listenForTransactions();
                    } else {
                        userId = null;
                        userIdDisplay.textContent = 'Not signed in';
                        profileUserIdDisplay.textContent = 'Not authenticated';
                        hideAppContainer();
                        showAuthModal();
                        if (unsubscribe) {
                            unsubscribe();
                        }
                    }
                    hideLoading();
                });
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessageBox("Failed to initialize the app. Please check your configuration.");
                hideLoading();
            }
        };

        // Call the main initialization function
        window.onload = initializeApp;
        setupListeners();

    </script>
</body>
</html>
