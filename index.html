import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from 'firebase/auth';
import { getFirestore, doc, onSnapshot, collection, query } from 'firebase/firestore';

// Define the global Firebase variables. These will be provided by the environment.
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Enable debug logging for Firestore
import { setLogLevel } from 'firebase/firestore';
setLogLevel('debug');

function App() {
  // State to manage the user object, loading status, and application data
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [data, setData] = useState([]);

  // useEffect to handle Firebase authentication and data loading
  useEffect(() => {
    // This listener is crucial. It listens for changes in the user's sign-in state
    // and fires whenever the state changes (e.g., on initial load, login, logout).
    const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
      if (currentUser) {
        // A user is signed in. Set the user state and start loading app data.
        setUser(currentUser);

        // Define the collection path based on the user's UID.
        // This is a private collection only accessible by the authenticated user.
        const privateCollectionPath = `/artifacts/${appId}/users/${currentUser.uid}/my-private-data`;
        const q = query(collection(db, privateCollectionPath));

        // Listen for real-time updates to the data.
        const unsubData = onSnapshot(q, (snapshot) => {
          const newData = [];
          snapshot.forEach((doc) => {
            newData.push({ id: doc.id, ...doc.data() });
          });
          setData(newData);
          setLoading(false); // Data is loaded, so we can stop showing the loading screen.
        }, (error) => {
          console.error("Error fetching data:", error);
          setLoading(false);
        });

        // Cleanup the data listener when the component unmounts or user logs out
        return () => unsubData();

      } else {
        // No user is signed in. The initial check is complete.
        setUser(null);
        setLoading(false);
      }
    });

    // Clean up the auth state listener on component unmount
    return () => unsubscribe();
  }, []);

  // Function to handle the sign-in process
  const handleSignIn = async () => {
    try {
      setLoading(true);
      // Try to sign in with the custom token if available, otherwise sign in anonymously.
      if (initialAuthToken) {
        await signInWithCustomToken(auth, initialAuthToken);
      } else {
        await signInAnonymously(auth);
      }
    } catch (error) {
      console.error("Error signing in:", error);
      setLoading(false);
    }
  };

  // Render the appropriate UI based on the app's state
  if (loading) {
    // Show a loading screen while the authentication state is being determined.
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100 dark:bg-gray-900">
        <div className="text-xl font-semibold text-gray-700 dark:text-gray-300">
          Loading...
        </div>
      </div>
    );
  }

  if (!user) {
    // If there's no user, show a sign-in screen.
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100 dark:bg-gray-900">
        <div className="p-8 max-w-sm w-full bg-white dark:bg-gray-800 rounded-lg shadow-xl text-center">
          <h1 className="text-2xl font-bold text-gray-800 dark:text-white mb-4">
            Welcome!
          </h1>
          <p className="text-gray-600 dark:text-gray-400 mb-6">
            Please sign in to view the content.
          </p>
          <button
            onClick={handleSignIn}
            className="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-200"
          >
            Sign In to Continue
          </button>
        </div>
      </div>
    );
  }

  // If a user is signed in, show the main application content.
  return (
    <div className="min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 p-8">
      <div className="max-w-4xl mx-auto">
        <h1 className="text-3xl font-bold text-center mb-4">
          Welcome to the App, User!
        </h1>
        <p className="text-center text-lg mb-6 text-gray-600 dark:text-gray-400">
          You are authenticated. Your User ID is: <span className="font-mono text-sm break-all">{user.uid}</span>
        </p>

        {/* This is where your main app content would go */}
        <div className="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
          <h2 className="text-2xl font-semibold mb-4">Your Private Data</h2>
          {data.length > 0 ? (
            <ul>
              {data.map((item) => (
                <li key={item.id} className="p-2 border-b last:border-b-0 border-gray-200 dark:border-gray-700">
                  <pre className="text-sm overflow-x-auto whitespace-pre-wrap">{JSON.stringify(item, null, 2)}</pre>
                </li>
              ))}
            </ul>
          ) : (
            <p className="text-center text-gray-500">
              No data found. Add some content!
            </p>
          )}
        </div>
      </div>
    </div>
  );
}

// Ensure the App component is the default export
export default App;
