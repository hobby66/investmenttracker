<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 900px;
            margin: auto;
        }
        .active-nav {
            color: #4f46e5;
        }
        .active-nav-bg {
            background-color: #eef2ff;
        }
        .delete-btn {
            background-color: #fca5a5;
            color: #991b1b;
        }
        .delete-btn:hover {
            background-color: #f87171;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <div id="loading-spinner" class="fixed inset-0 bg-gray-200 bg-opacity-75 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-blue-500 border-opacity-75"></div>
    </div>
    
    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h3 id="auth-modal-title" class="text-2xl font-bold text-center mb-6 text-gray-800">Sign in</h3>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="auth-email" class="block text-sm font-medium text-gray-700">Email address</label>
                    <input type="email" id="auth-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="auth-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="auth-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <button type="submit" id="auth-submit-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors duration-200">Sign in</button>
            </form>
            <p id="auth-toggle-link" class="text-center text-sm mt-4 text-gray-600 cursor-pointer">
                Don't have an account? <span class="font-medium text-indigo-600 hover:text-indigo-800">Sign up</span>
            </p>
        </div>
    </div>

    <div id="app-container" class="container bg-white rounded-xl shadow-lg m-4 p-6 flex-grow relative hidden">

        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">My Portfolio</h1>
            <div class="flex items-center space-x-2">
                <div class="flex items-center space-x-2 bg-gray-50 text-gray-600 px-3 py-1 rounded-full text-sm">
                    <span id="user-id-display" class="truncate">Authenticating...</span>
                </div>
                <button id="logout-btn" class="text-sm text-red-500 hover:text-red-700 transition-colors duration-200 font-medium">Log out</button>
            </div>
        </header>

        <div id="content-area" class="pb-24">
            <div id="dashboard-page" class="page">
                <section class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-indigo-50 p-6 rounded-xl shadow-inner border border-indigo-200">
                        <h2 class="text-lg text-indigo-800 font-semibold mb-2">Total Portfolio Value</h2>
                        <p id="total-value" class="text-4xl font-bold text-indigo-600">$0.00</p>
                    </div>
                    <div class="bg-green-50 p-6 rounded-xl shadow-inner border border-green-200">
                        <h2 class="text-lg text-green-800 font-semibold mb-2">Overall Gain/Loss</h2>
                        <p id="overall-gain-loss" class="text-4xl font-bold text-green-600">$0.00</p>
                        <span id="overall-gain-loss-pct" class="text-green-500 text-sm font-medium"> (0.00%)</span>
                    </div>
                </section>
                
                <section class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-blue-50 p-6 rounded-xl shadow-inner border border-blue-200">
                        <h2 class="text-lg text-blue-800 font-semibold mb-2">Time-Weighted Return (TWR)</h2>
                        <p id="twr-value" class="text-4xl font-bold text-blue-600">0.00%</p>
                        <p class="text-xs text-gray-500 mt-2">A measure of compound growth, unaffected by deposits/withdrawals.</p>
                    </div>
                    <div class="bg-blue-50 p-6 rounded-xl shadow-inner border border-blue-200">
                        <h2 class="text-lg text-blue-800 font-semibold mb-2">Money-Weighted Return (MWR)</h2>
                        <p id="mwr-value" class="text-4xl font-bold text-blue-600">0.00%</p>
                        <p class="text-xs text-gray-500 mt-2">The return rate that accounts for timing of cash flows.</p>
                    </div>
                </section>

                <section class="bg-white p-6 rounded-xl shadow border border-gray-100 mb-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Asset Allocation</h2>
                    <div class="w-full h-64 flex items-center justify-center">
                        <p id="chart-placeholder" class="text-gray-400">Add a transaction to see your asset allocation here.</p>
                        <canvas id="allocation-chart" class="w-full h-full hidden"></canvas>
                    </div>
                </section>

                <section class="flex justify-center">
                    <button id="get-ai-insights-btn" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-medium shadow-md hover:bg-purple-700 transition-colors duration-200">
                        Get AI Portfolio Summary âœ¨
                    </button>
                </section>
            </div>

            <div id="portfolio-page" class="page hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">My Investments</h2>
                    <button id="add-investment-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium shadow hover:bg-blue-700 transition-colors duration-200">
                        + Add New
                    </button>
                </div>
                <div class="flex items-center space-x-2 mb-4">
                    <span class="text-sm font-medium text-gray-700">Filter By:</span>
                    <button data-filter="all" class="filter-btn text-sm px-3 py-1 rounded-full bg-indigo-200 text-indigo-800 font-semibold">All</button>
                    <button data-filter="US" class="filter-btn text-sm px-3 py-1 rounded-full bg-gray-200 text-gray-700">US</button>
                    <button data-filter="Malaysia" class="filter-btn text-sm px-3 py-1 rounded-full bg-gray-200 text-gray-700">Malaysia</button>
                    <button data-filter="Stock" class="filter-btn text-sm px-3 py-1 rounded-full bg-gray-200 text-gray-700">Stocks</button>
                    <button data-filter="ETF" class="filter-btn text-sm px-3 py-1 rounded-full bg-gray-200 text-gray-700">ETFs</button>
                </div>
                <div id="investments-list" class="space-y-4">
                    </div>
                <div id="empty-state" class="text-center text-gray-400 mt-8 hidden">
                    <p class="mb-2">You don't have any investments yet.</p>
                    <p>Click "Add New" to get started!</p>
                </div>
            </div>

            <div id="transactions-page" class="page hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Transaction History</h2>
                <div id="transactions-list" class="space-y-4">
                    </div>
                <div id="empty-transactions-state" class="text-center text-gray-400 mt-8 hidden">
                    <p class="mb-2">No transactions recorded.</p>
                </div>
            </div>

            <div id="markets-page" class="page hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Global Markets</h2>
                <div class="bg-gray-50 p-6 rounded-xl shadow-inner text-center text-gray-400">
                    <p>This section would display live market data, news, and indices.</p>
                    <p>This is a placeholder as real-time market data requires a separate API integration.</p>
                </div>
            </div>

            <div id="profile-page" class="page hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Profile & Settings</h2>
                <div class="bg-gray-50 p-6 rounded-xl shadow-inner">
                    <p class="font-medium text-gray-700 mb-2">Your User ID:</p>
                    <p id="profile-user-id" class="text-sm font-mono break-all text-gray-500">Not available in demo mode</p>
                </div>
                <div class="mt-6 bg-red-50 p-6 rounded-xl shadow-inner border border-red-200">
                    <h3 class="text-lg font-semibold text-red-800 mb-2">Danger Zone</h3>
                    <p class="text-sm text-red-700 mb-4">
                        This action will permanently delete all of your data from the app.
                    </p>
                    <button id="delete-data-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium shadow hover:bg-red-700 transition-colors duration-200">
                        Delete My Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="investment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800">Add New Transaction</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">&times;</button>
            </div>
            <form id="investment-form" class="space-y-4">
                <div>
                    <label for="transaction-date" class="block text-sm font-medium text-gray-700">Date</label>
                    <input type="date" id="transaction-date" name="transaction-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Transaction Type</label>
                    <div class="mt-1 flex space-x-2">
                        <button type="button" id="type-buy-btn" class="flex-1 py-2 rounded-lg font-medium shadow-sm transition-colors duration-200 bg-indigo-600 text-white">Buy</button>
                        <button type="button" id="type-sell-btn" class="flex-1 py-2 rounded-lg font-medium shadow-sm transition-colors duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300">Sell</button>
                    </div>
                </div>
                <div>
                    <label for="market" class="block text-sm font-medium text-gray-700">Market</label>
                    <select id="market" name="market" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="US">US</option>
                        <option value="Malaysia">Malaysia</option>
                    </select>
                </div>
                <div>
                    <label for="asset-type" class="block text-sm font-medium text-gray-700">Asset Type</label>
                    <select id="asset-type" name="asset-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="Stock">Stock</option>
                        <option value="ETF">ETF</option>
                    </select>
                </div>
                <div>
                    <label for="ticker" class="block text-sm font-medium text-gray-700">Ticker Symbol</label>
                    <input type="text" id="ticker" name="ticker" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="shares" class="block text-sm font-medium text-gray-700">Number of Shares</label>
                    <input type="number" id="shares" name="shares" required min="0.01" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div id="buy-price-group" class="price-group">
                    <label for="buy-price" class="block text-sm font-medium text-gray-700">Buy Price (USD/MYR)</label>
                    <input type="number" id="buy-price" name="buy-price" required min="0.01" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div id="sell-price-group" class="price-group hidden">
                    <label for="sell-price" class="block text-sm font-medium text-gray-700">Sell Price (USD/MYR)</label>
                    <input type="number" id="sell-price" name="sell-price" required min="0.01" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <input type="hidden" id="transaction-id">
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors duration-200 mt-4">Save Transaction</button>
            </form>
        </div>
    </div>

    <div id="details-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 id="details-modal-title" class="text-xl font-bold text-gray-800"></h3>
                <button id="close-details-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">&times;</button>
            </div>
            <div class="space-y-4">
                <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                    <h4 class="font-semibold text-gray-700 mb-2">Price History (Simulated)</h4>
                    <div class="w-full h-48">
                        <canvas id="price-chart"></canvas>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-500">Quantity Owned</p>
                        <p id="details-shares" class="text-lg font-bold text-gray-800"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-500">Average Buy Price</p>
                        <p id="details-buy-price" class="text-lg font-bold text-gray-800"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-500">Total Cost</p>
                        <p id="details-total-cost" class="text-lg font-bold text-gray-800"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-500">Current Market Value</p>
                        <p id="details-current-value" class="text-lg font-bold text-gray-800"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm col-span-2">
                        <p class="text-sm text-gray-500">Unrealized Gain/Loss</p>
                        <p id="details-gain-loss" class="text-lg font-bold text-gray-800"></p>
                    </div>
                </div>
                <div class="mt-6">
                    <h4 class="font-semibold text-xl text-gray-700 mb-2">Transaction History</h4>
                    <div id="details-transactions-list" class="space-y-4">
                        </div>
                    <div id="empty-details-transactions-state" class="text-center text-gray-400 mt-4 hidden">
                        <p>No transactions for this holding.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
            <p id="message-box-text" class="text-gray-800 text-lg mb-4"></p>
            <div id="message-box-actions" class="flex justify-center space-x-4">
                <button id="message-box-ok-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors duration-200">OK</button>
            </div>
        </div>
    </div>

    <div id="ai-response-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 id="ai-modal-title" class="text-xl font-bold text-gray-800">AI Insights</h3>
                <button id="close-ai-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">&times;</button>
            </div>
            <div id="ai-response-content" class="text-gray-700 prose max-w-none">
                <div class="flex items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-2 border-t-2 border-blue-500 border-opacity-75"></div>
                </div>
            </div>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-2xl border-t border-gray-200 z-30">
        <ul class="flex justify-around items-center h-16 text-gray-500 text-sm">
            <li>
                <button id="nav-dashboard" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200 active-nav-bg active-nav">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <span class="mt-1">Dashboard</span>
                </button>
            </li>
            <li>
                <button id="nav-portfolio" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-2v2m-4-2v2m4-2h.01M12 18a6 6 0 100-12 6 6 0 000 12z" />
                    </svg>
                    <span class="mt-1">Portfolio</span>
                </button>
            </li>
            <li>
                <button id="nav-transactions" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="mt-1">Transactions</span>
                </button>
            </li>
            <li>
                <button id="nav-markets" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8L11 20" />
                    </svg>
                    <span class="mt-1">Markets</span>
                </button>
            </li>
            <li>
                <button id="nav-profile" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span class="mt-1">Profile</span>
                </button>
            </li>
        </ul>
    </nav>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, setLogLevel, getDocs, writeBatch, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { Chart, DoughnutController, ArcElement, LineController, CategoryScale, LinearScale, PointElement, LineElement, Tooltip, Legend } from 'https://cdn.jsdelivr.net/npm/chart.js@4.4.3/+esm';
        
        // Register Chart.js components
        Chart.register(DoughnutController, ArcElement, LineController, CategoryScale, LinearScale, PointElement, LineElement, Tooltip, Legend);
        
        // --- Firebase & App State Initialization ---
        let app, db, auth, userId, unsubscribe;
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
			  apiKey: "AIzaSyBUkADc0TTBrM0STMhTLzA6htyYgiOdsro",
			  authDomain: "investmenttracker-af126.firebaseapp.com",
			  projectId: "investmenttracker-af126",
			  storageBucket: "investmenttracker-af126.firebasestorage.app",
			  messagingSenderId: "782078886994",
			  appId: "1:782078886994:web:8d02aed4ddd2f62b198b8b",
			  measurementId: "G-NVNMZPPC3H"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // API key for the Gemini API call
        const geminiApiKey = "AIzaSyAHGq7UzAoGV6nkQl3Qk10bxRx8M7ASaKc";
        const geminiApiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + geminiApiKey;

        // API key for fetching stock prices
        const fmpApiKey = "VDgI5E3y6nTv7kwKqPMZEmctvmCyEBQk";
        const fmpApiUrl = "https://financialmodelingprep.com/api/v3/quote-short/";
        
        // Set log level to debug for now
        setLogLevel('debug');
        
        let transactionsData = [];
        let groupedHoldings = {};
        let allocationChart = null;
        let priceChart = null;
        let currentFilter = 'all';
        let currentTxType = 'Buy';
        let currentInvestment = null; // Store the currently viewed investment for the details modal

        // --- DOM Elements ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const appContainer = document.getElementById('app-container');
        const authModal = document.getElementById('auth-modal');
        const authModalTitle = document.getElementById('auth-modal-title');
        const authForm = document.getElementById('auth-form');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authToggleLink = document.getElementById('auth-toggle-link');
        const logoutBtn = document.getElementById('logout-btn');
        const userIdDisplay = document.getElementById('user-id-display');
        const profileUserIdDisplay = document.getElementById('profile-user-id');
        const navItems = document.querySelectorAll('.nav-item');
        const pages = document.querySelectorAll('.page');
        const addInvestmentBtn = document.getElementById('add-investment-btn');
        const investmentModal = document.getElementById('investment-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const investmentForm = document.getElementById('investment-form');
        const investmentsList = document.getElementById('investments-list');
        const emptyState = document.getElementById('empty-state');
        const totalValueEl = document.getElementById('total-value');
        const overallGainLossEl = document.getElementById('overall-gain-loss');
        const overallGainLossPctEl = document.getElementById('overall-gain-loss-pct');
        const twrValueEl = document.getElementById('twr-value');
        const mwrValueEl = document.getElementById('mwr-value');
        const transactionsList = document.getElementById('transactions-list');
        const emptyTransactionsState = document.getElementById('empty-transactions-state');
        const deleteDataBtn = document.getElementById('delete-data-btn');
        const messageBox = document.getElementById('message-box');
        const messageBoxText = document.getElementById('message-box-text');
        const messageBoxActions = document.getElementById('message-box-actions');
        const allocationChartCtx = document.getElementById('allocation-chart').getContext('2d');
        const chartPlaceholder = document.getElementById('chart-placeholder');
        const getAiInsightsBtn = document.getElementById('get-ai-insights-btn');
        const aiResponseModal = document.getElementById('ai-response-modal');
        const closeAiModalBtn = document.getElementById('close-ai-modal-btn');
        const aiModalTitle = document.getElementById('ai-modal-title');
        const aiResponseContent = document.getElementById('ai-response-content');
        const filterBtns = document.querySelectorAll('.filter-btn');
        
        // Detail Modal Elements
        const detailsModal = document.getElementById('details-modal');
        const closeDetailsModalBtn = document.getElementById('close-details-modal-btn');
        const detailsModalTitle = document.getElementById('details-modal-title');
        const detailsSharesEl = document.getElementById('details-shares');
        const detailsBuyPriceEl = document.getElementById('details-buy-price');
        const detailsTotalCostEl = document.getElementById('details-total-cost');
        const detailsCurrentValueEl = document.getElementById('details-current-value');
        const detailsGainLossEl = document.getElementById('details-gain-loss');
        const priceChartCtx = document.getElementById('price-chart').getContext('2d');
        const detailsTransactionsList = document.getElementById('details-transactions-list');
        const emptyDetailsTransactionsState = document.getElementById('empty-details-transactions-state');
        
        // Transaction Form Elements
        const modalTitle = document.getElementById('modal-title');
        const transactionIdInput = document.getElementById('transaction-id');
        const transactionDateInput = document.getElementById('transaction-date');
        const typeBuyBtn = document.getElementById('type-buy-btn');
        const typeSellBtn = document.getElementById('type-sell-btn');
        const buyPriceGroup = document.getElementById('buy-price-group');
        const sellPriceGroup = document.getElementById('sell-price-group');
        const tickerInput = document.getElementById('ticker');
        const sharesInput = document.getElementById('shares');
        const buyPriceInput = document.getElementById('buy-price');
        const sellPriceInput = document.getElementById('sell-price');
        const marketSelect = document.getElementById('market');
        const assetTypeSelect = document.getElementById('asset-type');
        
        // --- Firebase Functions ---
        const getCollectionRef = () => {
            if (!userId) return null;
            // IMPORTANT: Use the /artifacts/{appId}/users/{userId}/... structure for private data
            const collectionPath = `/artifacts/${appId}/users/${userId}/transactions`;
            return collection(db, collectionPath);
        };
        
        const listenForTransactions = () => {
            if (unsubscribe) {
                unsubscribe();
            }
            const collectionRef = getCollectionRef();
            if (!collectionRef) {
                console.error("Collection reference is null, cannot listen for updates.");
                return;
            }
            unsubscribe = onSnapshot(collectionRef, (querySnapshot) => {
                const transactions = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    transactions.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp.toDate() // Convert Firestore Timestamp to JS Date
                    });
                });
                transactionsData = transactions;
                // Since this is now an async operation, we need to handle it properly
                groupHoldingsAndRender();
            }, (error) => {
                console.error("Error fetching transactions:", error);
            });
        };

        // --- AUTHENTICATION FLOW ---
        // New section to handle the primary authentication logic on app load
        
        initializeApp(firebaseConfig);
        auth = getAuth();
        db = getFirestore();

        onAuthStateChanged(auth, (user) => {
            // Hide the loading spinner immediately
            loadingSpinner.classList.add('hidden');

            if (user) {
                // User is signed in
                userId = user.uid;
                userIdDisplay.textContent = user.email || 'Anonymous';
                profileUserIdDisplay.textContent = user.uid;
                appContainer.classList.remove('hidden'); // Show the main app container
                authModal.classList.add('hidden'); // Hide the authentication modal
                listenForTransactions(); // Start listening for the user's data
            } else {
                // User is signed out
                userId = null;
                userIdDisplay.textContent = 'Not signed in';
                profileUserIdDisplay.textContent = 'Not signed in';
                appContainer.classList.add('hidden'); // Hide the main app container
                authModal.classList.remove('hidden'); // Show the authentication modal
                // Stop listening for data from a previous user
                if (unsubscribe) {
                    unsubscribe();
                }
            }
        });
        
        // --- End of new authentication flow section ---
        
        const addTransaction = async (transaction) => {
            const collectionRef = getCollectionRef();
            if (!collectionRef) {
                console.error("Not authenticated, cannot add transaction.");
                return;
            }
            try {
                // Remove the 'id' field before adding to Firestore
                const transactionToSave = { ...transaction };
                delete transactionToSave.id;
                await addDoc(collectionRef, {
                    ...transactionToSave,
                    timestamp: Timestamp.fromDate(transaction.timestamp)
                });
                hideModal(investmentModal);
                showMessage('Transaction saved successfully!', 'success');
            } catch (error) {
                console.error("Error adding transaction:", error);
                showMessage('Error saving transaction. Please try again.', 'error');
            }
        };
        
        const updateTransaction = async (transaction) => {
            const collectionRef = getCollectionRef();
            if (!collectionRef) {
                console.error("Not authenticated, cannot update transaction.");
                return;
            }
            try {
                const docRef = doc(collectionRef, transaction.id);
                const transactionToSave = { ...transaction };
                delete transactionToSave.id; // Ensure the ID is not saved as a field
                await setDoc(docRef, {
                    ...transactionToSave,
                    timestamp: Timestamp.fromDate(transaction.timestamp)
                }, { merge: true });
                hideModal(investmentModal);
                showMessage('Transaction updated successfully!', 'success');
            } catch (error) {
                console.error("Error updating transaction:", error);
                showMessage('Error updating transaction. Please try again.', 'error');
            }
        };
        
        const deleteTransaction = async (transactionId) => {
            const collectionRef = getCollectionRef();
            if (!collectionRef) {
                console.error("Not authenticated, cannot delete transaction.");
                return;
            }
            try {
                const docRef = doc(collectionRef, transactionId);
                await deleteDoc(docRef);
                showMessage('Transaction deleted successfully!', 'success');
            } catch (error) {
                console.error("Error deleting transaction:", error);
                showMessage('Error deleting transaction. Please try again.', 'error');
            }
        };
        
        const deleteAllUserData = async () => {
            const collectionRef = getCollectionRef();
            if (!collectionRef) {
                console.error("Not authenticated, cannot delete data.");
                return;
            }
            try {
                const querySnapshot = await getDocs(collectionRef);
                const batch = writeBatch(db);
                querySnapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                showMessage('All your data has been deleted.', 'success');
                // Optional: Force a logout after data is deleted
                await signOut(auth);
            } catch (error) {
                console.error("Error deleting all data:", error);
                showMessage('Error deleting data. Please try again.', 'error');
            }
        };
        
        // --- UI & Rendering Functions ---
        
        // --- Start of FMP API Integration Changes ---
        const fetchStockPrice = async (ticker) => {
            try {
                const response = await fetch(`${fmpApiUrl}${ticker}?apikey=${fmpApiKey}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.length > 0) {
                    // FMP returns an array, we want the first object's price
                    return data[0].price;
                }
                return 0; // Return 0 if no price found
            } catch (error) {
                console.error(`Error fetching price for ${ticker}:`, error);
                return 0; // Return 0 on error
            }
        };

        const groupHoldingsAndRender = async () => {
            const holdings = {};
            const uniqueTickers = [...new Set(transactionsData.map(tx => tx.ticker))];
            
            const fetchPromises = uniqueTickers.map(async (ticker) => {
                const price = await fetchStockPrice(ticker);
                return { ticker, price };
            });
            
            const prices = await Promise.all(fetchPromises);
            const priceMap = new Map(prices.map(p => [p.ticker, p.price]));
            
            transactionsData.forEach(tx => {
                const ticker = tx.ticker;
                if (!holdings[ticker]) {
                    holdings[ticker] = {
                        ticker: ticker,
                        market: tx.market,
                        assetType: tx.assetType,
                        transactions: [],
                        totalShares: 0,
                        totalCost: 0,
                        averageBuyPrice: 0,
                        currentValue: 0,
                        currentPrice: priceMap.get(ticker) || 0 // Use the fetched price
                    };
                }
                holdings[ticker].transactions.push(tx);
                
                const price = tx.type === 'Buy' ? tx.buyPrice : tx.sellPrice;
                const shares = tx.shares;
                
                if (tx.type === 'Buy') {
                    holdings[ticker].totalShares += shares;
                    holdings[ticker].totalCost += shares * price;
                } else {
                    const averagePrice = holdings[ticker].totalCost / holdings[ticker].totalShares;
                    holdings[ticker].totalShares -= shares;
                    holdings[ticker].totalCost = holdings[ticker].totalShares * averagePrice;
                }
            });
            
            // Recalculate values based on new prices
            Object.values(holdings).forEach(holding => {
                holding.averageBuyPrice = holding.totalShares > 0 ? holding.totalCost / holding.totalShares : 0;
                holding.currentValue = holding.totalShares * holding.currentPrice;
            });
            
            groupedHoldings = holdings;
            renderAllViews();
        };

        const renderAllViews = () => {
            renderDashboard();
            renderPortfolio();
            renderTransactions();
        };
        // --- End of FMP API Integration Changes ---

        const renderDashboard = () => {
            const summary = calculatePortfolioSummary(transactionsData);
            totalValueEl.textContent = formatCurrency(summary.totalValue, 'US');
            
            overallGainLossEl.textContent = formatCurrency(summary.overallGainLoss, 'US');
            overallGainLossEl.classList.remove('text-green-600', 'text-red-600');
            overallGainLossEl.classList.add(summary.overallGainLoss >= 0 ? 'text-green-600' : 'text-red-600');
            
            overallGainLossPctEl.textContent = ` (${summary.overallGainLossPct.toFixed(2)}%)`;
            overallGainLossPctEl.classList.remove('text-green-500', 'text-red-500');
            overallGainLossPctEl.classList.add(summary.overallGainLossPct >= 0 ? 'text-green-500' : 'text-red-500');
            
            twrValueEl.textContent = `${summary.twr.toFixed(2)}%`;
            mwrValueEl.textContent = `${summary.mwr.toFixed(2)}%`;
            
            renderAllocationChart(summary.allocation);
        };
        
        const renderPortfolio = () => {
            investmentsList.innerHTML = '';
            const filteredHoldings = Object.values(groupedHoldings).filter(holding => {
                if (currentFilter === 'all') return true;
                if (currentFilter === 'Stock' || currentFilter === 'ETF') {
                    return holding.assetType === currentFilter;
                }
                return holding.market === currentFilter;
            });
            
            if (filteredHoldings.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                filteredHoldings.forEach(holding => {
                    investmentsList.appendChild(createInvestmentItem(holding));
                });
            }
        };
        
        const renderTransactions = () => {
            transactionsList.innerHTML = '';
            const sortedTransactions = [...transactionsData].sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());
            
            if (sortedTransactions.length === 0) {
                emptyTransactionsState.classList.remove('hidden');
            } else {
                emptyTransactionsState.classList.add('hidden');
                sortedTransactions.forEach(tx => {
                    transactionsList.appendChild(createTransactionItem(tx));
                });
            }
        };
        
        const createInvestmentItem = (holding) => {
            const item = document.createElement('div');
            item.className = 'bg-gray-50 p-4 rounded-xl shadow border border-gray-100 flex justify-between items-center cursor-pointer hover:bg-gray-100 transition-colors duration-200';
            item.setAttribute('data-ticker', holding.ticker);
            
            const totalCost = holding.averageBuyPrice * holding.totalShares;
            const gainLoss = holding.currentValue - totalCost;
            const gainLossPercent = totalCost > 0 ? (gainLoss / totalCost) * 100 : 0;
            const gainLossClass = gainLoss >= 0 ? 'text-green-600' : 'text-red-600';
            const gainLossSymbol = gainLoss >= 0 ? 'â–²' : 'â–¼';
            
            item.innerHTML = `
                <div>
                    <h3 class="font-semibold text-gray-800">${holding.ticker} <span class="text-sm font-normal text-gray-500">(${holding.market})</span></h3>
                    <p class="text-xs text-gray-500">${holding.assetType}</p>
                    <p class="mt-1 text-sm text-gray-700">Shares: ${holding.totalShares}</p>
                </div>
                <div class="text-right">
                    <p class="text-lg font-bold">${formatCurrency(holding.currentValue, holding.market)}</p>
                    <p class="text-sm ${gainLossClass}">${gainLossSymbol} ${formatCurrency(gainLoss, holding.market)} (${gainLossPercent.toFixed(2)}%)</p>
                </div>
            `;
            
            item.addEventListener('click', () => {
                showInvestmentDetails(holding.ticker);
            });
            
            return item;
        };
        
        const createTransactionItem = (tx) => {
            const item = document.createElement('div');
            item.className = 'bg-gray-50 p-4 rounded-xl shadow border border-gray-100 flex items-center justify-between';
            
            const isBuy = tx.type === 'Buy';
            const typeClass = isBuy ? 'text-green-600' : 'text-red-600';
            const sign = isBuy ? '+' : '-';
            const price = isBuy ? tx.buyPrice : tx.sellPrice;
            const total = tx.shares * price;
            
            item.innerHTML = `
                <div class="flex items-center space-x-4">
                    <div class="flex-shrink-0">
                        <svg class="h-8 w-8 ${typeClass}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${isBuy ? 'M12 6v6m0 0v6m0-6h6m-6 0H6' : 'M18 12H6'}" />
                        </svg>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800">${tx.type} ${tx.ticker} <span class="text-sm font-normal text-gray-500">(${tx.market})</span></p>
                        <p class="text-xs text-gray-500 mt-1">${tx.timestamp.toLocaleDateString()}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="font-bold ${typeClass}">${sign}${formatCurrency(total, tx.market)}</p>
                    <p class="text-sm text-gray-700 mt-1">${tx.shares} shares @ ${formatCurrency(price, tx.market)}</p>
                </div>
            `;
            
            const actions = document.createElement('div');
            actions.className = 'flex space-x-2 ml-4';
            
            const editBtn = document.createElement('button');
            editBtn.className = 'text-gray-500 hover:text-indigo-600 transition-colors duration-200';
            editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-7.22 7.22a2 2 0 01-.707.514L4 16l-1 1a1 1 0 01-1-1l1-1 3.84-3.84a1 1 0 01.514-.707l7.22-7.22zM15 6L8.5 12.5 7 11 13.5 4.5 15 6z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>`;
            editBtn.title = 'Edit Transaction';
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                editTransaction(tx.id);
            });
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'text-gray-500 hover:text-red-600 transition-colors duration-200';
            deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>`;
            deleteBtn.title = 'Delete Transaction';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                showMessage('Are you sure you want to delete this transaction?', 'confirm', () => deleteTransaction(tx.id));
            });
            
            actions.appendChild(editBtn);
            actions.appendChild(deleteBtn);
            
            item.appendChild(actions);
            return item;
        };
        
        const showInvestmentDetails = (ticker) => {
            currentInvestment = groupedHoldings[ticker];
            if (!currentInvestment) return;
            
            detailsModalTitle.textContent = `${currentInvestment.ticker} (${currentInvestment.market})`;
            detailsSharesEl.textContent = `${currentInvestment.totalShares} shares`;
            detailsBuyPriceEl.textContent = formatCurrency(currentInvestment.averageBuyPrice, currentInvestment.market);
            detailsTotalCostEl.textContent = formatCurrency(currentInvestment.totalCost, currentInvestment.market);
            detailsCurrentValueEl.textContent = formatCurrency(currentInvestment.currentValue, currentInvestment.market);
            
            const gainLoss = currentInvestment.currentValue - currentInvestment.totalCost;
            const gainLossPercent = currentInvestment.totalCost > 0 ? (gainLoss / currentInvestment.totalCost) * 100 : 0;
            detailsGainLossEl.textContent = `${formatCurrency(gainLoss, currentInvestment.market)} (${gainLossPercent.toFixed(2)}%)`;
            detailsGainLossEl.classList.remove('text-green-600', 'text-red-600');
            detailsGainLossEl.classList.add(gainLoss >= 0 ? 'text-green-600' : 'text-red-600');
            
            // Render the price chart with simulated data
            renderPriceChart();
            
            // Render the transactions for this specific ticker
            renderDetailsTransactions();
            
            showModal(detailsModal);
        };
        
        const renderDetailsTransactions = () => {
            detailsTransactionsList.innerHTML = '';
            const tickerTransactions = transactionsData
                .filter(tx => tx.ticker === currentInvestment.ticker)
                .sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());
                
            if (tickerTransactions.length === 0) {
                emptyDetailsTransactionsState.classList.remove('hidden');
            } else {
                emptyDetailsTransactionsState.classList.add('hidden');
                tickerTransactions.forEach(tx => {
                    detailsTransactionsList.appendChild(createTransactionItem(tx));
                });
            }
        };
        
        const renderPriceChart = () => {
            if (priceChart) {
                priceChart.destroy();
            }
            
            const simulatedPrices = generateSimulatedPriceData(currentInvestment.ticker);
            const data = {
                labels: simulatedPrices.map(p => p.date),
                datasets: [{
                    label: `${currentInvestment.ticker} Price (${currentInvestment.market})`,
                    data: simulatedPrices.map(p => p.price),
                    borderColor: '#4f46e5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    tension: 0.4,
                    fill: true,
                }]
            };
            
            const options = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'category',
                        ticks: {
                            callback: function(val, index) {
                                return index % 5 === 0 ? this.getLabelForValue(val) : '';
                            }
                        }
                    },
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Price'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            };
            
            priceChart = new Chart(priceChartCtx, {
                type: 'line',
                data: data,
                options: options,
            });
        };
        
        const renderAllocationChart = (allocation) => {
            if (allocationChart) {
                allocationChart.destroy();
            }
            
            if (Object.keys(allocation).length === 0) {
                chartPlaceholder.classList.remove('hidden');
                document.getElementById('allocation-chart').classList.add('hidden');
                return;
            }
            
            chartPlaceholder.classList.add('hidden');
            document.getElementById('allocation-chart').classList.remove('hidden');
            
            const labels = Object.keys(allocation);
            const dataValues = Object.values(allocation).map(item => item.value);
            const backgroundColors = labels.map(label => {
                if (allocation[label].market === 'US') return '#4f46e5';
                if (allocation[label].market === 'Malaysia') return '#10b981';
                return '#6b7280';
            });
            
            const data = {
                labels: labels.map(l => `${l} (${(allocation[l].value / Object.values(allocation).reduce((sum, item) => sum + item.value, 0) * 100).toFixed(1)}%)`),
                datasets: [{
                    data: dataValues,
                    backgroundColor: backgroundColors,
                    hoverOffset: 8,
                }]
            };
            
            const options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                return `${label}: ${formatCurrency(value, '')}`;
                            }
                        }
                    }
                }
            };
            
            allocationChart = new Chart(allocationChartCtx, {
                type: 'doughnut',
                data: data,
                options: options
            });
        };
        
        // --- Modal & UI Management ---
        
        const showModal = (modal) => {
            modal.classList.remove('hidden');
        };
        
        const hideModal = (modal) => {
            modal.classList.add('hidden');
        };
        
        const showMessage = (message, type, onConfirm) => {
            messageBoxText.textContent = message;
            messageBoxActions.innerHTML = '';
            
            if (type === 'confirm') {
                const okBtn = document.createElement('button');
                okBtn.id = 'message-box-confirm-btn';
                okBtn.className = 'bg-red-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-red-700 transition-colors duration-200';
                okBtn.textContent = 'Confirm';
                okBtn.addEventListener('click', () => {
                    if (onConfirm) onConfirm();
                    hideModal(messageBox);
                });
                
                const cancelBtn = document.createElement('button');
                cancelBtn.id = 'message-box-cancel-btn';
                cancelBtn.className = 'bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-300 transition-colors duration-200';
                cancelBtn.textContent = 'Cancel';
                cancelBtn.addEventListener('click', () => {
                    hideModal(messageBox);
                });
                
                messageBoxActions.appendChild(okBtn);
                messageBoxActions.appendChild(cancelBtn);
            } else {
                const okBtn = document.createElement('button');
                okBtn.id = 'message-box-ok-btn';
                okBtn.className = 'bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors duration-200';
                okBtn.textContent = 'OK';
                okBtn.addEventListener('click', () => {
                    hideModal(messageBox);
                });
                messageBoxActions.appendChild(okBtn);
            }
            
            showModal(messageBox);
        };
        
        // --- Helper Functions ---
        
        const calculatePortfolioSummary = (transactions) => {
            let totalValue = 0;
            let totalCost = 0;
            let twr = 0;
            let mwr = 0;
            
            const allocation = {};
            
            // Simplified calculation for demo purposes
            Object.values(groupedHoldings).forEach(h => {
                totalValue += h.currentValue;
                totalCost += h.totalCost;
                
                if (!allocation[h.ticker]) {
                    allocation[h.ticker] = {
                        value: 0,
                        market: h.market
                    };
                }
                allocation[h.ticker].value += h.currentValue;
            });
            
            const overallGainLoss = totalValue - totalCost;
            const overallGainLossPct = totalCost > 0 ? (overallGainLoss / totalCost) * 100 : 0;
            
            // Dummy values for TWR and MWR
            if (totalValue > 0) {
                twr = Math.random() * 20;
                mwr = Math.random() * 20;
            }
            
            return {
                totalValue,
                totalCost,
                overallGainLoss,
                overallGainLossPct,
                twr,
                mwr,
                allocation
            };
        };
        
        // --- START of Updated Price Logic (Replaces old 'groupHoldingsByTicker' and 'generateSimulatedPrice') ---
        const groupHoldingsByTicker = async (transactions) => {
            const holdings = {};
            const uniqueTickers = [...new Set(transactions.map(tx => tx.ticker))];
            
            // Fetch prices for all unique tickers in parallel
            const fetchPromises = uniqueTickers.map(async (ticker) => {
                const price = await fetchStockPrice(ticker);
                return { ticker, price };
            });
            
            const prices = await Promise.all(fetchPromises);
            const priceMap = new Map(prices.map(p => [p.ticker, p.price]));
            
            transactions.forEach(tx => {
                const ticker = tx.ticker;
                if (!holdings[ticker]) {
                    holdings[ticker] = {
                        ticker: ticker,
                        market: tx.market,
                        assetType: tx.assetType,
                        transactions: [],
                        totalShares: 0,
                        totalCost: 0,
                        averageBuyPrice: 0,
                        currentValue: 0,
                        currentPrice: priceMap.get(ticker) || 0 // Use the fetched price
                    };
                }
                holdings[ticker].transactions.push(tx);
                
                const price = tx.type === 'Buy' ? tx.buyPrice : tx.sellPrice;
                const shares = tx.shares;
                
                if (tx.type === 'Buy') {
                    holdings[ticker].totalShares += shares;
                    holdings[ticker].totalCost += shares * price;
                } else {
                    const averagePrice = holdings[ticker].totalCost / holdings[ticker].totalShares;
                    holdings[ticker].totalShares -= shares;
                    holdings[ticker].totalCost = holdings[ticker].totalShares * averagePrice;
                }
            });
            
            Object.values(holdings).forEach(holding => {
                holding.averageBuyPrice = holding.totalShares > 0 ? holding.totalCost / holding.totalShares : 0;
                holding.currentValue = holding.totalShares * holding.currentPrice;
            });
            
            return holdings;
        };

        const generateSimulatedPriceData = (ticker) => {
            // This function remains simulated because FMP's free plan doesn't offer historical data
            const data = [];
            const endDate = new Date();
            const basePrice = currentInvestment.averageBuyPrice;
            
            for (let i = 30; i >= 0; i--) {
                const date = new Date(endDate);
                date.setDate(endDate.getDate() - i);
                const seed = ticker.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0);
                const multiplier = (Math.sin(seed + date.getTime() / 10000000) * 0.2) + 1; // Fluctuates +/- 20%
                data.push({
                    date: date.toLocaleDateString(),
                    price: basePrice * multiplier
                });
            }
            return data;
        };
        // --- END of Updated Price Logic ---
        
        const formatCurrency = (amount, market) => {
            let currency = '';
            if (market === 'US') currency = 'USD';
            if (market === 'Malaysia') currency = 'MYR';
            
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: currency,
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        };
        
        const editTransaction = (transactionId) => {
            const tx = transactionsData.find(t => t.id === transactionId);
            if (!tx) return;
            
            showModal(investmentModal);
            modalTitle.textContent = 'Edit Transaction';
            transactionIdInput.value = tx.id;
            transactionDateInput.value = tx.timestamp.toISOString().split('T')[0];
            
            // Set transaction type
            currentTxType = tx.type;
            if (tx.type === 'Buy') {
                typeBuyBtn.click();
            } else {
                typeSellBtn.click();
            }
            
            marketSelect.value = tx.market;
            assetTypeSelect.value = tx.assetType;
            tickerInput.value = tx.ticker;
            sharesInput.value = tx.shares;
            buyPriceInput.value = tx.buyPrice;
            sellPriceInput.value = tx.sellPrice;
        };
        
        // --- Event Listeners ---
        
        authToggleLink.addEventListener('click', () => {
            const isLogin = authSubmitBtn.textContent === 'Sign in';
            authModalTitle.textContent = isLogin ? 'Sign up' : 'Sign in';
            authSubmitBtn.textContent = isLogin ? 'Sign up' : 'Sign in';
            authToggleLink.innerHTML = isLogin ? 'Already have an account? <span class="font-medium text-indigo-600 hover:text-indigo-800">Sign in</span>' : 'Don\'t have an account? <span class="font-medium text-indigo-600 hover:text-indigo-800">Sign up</span>';
        });
        
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            const isLogin = authSubmitBtn.textContent === 'Sign in';
            
            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                }
                console.log('Authentication successful.');
            } catch (error) {
                console.error("Authentication error:", error);
                alert('Authentication failed: ' + error.message);
            }
        });
        
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log("Logged out successfully.");
            } catch (error) {
                console.error("Error logging out:", error);
            }
        });
        
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                navItems.forEach(nav => {
                    nav.classList.remove('active-nav-bg', 'active-nav');
                    nav.classList.add('text-gray-500');
                });
                item.classList.add('active-nav-bg', 'active-nav');
                item.classList.remove('text-gray-500');
                
                const pageId = item.id.replace('nav-', '');
                pages.forEach(page => {
                    if (page.id === `${pageId}-page`) {
                        page.classList.remove('hidden');
                    } else {
                        page.classList.add('hidden');
                    }
                });
            });
        });
        
        addInvestmentBtn.addEventListener('click', () => {
            showModal(investmentModal);
            modalTitle.textContent = 'Add New Transaction';
            investmentForm.reset();
            transactionIdInput.value = '';
            currentTxType = 'Buy';
            typeBuyBtn.click();
            transactionDateInput.valueAsDate = new Date(); // Set to current date
        });
        
        closeModalBtn.addEventListener('click', () => {
            hideModal(investmentModal);
        });
        
        closeDetailsModalBtn.addEventListener('click', () => {
            hideModal(detailsModal);
        });
        
        closeAiModalBtn.addEventListener('click', () => {
            hideModal(aiResponseModal);
        });
        
        typeBuyBtn.addEventListener('click', () => {
            currentTxType = 'Buy';
            typeBuyBtn.classList.add('bg-indigo-600', 'text-white');
            typeBuyBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            typeSellBtn.classList.remove('bg-indigo-600', 'text-white');
            typeSellBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            buyPriceGroup.classList.remove('hidden');
            sellPriceGroup.classList.add('hidden');
            buyPriceInput.required = true;
            sellPriceInput.required = false;
        });
        
        typeSellBtn.addEventListener('click', () => {
            currentTxType = 'Sell';
            typeSellBtn.classList.add('bg-indigo-600', 'text-white');
            typeSellBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            typeBuyBtn.classList.remove('bg-indigo-600', 'text-white');
            typeBuyBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            buyPriceGroup.classList.add('hidden');
            sellPriceGroup.classList.remove('hidden');
            buyPriceInput.required = false;
            sellPriceInput.required = true;
        });
        
        investmentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const transaction = {
                ticker: tickerInput.value.toUpperCase(),
                shares: parseFloat(sharesInput.value),
                type: currentTxType,
                market: marketSelect.value,
                assetType: assetTypeSelect.value,
                timestamp: new Date(transactionDateInput.value)
            };
            
            if (currentTxType === 'Buy') {
                transaction.buyPrice = parseFloat(buyPriceInput.value);
            } else {
                transaction.sellPrice = parseFloat(sellPriceInput.value);
            }
            
            if (transactionIdInput.value) {
                transaction.id = transactionIdInput.value;
                await updateTransaction(transaction);
            } else {
                await addTransaction(transaction);
            }
        });
        
        deleteDataBtn.addEventListener('click', () => {
            showMessage('Are you sure you want to delete ALL of your portfolio data? This cannot be undone.', 'confirm', deleteAllUserData);
        });
        
        getAiInsightsBtn.addEventListener('click', async () => {
            aiResponseContent.innerHTML = `<div class="flex items-center justify-center"><div class="animate-spin rounded-full h-8 w-8 border-2 border-t-2 border-blue-500 border-opacity-75"></div></div>`;
            showModal(aiResponseModal);
            
            const portfolio = groupedHoldings; // Use the already fetched data
            const portfolioString = JSON.stringify(portfolio);
            
            const prompt = `You are a financial analyst. Provide a concise, clear, and actionable summary of the following investment portfolio data. Focus on key metrics, asset allocation, and potential risks or opportunities. The user is a Malaysian investor, so provide context where relevant. Keep it under 200 words.
            
            Portfolio Data:
            ${portfolioString}`;
            
            try {
                const response = await fetch(geminiApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }]
                    })
                });
                
                const data = await response.json();
                const aiText = data?.candidates?.[0]?.content?.parts?.[0]?.text || 'No insights available. The AI model might have an error.';
                
                aiResponseContent.innerHTML = `<p>${aiText}</p>`;
            } catch (error) {
                console.error("Error fetching AI insights:", error);
                aiResponseContent.innerHTML = `<p class="text-red-500">Failed to load AI insights. Please check your API key and network connection.</p>`;
            }
        });
        
        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                filterBtns.forEach(fBtn => {
                    fBtn.classList.remove('bg-indigo-200', 'text-indigo-800', 'font-semibold');
                    fBtn.classList.add('bg-gray-200', 'text-gray-700');
                });
                btn.classList.add('bg-indigo-200', 'text-indigo-800', 'font-semibold');
                btn.classList.remove('bg-gray-200', 'text-gray-700');
                
                currentFilter = btn.dataset.filter;
                renderPortfolio();
            });
        });
        
    </script>

</body>
</html>
