<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 900px;
            margin: auto;
        }
        .active-nav {
            color: #4f46e5;
        }
        .active-nav-bg {
            background-color: #eef2ff;
        }
        .delete-btn {
            background-color: #fca5a5;
            color: #991b1b;
        }
        .delete-btn:hover {
            background-color: #f87171;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="fixed inset-0 bg-gray-200 bg-opacity-75 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-blue-500 border-opacity-75"></div>
    </div>
    
    <!-- Login/Signup Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h3 id="auth-modal-title" class="text-2xl font-bold text-center mb-6 text-gray-800">Sign in</h3>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="auth-email" class="block text-sm font-medium text-gray-700">Email address</label>
                    <input type="email" id="auth-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="auth-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="auth-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <button type="submit" id="auth-submit-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors duration-200">Sign in</button>
            </form>
            <p id="auth-toggle-link" class="text-center text-sm mt-4 text-gray-600 cursor-pointer">
                Don't have an account? <span class="font-medium text-indigo-600 hover:text-indigo-800">Sign up</span>
            </p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="container bg-white rounded-xl shadow-lg m-4 p-6 flex-grow relative hidden">

        <!-- Header and User Info -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">My Portfolio</h1>
            <div class="flex items-center space-x-2">
                <div class="flex items-center space-x-2 bg-gray-50 text-gray-600 px-3 py-1 rounded-full text-sm">
                    <span id="user-id-display" class="truncate">Authenticating...</span>
                </div>
                <button id="logout-btn" class="text-sm text-red-500 hover:text-red-700 transition-colors duration-200 font-medium">Log out</button>
            </div>
        </header>

        <!-- Main Content Area -->
        <div id="content-area" class="pb-24">
            <!-- Dashboard View -->
            <div id="dashboard-page" class="page">
                <section class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-indigo-50 p-6 rounded-xl shadow-inner border border-indigo-200">
                        <h2 class="text-lg text-indigo-800 font-semibold mb-2">Total Portfolio Value</h2>
                        <p id="total-value" class="text-4xl font-bold text-indigo-600">$0.00</p>
                    </div>
                    <div class="bg-green-50 p-6 rounded-xl shadow-inner border border-green-200">
                        <h2 class="text-lg text-green-800 font-semibold mb-2">Overall Gain/Loss</h2>
                        <p id="overall-gain-loss" class="text-4xl font-bold text-green-600">$0.00</p>
                        <span id="overall-gain-loss-pct" class="text-green-500 text-sm font-medium"> (0.00%)</span>
                    </div>
                </section>
                
                <section class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-blue-50 p-6 rounded-xl shadow-inner border border-blue-200">
                        <h2 class="text-lg text-blue-800 font-semibold mb-2">Time-Weighted Return (TWR)</h2>
                        <p id="twr-value" class="text-4xl font-bold text-blue-600">0.00%</p>
                        <p class="text-xs text-gray-500 mt-2">A measure of compound growth, unaffected by deposits/withdrawals.</p>
                    </div>
                    <div class="bg-blue-50 p-6 rounded-xl shadow-inner border border-blue-200">
                        <h2 class="text-lg text-blue-800 font-semibold mb-2">Money-Weighted Return (MWR)</h2>
                        <p id="mwr-value" class="text-4xl font-bold text-blue-600">0.00%</p>
                        <p class="text-xs text-gray-500 mt-2">The return rate that accounts for timing of cash flows.</p>
                    </div>
                </section>

                <section class="bg-white p-6 rounded-xl shadow border border-gray-100 mb-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Asset Allocation</h2>
                    <div class="w-full h-64 flex items-center justify-center">
                        <p id="chart-placeholder" class="text-gray-400">Add a transaction to see your asset allocation here.</p>
                        <canvas id="allocation-chart" class="w-full h-full hidden"></canvas>
                    </div>
                </section>

                <section class="flex justify-center">
                    <button id="get-ai-insights-btn" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-medium shadow-md hover:bg-purple-700 transition-colors duration-200">
                        Get AI Portfolio Summary âœ¨
                    </button>
                </section>
            </div>

            <!-- Portfolio View -->
            <div id="portfolio-page" class="page hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">My Investments</h2>
                    <button id="add-investment-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium shadow hover:bg-blue-700 transition-colors duration-200">
                        + Add New
                    </button>
                </div>
                <div class="flex items-center space-x-2 mb-4">
                    <span class="text-sm font-medium text-gray-700">Filter By:</span>
                    <button data-filter="all" class="filter-btn text-sm px-3 py-1 rounded-full bg-indigo-200 text-indigo-800 font-semibold">All</button>
                    <button data-filter="US" class="filter-btn text-sm px-3 py-1 rounded-full bg-gray-200 text-gray-700">US</button>
                    <button data-filter="Malaysia" class="filter-btn text-sm px-3 py-1 rounded-full bg-gray-200 text-gray-700">Malaysia</button>
                    <button data-filter="Stock" class="filter-btn text-sm px-3 py-1 rounded-full bg-gray-200 text-gray-700">Stocks</button>
                    <button data-filter="ETF" class="filter-btn text-sm px-3 py-1 rounded-full bg-gray-200 text-gray-700">ETFs</button>
                </div>
                <div id="investments-list" class="space-y-4">
                    <!-- Investment items will be rendered here -->
                </div>
                <div id="empty-state" class="text-center text-gray-400 mt-8 hidden">
                    <p class="mb-2">You don't have any investments yet.</p>
                    <p>Click "Add New" to get started!</p>
                </div>
            </div>

            <!-- Transactions View -->
            <div id="transactions-page" class="page hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Transaction History</h2>
                <div id="transactions-list" class="space-y-4">
                    <!-- Transaction items will be rendered here -->
                </div>
                <div id="empty-transactions-state" class="text-center text-gray-400 mt-8 hidden">
                    <p class="mb-2">No transactions recorded.</p>
                </div>
            </div>

            <!-- Markets View -->
            <div id="markets-page" class="page hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Global Markets</h2>
                <div class="bg-gray-50 p-6 rounded-xl shadow-inner text-center text-gray-400">
                    <p>This section would display live market data, news, and indices.</p>
                    <p>This is a placeholder as real-time market data requires a separate API integration.</p>
                </div>
            </div>

            <!-- Profile/Settings View -->
            <div id="profile-page" class="page hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Profile & Settings</h2>
                <div class="bg-gray-50 p-6 rounded-xl shadow-inner">
                    <p class="font-medium text-gray-700 mb-2">Your User ID:</p>
                    <p id="profile-user-id" class="text-sm font-mono break-all text-gray-500">Not available in demo mode</p>
                </div>
                <div class="mt-6 bg-red-50 p-6 rounded-xl shadow-inner border border-red-200">
                    <h3 class="text-lg font-semibold text-red-800 mb-2">Danger Zone</h3>
                    <p class="text-sm text-red-700 mb-4">
                        This action will permanently delete all of your data from the app.
                    </p>
                    <button id="delete-data-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium shadow hover:bg-red-700 transition-colors duration-200">
                        Delete My Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Adding/Editing an Investment -->
    <div id="investment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800">Add New Transaction</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">&times;</button>
            </div>
            <form id="investment-form" class="space-y-4">
                <div>
                    <label for="transaction-date" class="block text-sm font-medium text-gray-700">Date</label>
                    <input type="date" id="transaction-date" name="transaction-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Transaction Type</label>
                    <div class="mt-1 flex space-x-2">
                        <button type="button" id="type-buy-btn" class="flex-1 py-2 rounded-lg font-medium shadow-sm transition-colors duration-200 bg-indigo-600 text-white">Buy</button>
                        <button type="button" id="type-sell-btn" class="flex-1 py-2 rounded-lg font-medium shadow-sm transition-colors duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300">Sell</button>
                    </div>
                </div>
                <div>
                    <label for="market" class="block text-sm font-medium text-gray-700">Market</label>
                    <select id="market" name="market" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="US">US</option>
                        <option value="Malaysia">Malaysia</option>
                    </select>
                </div>
                <div>
                    <label for="asset-type" class="block text-sm font-medium text-gray-700">Asset Type</label>
                    <select id="asset-type" name="asset-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="Stock">Stock</option>
                        <option value="ETF">ETF</option>
                    </select>
                </div>
                <div>
                    <label for="ticker" class="block text-sm font-medium text-gray-700">Ticker Symbol</label>
                    <input type="text" id="ticker" name="ticker" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="shares" class="block text-sm font-medium text-gray-700">Number of Shares</label>
                    <input type="number" id="shares" name="shares" required min="0.01" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div id="buy-price-group" class="price-group">
                    <label for="buy-price" class="block text-sm font-medium text-gray-700">Buy Price (USD/MYR)</label>
                    <input type="number" id="buy-price" name="buy-price" required min="0.01" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div id="sell-price-group" class="price-group hidden">
                    <label for="sell-price" class="block text-sm font-medium text-gray-700">Sell Price (USD/MYR)</label>
                    <input type="number" id="sell-price" name="sell-price" required min="0.01" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <input type="hidden" id="transaction-id">
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors duration-200 mt-4">Save Transaction</button>
            </form>
        </div>
    </div>

    <!-- Modal for Detailed Investment View -->
    <div id="details-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 id="details-modal-title" class="text-xl font-bold text-gray-800"></h3>
                <button id="close-details-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">&times;</button>
            </div>
            <div class="space-y-4">
                <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                    <h4 class="font-semibold text-gray-700 mb-2">Price History (Simulated)</h4>
                    <div class="w-full h-48">
                        <canvas id="price-chart"></canvas>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-500">Quantity Owned</p>
                        <p id="details-shares" class="text-lg font-bold text-gray-800"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-500">Average Buy Price</p>
                        <p id="details-buy-price" class="text-lg font-bold text-gray-800"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-500">Total Cost</p>
                        <p id="details-total-cost" class="text-lg font-bold text-gray-800"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-500">Current Market Value</p>
                        <p id="details-current-value" class="text-lg font-bold text-gray-800"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm col-span-2">
                        <p class="text-sm text-gray-500">Unrealized Gain/Loss</p>
                        <p id="details-gain-loss" class="text-lg font-bold text-gray-800"></p>
                    </div>
                </div>
                <!-- New section for Transaction Log -->
                <div class="mt-6">
                    <h4 class="font-semibold text-xl text-gray-700 mb-2">Transaction History</h4>
                    <div id="details-transactions-list" class="space-y-4">
                        <!-- Transactions for this specific ticker will be rendered here -->
                    </div>
                    <div id="empty-details-transactions-state" class="text-center text-gray-400 mt-4 hidden">
                        <p>No transactions for this holding.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Message Box Modal -->
    <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
            <p id="message-box-text" class="text-gray-800 text-lg mb-4"></p>
            <div id="message-box-actions" class="flex justify-center space-x-4">
                <button id="message-box-ok-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors duration-200">OK</button>
            </div>
        </div>
    </div>

    <!-- AI Response Modal -->
    <div id="ai-response-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 id="ai-modal-title" class="text-xl font-bold text-gray-800">AI Insights</h3>
                <button id="close-ai-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">&times;</button>
            </div>
            <div id="ai-response-content" class="text-gray-700 prose max-w-none">
                <div class="flex items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-2 border-t-2 border-blue-500 border-opacity-75"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-2xl border-t border-gray-200 z-30">
        <ul class="flex justify-around items-center h-16 text-gray-500 text-sm">
            <li>
                <button id="nav-dashboard" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200 active-nav-bg active-nav">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <span class="mt-1">Dashboard</span>
                </button>
            </li>
            <li>
                <button id="nav-portfolio" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-2v2m-4-2v2m4-2h.01M12 18a6 6 0 100-12 6 6 0 000 12z" />
                    </svg>
                    <span class="mt-1">Portfolio</span>
                </button>
            </li>
            <li>
                <button id="nav-transactions" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="mt-1">Transactions</span>
                </button>
            </li>
            <li>
                <button id="nav-markets" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8L11 20" />
                    </svg>
                    <span class="mt-1">Markets</span>
                </button>
            </li>
            <li>
                <button id="nav-profile" class="nav-item flex flex-col items-center p-2 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span class="mt-1">Profile</span>
                </button>
            </li>
        </ul>
    </nav>

    <!-- External Libraries (Firebase and Chart.js) -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, setLogLevel, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { Chart, DoughnutController, ArcElement, LineController, CategoryScale, LinearScale, PointElement, LineElement, Tooltip, Legend } from 'https://cdn.jsdelivr.net/npm/chart.js@4.4.3/+esm';

        // Register Chart.js components
        Chart.register(DoughnutController, ArcElement, LineController, CategoryScale, LinearScale, PointElement, LineElement, Tooltip, Legend);
        
        // --- Firebase & App State Initialization ---
        let app, db, auth, userId, unsubscribe;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Let's set the log level to debug for now
        setLogLevel('debug');
        
        let transactionsData = [];
        let groupedHoldings = {};
        let allocationChart = null;
        let priceChart = null;
        let currentFilter = 'all';
        let currentTxType = 'Buy';
        let currentInvestment = null; // Store the currently viewed investment for the details modal

        // --- DOM Elements ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const appContainer = document.getElementById('app-container');
        const authModal = document.getElementById('auth-modal');
        const authModalTitle = document.getElementById('auth-modal-title');
        const authForm = document.getElementById('auth-form');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authToggleLink = document.getElementById('auth-toggle-link');
        const logoutBtn = document.getElementById('logout-btn');
        const userIdDisplay = document.getElementById('user-id-display');
        const profileUserIdDisplay = document.getElementById('profile-user-id');
        const navItems = document.querySelectorAll('.nav-item');
        const pages = document.querySelectorAll('.page');
        const addInvestmentBtn = document.getElementById('add-investment-btn');
        const investmentModal = document.getElementById('investment-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const investmentForm = document.getElementById('investment-form');
        const investmentsList = document.getElementById('investments-list');
        const emptyState = document.getElementById('empty-state');
        const totalValueEl = document.getElementById('total-value');
        const overallGainLossEl = document.getElementById('overall-gain-loss');
        const overallGainLossPctEl = document.getElementById('overall-gain-loss-pct');
        const twrValueEl = document.getElementById('twr-value');
        const mwrValueEl = document.getElementById('mwr-value');
        const transactionsList = document.getElementById('transactions-list');
        const emptyTransactionsState = document.getElementById('empty-transactions-state');
        const deleteDataBtn = document.getElementById('delete-data-btn');
        const messageBox = document.getElementById('message-box');
        const messageBoxText = document.getElementById('message-box-text');
        const messageBoxActions = document.getElementById('message-box-actions');
        const allocationChartCtx = document.getElementById('allocation-chart').getContext('2d');
        const chartPlaceholder = document.getElementById('chart-placeholder');
        const getAiInsightsBtn = document.getElementById('get-ai-insights-btn');
        const aiResponseModal = document.getElementById('ai-response-modal');
        const closeAiModalBtn = document.getElementById('close-ai-modal-btn');
        const aiModalTitle = document.getElementById('ai-modal-title');
        const aiResponseContent = document.getElementById('ai-response-content');
        const filterBtns = document.querySelectorAll('.filter-btn');
        
        // Detail Modal Elements
        const detailsModal = document.getElementById('details-modal');
        const closeDetailsModalBtn = document.getElementById('close-details-modal-btn');
        const detailsModalTitle = document.getElementById('details-modal-title');
        const detailsSharesEl = document.getElementById('details-shares');
        const detailsBuyPriceEl = document.getElementById('details-buy-price');
        const detailsTotalCostEl = document.getElementById('details-total-cost');
        const detailsCurrentValueEl = document.getElementById('details-current-value');
        const detailsGainLossEl = document.getElementById('details-gain-loss');
        const priceChartCtx = document.getElementById('price-chart').getContext('2d');
        const detailsTransactionsList = document.getElementById('details-transactions-list');
        const emptyDetailsTransactionsState = document.getElementById('empty-details-transactions-state');
        
        // Transaction Form Elements
        const modalTitle = document.getElementById('modal-title');
        const transactionIdInput = document.getElementById('transaction-id');
        const transactionDateInput = document.getElementById('transaction-date');
        const typeBuyBtn = document.getElementById('type-buy-btn');
        const typeSellBtn = document.getElementById('type-sell-btn');
        const buyPriceGroup = document.getElementById('buy-price-group');
        const sellPriceGroup = document.getElementById('sell-price-group');
        const tickerInput = document.getElementById('ticker');
        const sharesInput = document.getElementById('shares');
        const buyPriceInput = document.getElementById('buy-price');
        const sellPriceInput = document.getElementById('sell-price');
        const marketSelect = document.getElementById('market');
        const assetTypeSelect = document.getElementById('asset-type');
        
        // --- Firebase Functions ---
        const getCollectionRef = () => {
            if (!userId) return null;
            // IMPORTANT: Use the /artifacts/{appId}/users/{userId}/... structure
            const collectionPath = `/artifacts/${appId}/users/${userId}/transactions`;
            return collection(db, collectionPath);
        };
        
        const listenForTransactions = () => {
            if (unsubscribe) {
                unsubscribe();
            }
            const collectionRef = getCollectionRef();
            if (!collectionRef) {
                console.error("Collection reference is null, cannot listen for updates.");
                return;
            }
            unsubscribe = onSnapshot(collectionRef, (querySnapshot) => {
                const transactions = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    transactions.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp.toDate() // Convert Firestore Timestamp to JS Date
                    });
                });
                transactionsData = transactions;
                groupedHoldings = groupHoldingsByTicker(transactionsData);
                renderAllViews();
            }, (error) => {
                console.error("Error fetching transactions:", error);
            });
        };
        
        const addTransaction = async (transaction) => {
            const collectionRef = getCollectionRef();
            if (!collectionRef) {
                console.error("Not authenticated, cannot add transaction.");
                return;
            }
            await addDoc(collectionRef, transaction);
        };

        const updateTransaction = async (id, updatedTransaction) => {
            const collectionRef = getCollectionRef();
            const docRef = doc(collectionRef, id);
            await setDoc(docRef, updatedTransaction, { merge: true });
        };

        const deleteTransaction = async (id) => {
            const collectionRef = getCollectionRef();
            const docRef = doc(collectionRef, id);
            await deleteDoc(docRef);
        };

        const deleteAllData = async () => {
            try {
                const collectionRef = getCollectionRef();
                if (!collectionRef) {
                    showMessageBox('User not authenticated.');
                    return;
                }
                const querySnapshot = await getDocs(collectionRef);
                const batch = writeBatch(db);
                querySnapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                showMessageBox('All your data has been permanently deleted.', 'Data Deleted');
            } catch (error) {
                console.error("Error deleting data:", error);
                showMessageBox('Failed to delete data. Please try again.', 'Error');
            }
        };

        // --- Core Application Logic ---

        // Simple utility to format numbers as currency
        const formatCurrency = (value, market) => {
            const locale = market === 'US' ? 'en-US' : 'en-MY';
            const currency = market === 'US' ? 'USD' : 'MYR';
            return new Intl.NumberFormat(locale, {
                style: 'currency',
                currency: currency
            }).format(value);
        };

        // Simple utility to show and hide modals
        const showModal = (modal) => modal.classList.remove('hidden');
        const hideModal = (modal) => modal.classList.add('hidden');
        const showElement = (el) => el.classList.remove('hidden');
        const hideElement = (el) => el.classList.add('hidden');

        // Handles custom message box for a consistent UI
        const showMessageBox = (message, title = 'Notification', actions = [{ text: 'OK', handler: () => hideModal(messageBox) }]) => {
            messageBoxText.textContent = message;
            messageBoxActions.innerHTML = '';
            actions.forEach(action => {
                const button = document.createElement('button');
                button.textContent = action.text;
                button.className = 'bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors duration-200';
                button.onclick = () => {
                    action.handler();
                    hideModal(messageBox);
                };
                messageBoxActions.appendChild(button);
            });
            showModal(messageBox);
        };

        const showPage = (pageId) => {
            pages.forEach(page => hideElement(page));
            navItems.forEach(item => {
                item.classList.remove('active-nav', 'active-nav-bg');
                item.classList.add('text-gray-500');
            });
            const selectedNav = document.getElementById(`nav-${pageId.replace('-page', '')}`);
            if (selectedNav) {
                selectedNav.classList.add('active-nav', 'active-nav-bg');
                selectedNav.classList.remove('text-gray-500');
            }
            showElement(document.getElementById(pageId));
        };

        const groupHoldingsByTicker = (transactions) => {
            const holdings = {};
            transactions.sort((a, b) => a.timestamp - b.timestamp); // Sort by date for accurate calculations
            
            transactions.forEach(tx => {
                if (!holdings[tx.ticker]) {
                    holdings[tx.ticker] = {
                        ticker: tx.ticker,
                        market: tx.market,
                        assetType: tx.assetType,
                        shares: 0,
                        totalCost: 0,
                        transactions: []
                    };
                }

                if (tx.type === 'Buy') {
                    holdings[tx.ticker].shares += tx.shares;
                    holdings[tx.ticker].totalCost += tx.shares * tx.price;
                } else if (tx.type === 'Sell') {
                    holdings[tx.ticker].shares -= tx.shares;
                    // Proportional cost basis calculation for sales
                    const averageBuyPrice = holdings[tx.ticker].totalCost / holdings[tx.ticker].shares;
                    const soldCost = tx.shares * averageBuyPrice;
                    holdings[tx.ticker].totalCost -= soldCost;
                }
                holdings[tx.ticker].transactions.push(tx);
            });

            // Filter out holdings with 0 or negative shares
            return Object.values(holdings).filter(h => h.shares > 0);
        };

        const simulateCurrentPrices = (holdings) => {
            // A simple pseudo-random price for a demo. In a real app, this would be an API call.
            const today = new Date();
            return holdings.map(holding => {
                const currentPrice = (holding.transactions[0].price * (1 + (Math.random() - 0.5) * 0.2)); // +/- 10% random
                return {
                    ...holding,
                    currentPrice: currentPrice,
                    currentValue: currentPrice * holding.shares
                };
            });
        };

        const calculateFinancials = () => {
            const holdingsWithPrices = simulateCurrentPrices(groupedHoldings);
            let totalValue = 0;
            let totalCost = 0;

            holdingsWithPrices.forEach(h => {
                totalValue += h.currentValue;
                totalCost += h.totalCost;
            });
            const gainLoss = totalValue - totalCost;
            const gainLossPct = totalCost > 0 ? (gainLoss / totalCost) * 100 : 0;

            totalValueEl.textContent = formatCurrency(totalValue, 'US'); // Assuming USD for portfolio totals
            overallGainLossEl.textContent = formatCurrency(gainLoss, 'US');
            overallGainLossEl.classList.remove('text-green-600', 'text-red-600');
            overallGainLossEl.classList.add(gainLoss >= 0 ? 'text-green-600' : 'text-red-600');
            overallGainLossPctEl.textContent = `(${gainLossPct.toFixed(2)}%)`;
            overallGainLossPctEl.classList.remove('text-green-500', 'text-red-500');
            overallGainLossPctEl.classList.add(gainLoss >= 0 ? 'text-green-500' : 'text-red-500');
        };

        const calculateTWR = () => {
            if (transactionsData.length === 0) {
                twrValueEl.textContent = '0.00%';
                return;
            }

            let sortedTxs = [...transactionsData].sort((a, b) => a.timestamp.getTime() - b.timestamp.getTime());
            let timePeriods = {};

            // Initial value is 0 unless there's a starting deposit (which we don't track here)
            let periodStartTime = new Date(sortedTxs[0].timestamp.getTime());
            let periodValue = 0;
            let totalReturn = 1;

            sortedTxs.forEach(tx => {
                let intervalReturn = 0;
                let marketValueAtStart = periodValue;
                if (marketValueAtStart > 0) {
                    intervalReturn = (simulateCurrentPrices(groupHoldingsByTicker(sortedTxs.filter(t => t.timestamp.getTime() <= tx.timestamp.getTime())))[0].currentValue - marketValueAtStart) / marketValueAtStart;
                }
                
                // Simplified, but a more accurate TWR requires value at each transaction point
                // and linking those returns. For this demo, let's simplify.
                
                // Let's use a simpler, more robust, but still approximate TWR
                // Let's assume cash flows are just Buy/Sell transactions for now
                let cashFlows = [...transactionsData].map(tx => ({
                    date: tx.timestamp,
                    amount: (tx.type === 'Buy' ? -1 : 1) * (tx.shares * tx.price)
                }));
                let twr = 0;
                if(cashFlows.length > 0) {
                    const totalInvested = cashFlows.filter(cf => cf.amount < 0).reduce((sum, cf) => sum + Math.abs(cf.amount), 0);
                    const currentValue = simulateCurrentPrices(groupedHoldings).reduce((sum, h) => sum + h.currentValue, 0);
                    const gainLoss = currentValue - totalInvested;
                    twr = totalInvested > 0 ? (gainLoss / totalInvested) * 100 : 0;
                }
                twrValueEl.textContent = `${twr.toFixed(2)}%`;
            });
        };

        const calculateMWR = () => {
            if (transactionsData.length === 0) {
                mwrValueEl.textContent = '0.00%';
                return;
            }

            // MWR is the Internal Rate of Return (IRR). We'll approximate using a numerical method.
            // XIRR is the function needed for uneven cash flows.
            const sortedTxs = [...transactionsData].sort((a, b) => a.timestamp.getTime() - b.timestamp.getTime());
            const firstDate = sortedTxs[0].timestamp.getTime();
            const today = new Date().getTime();

            const cashFlows = sortedTxs.map(tx => ({
                date: (tx.timestamp.getTime() - firstDate) / (1000 * 60 * 60 * 24), // Days since start
                amount: (tx.type === 'Buy' ? -1 : 1) * (tx.shares * tx.price)
            }));
            
            // Add a final cash flow for the current portfolio value
            const currentValue = simulateCurrentPrices(groupedHoldings).reduce((sum, h) => sum + h.currentValue, 0);
            cashFlows.push({
                date: (today - firstDate) / (1000 * 60 * 60 * 24),
                amount: currentValue
            });

            // Newton-Raphson method for XIRR
            const xirr = (values, dates, guess) => {
                const maxIterations = 100;
                const tolerance = 0.00001;

                let rate = guess;
                for (let i = 0; i < maxIterations; i++) {
                    let fValue = 0;
                    let fDerivative = 0;
                    for (let j = 0; j < values.length; j++) {
                        const days = (dates[j] - dates[0]) / (1000 * 60 * 60 * 24);
                        fValue += values[j] / Math.pow(1 + rate, days / 365);
                        fDerivative -= values[j] * days / 365 * Math.pow(1 + rate, days / 365 + 1);
                    }
                    const nextRate = rate - fValue / fDerivative;
                    if (Math.abs(nextRate - rate) < tolerance) {
                        return nextRate;
                    }
                    rate = nextRate;
                }
                return NaN;
            };

            const rates = xirr(
                cashFlows.map(cf => cf.amount),
                cashFlows.map(cf => cf.date),
                0.1
            );

            mwrValueEl.textContent = `${(rates * 100).toFixed(2)}%`;
        };

        const renderAllocationChart = () => {
            if (allocationChart) {
                allocationChart.destroy();
            }
            if (Object.keys(groupedHoldings).length === 0) {
                hideElement(document.getElementById('allocation-chart'));
                showElement(chartPlaceholder);
                return;
            }
            hideElement(chartPlaceholder);
            showElement(document.getElementById('allocation-chart'));

            const holdingsWithPrices = simulateCurrentPrices(groupedHoldings);
            const data = {
                labels: holdingsWithPrices.map(h => h.ticker),
                datasets: [{
                    label: 'Portfolio Allocation',
                    data: holdingsWithPrices.map(h => h.currentValue),
                    backgroundColor: [
                        'rgba(79, 70, 229, 0.8)', 'rgba(34, 197, 94, 0.8)', 'rgba(239, 68, 68, 0.8)', 'rgba(59, 130, 246, 0.8)', 'rgba(234, 179, 8, 0.8)', 'rgba(168, 85, 247, 0.8)'
                    ],
                    borderColor: '#fff',
                    hoverOffset: 4
                }]
            };

            const options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                const percentage = total > 0 ? (value / total * 100).toFixed(2) : 0;
                                return `${label}: ${formatCurrency(value, 'US')} (${percentage}%)`;
                            }
                        }
                    }
                }
            };
            allocationChart = new Chart(allocationChartCtx, { type: 'doughnut', data, options });
        };
        
        const renderPriceChart = (ticker) => {
            if (priceChart) {
                priceChart.destroy();
            }
            
            // Get relevant transactions for the ticker
            const relevantTxs = transactionsData.filter(tx => tx.ticker === ticker).sort((a,b) => a.timestamp - b.timestamp);
            
            // Simple simulation of price history based on transactions
            const labels = relevantTxs.map(tx => new Date(tx.timestamp).toLocaleDateString());
            const data = relevantTxs.map(tx => tx.price);

            const chartData = {
                labels: labels,
                datasets: [{
                    label: `${ticker} Price History`,
                    data: data,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1,
                    fill: false
                }]
            };

            const options = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        title: { display: true, text: 'Price' }
                    }
                }
            };
            priceChart = new Chart(priceChartCtx, { type: 'line', data: chartData, options: options });
        };

        const renderPortfolioView = () => {
            investmentsList.innerHTML = '';
            const filteredHoldings = groupedHoldings.filter(h => {
                if (currentFilter === 'all') return true;
                return h.market === currentFilter || h.assetType === currentFilter;
            });

            if (filteredHoldings.length === 0) {
                showElement(emptyState);
                return;
            }
            hideElement(emptyState);
            
            const holdingsWithPrices = simulateCurrentPrices(filteredHoldings);

            holdingsWithPrices.forEach(holding => {
                const averagePrice = holding.totalCost / holding.shares;
                const gainLoss = holding.currentValue - holding.totalCost;
                const gainLossPct = holding.totalCost > 0 ? (gainLoss / holding.totalCost) * 100 : 0;
                
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl shadow border border-gray-100 flex items-center justify-between';
                card.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0">
                            <span class="text-3xl">${holding.assetType === 'Stock' ? 'ðŸ“ˆ' : 'ðŸ“Š'}</span>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">${holding.ticker}</h3>
                            <p class="text-sm text-gray-500">${holding.shares.toFixed(2)} shares, Avg. ${formatCurrency(averagePrice, holding.market)}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-gray-800">${formatCurrency(holding.currentValue, holding.market)}</p>
                        <p class="${gainLoss >= 0 ? 'text-green-500' : 'text-red-500'} text-sm font-medium">
                            ${formatCurrency(gainLoss, holding.market)} (${gainLossPct.toFixed(2)}%)
                        </p>
                        <button class="view-details-btn text-xs text-indigo-500 hover:text-indigo-700 transition-colors duration-200" data-ticker="${holding.ticker}">View Details</button>
                    </div>
                `;
                investmentsList.appendChild(card);
            });
        };

        const renderTransactionsView = () => {
            transactionsList.innerHTML = '';
            if (transactionsData.length === 0) {
                showElement(emptyTransactionsState);
                return;
            }
            hideElement(emptyTransactionsState);

            const sortedTxs = [...transactionsData].sort((a, b) => b.timestamp - a.timestamp);

            sortedTxs.forEach(tx => {
                const txClass = tx.type === 'Buy' ? 'bg-green-50' : 'bg-red-50';
                const txColor = tx.type === 'Buy' ? 'text-green-800' : 'text-red-800';
                
                const card = document.createElement('div');
                card.className = `p-4 rounded-xl shadow border ${txClass} flex items-center justify-between`;
                card.innerHTML = `
                    <div>
                        <h3 class="font-semibold ${txColor}">${tx.type} ${tx.shares} shares of ${tx.ticker}</h3>
                        <p class="text-sm text-gray-500">
                            ${formatCurrency(tx.shares * tx.price, tx.market)} on ${tx.timestamp.toLocaleDateString()}
                        </p>
                    </div>
                    <div>
                        <button class="edit-tx-btn text-gray-400 hover:text-indigo-600 transition-colors duration-200 mr-2" data-id="${tx.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button class="delete-tx-btn text-gray-400 hover:text-red-600 transition-colors duration-200" data-id="${tx.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
                transactionsList.appendChild(card);
            });
        };

        const renderDetailsModalContent = (ticker) => {
            const holding = groupedHoldings.find(h => h.ticker === ticker);
            if (!holding) {
                hideModal(detailsModal);
                showMessageBox('Investment details not found.');
                return;
            }

            const holdingsWithPrices = simulateCurrentPrices([holding]);
            const holdingWithPrice = holdingsWithPrices[0];
            const averagePrice = holdingWithPrice.totalCost / holdingWithPrice.shares;
            const gainLoss = holdingWithPrice.currentValue - holdingWithPrice.totalCost;
            const gainLossPct = holdingWithPrice.totalCost > 0 ? (gainLoss / holdingWithPrice.totalCost) * 100 : 0;

            detailsModalTitle.textContent = `${holding.ticker} - ${holding.assetType} (${holding.market})`;
            detailsSharesEl.textContent = holding.shares.toFixed(2);
            detailsBuyPriceEl.textContent = formatCurrency(averagePrice, holding.market);
            detailsTotalCostEl.textContent = formatCurrency(holdingWithPrice.totalCost, holding.market);
            detailsCurrentValueEl.textContent = formatCurrency(holdingWithPrice.currentValue, holding.market);
            detailsGainLossEl.textContent = `${formatCurrency(gainLoss, holding.market)} (${gainLossPct.toFixed(2)}%)`;
            detailsGainLossEl.classList.remove('text-green-600', 'text-red-600');
            detailsGainLossEl.classList.add(gainLoss >= 0 ? 'text-green-600' : 'text-red-600');

            renderPriceChart(ticker);

            // Render transaction log for this ticker
            detailsTransactionsList.innerHTML = '';
            const sortedTxs = holding.transactions.sort((a, b) => b.timestamp - a.timestamp);
            if (sortedTxs.length > 0) {
                hideElement(emptyDetailsTransactionsState);
                sortedTxs.forEach(tx => {
                    const txClass = tx.type === 'Buy' ? 'bg-green-50' : 'bg-red-50';
                    const txColor = tx.type === 'Buy' ? 'text-green-800' : 'text-red-800';
                    const item = document.createElement('div');
                    item.className = `p-3 rounded-lg border-2 ${txClass}`;
                    item.innerHTML = `
                        <p class="font-medium ${txColor}">${tx.type} ${tx.shares.toFixed(2)} shares @ ${formatCurrency(tx.price, tx.market)}</p>
                        <p class="text-sm text-gray-500">Date: ${tx.timestamp.toLocaleDateString()}</p>
                    `;
                    detailsTransactionsList.appendChild(item);
                });
            } else {
                showElement(emptyDetailsTransactionsState);
            }
        };

        const renderAllViews = () => {
            calculateFinancials();
            calculateTWR();
            calculateMWR();
            renderAllocationChart();
            renderPortfolioView();
            renderTransactionsView();
        };

        // --- Event Handlers ---

        const setupEventHandlers = () => {
            // Navigation
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const pageId = `${item.id.replace('nav-', '')}-page`;
                    showPage(pageId);
                });
            });

            // Auth form
            let isSignUp = false;
            authToggleLink.addEventListener('click', () => {
                isSignUp = !isSignUp;
                authModalTitle.textContent = isSignUp ? 'Sign up' : 'Sign in';
                authSubmitBtn.textContent = isSignUp ? 'Sign up' : 'Sign in';
                authToggleLink.innerHTML = isSignUp ? `Already have an account? <span class="font-medium text-indigo-600 hover:text-indigo-800">Sign in</span>` : `Don't have an account? <span class="font-medium text-indigo-600 hover:text-indigo-800">Sign up</span>`;
            });
            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = authEmailInput.value;
                const password = authPasswordInput.value;
                try {
                    loadingSpinner.classList.remove('hidden');
                    if (isSignUp) {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (error) {
                    console.error("Auth error:", error);
                    let errorMessage = "An unknown error occurred.";
                    if (error.code) {
                        errorMessage = error.code.replace('auth/', '').replace(/-/g, ' ');
                    }
                    showMessageBox(`Authentication failed: ${errorMessage}`);
                } finally {
                    loadingSpinner.classList.add('hidden');
                }
            });

            // Logout
            logoutBtn.addEventListener('click', async () => {
                await signOut(auth);
            });

            // Add/Edit transaction form
            addInvestmentBtn.addEventListener('click', () => {
                currentInvestment = null;
                investmentForm.reset();
                modalTitle.textContent = 'Add New Transaction';
                transactionIdInput.value = '';
                // Set default date to today
                const today = new Date().toISOString().split('T')[0];
                transactionDateInput.value = today;
                
                currentTxType = 'Buy';
                typeBuyBtn.classList.add('bg-indigo-600', 'text-white');
                typeBuyBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                typeSellBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                typeSellBtn.classList.remove('bg-indigo-600', 'text-white');
                showElement(buyPriceGroup);
                hideElement(sellPriceGroup);
                
                showModal(investmentModal);
            });
            closeModalBtn.addEventListener('click', () => hideModal(investmentModal));
            investmentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const transaction = {
                    ticker: tickerInput.value.toUpperCase(),
                    shares: parseFloat(sharesInput.value),
                    price: parseFloat(currentTxType === 'Buy' ? buyPriceInput.value : sellPriceInput.value),
                    market: marketSelect.value,
                    assetType: assetTypeSelect.value,
                    type: currentTxType,
                    timestamp: new Date(transactionDateInput.value)
                };

                try {
                    if (transactionIdInput.value) {
                        await updateTransaction(transactionIdInput.value, transaction);
                    } else {
                        await addTransaction(transaction);
                    }
                    hideModal(investmentModal);
                    investmentForm.reset();
                } catch (error) {
                    console.error("Error saving transaction:", error);
                    showMessageBox('Failed to save transaction. Please check your inputs.', 'Error');
                }
            });
            typeBuyBtn.addEventListener('click', () => {
                currentTxType = 'Buy';
                typeBuyBtn.classList.add('bg-indigo-600', 'text-white');
                typeBuyBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                typeSellBtn.classList.remove('bg-indigo-600', 'text-white');
                typeSellBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                showElement(buyPriceGroup);
                hideElement(sellPriceGroup);
            });
            typeSellBtn.addEventListener('click', () => {
                currentTxType = 'Sell';
                typeSellBtn.classList.add('bg-indigo-600', 'text-white');
                typeSellBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                typeBuyBtn.classList.remove('bg-indigo-600', 'text-white');
                typeBuyBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                hideElement(buyPriceGroup);
                showElement(sellPriceGroup);
            });

            // Edit/Delete transactions
            investmentsList.addEventListener('click', (e) => {
                if (e.target.closest('.view-details-btn')) {
                    const ticker = e.target.closest('.view-details-btn').dataset.ticker;
                    renderDetailsModalContent(ticker);
                    showModal(detailsModal);
                }
            });
            transactionsList.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-tx-btn');
                const editBtn = e.target.closest('.edit-tx-btn');

                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    showMessageBox('Are you sure you want to delete this transaction?', 'Confirm Deletion', [
                        { text: 'Cancel', handler: () => hideModal(messageBox) },
                        { text: 'Delete', handler: () => deleteTransaction(id) }
                    ]);
                } else if (editBtn) {
                    const id = editBtn.dataset.id;
                    const tx = transactionsData.find(t => t.id === id);
                    if (tx) {
                        modalTitle.textContent = 'Edit Transaction';
                        transactionIdInput.value = tx.id;
                        transactionDateInput.value = tx.timestamp.toISOString().split('T')[0];
                        sharesInput.value = tx.shares;
                        tickerInput.value = tx.ticker;
                        marketSelect.value = tx.market;
                        assetTypeSelect.value = tx.assetType;
                        
                        currentTxType = tx.type;
                        if (currentTxType === 'Buy') {
                            buyPriceInput.value = tx.price;
                            typeBuyBtn.click();
                        } else {
                            sellPriceInput.value = tx.price;
                            typeSellBtn.click();
                        }

                        showModal(investmentModal);
                    }
                }
            });

            // Close details modal
            closeDetailsModalBtn.addEventListener('click', () => hideModal(detailsModal));

            // Delete all data
            deleteDataBtn.addEventListener('click', () => {
                showMessageBox('This action will permanently delete all of your portfolio data. This cannot be undone. Are you sure?', 'Danger Zone', [
                    { text: 'Cancel', handler: () => hideModal(messageBox) },
                    { text: 'Delete All', handler: () => deleteAllData() }
                ]);
            });

            // Filter buttons
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const newFilter = btn.dataset.filter;
                    currentFilter = newFilter;
                    filterBtns.forEach(f => {
                        f.classList.remove('bg-indigo-200', 'text-indigo-800', 'font-semibold');
                        f.classList.add('bg-gray-200', 'text-gray-700');
                    });
                    btn.classList.add('bg-indigo-200', 'text-indigo-800', 'font-semibold');
                    btn.classList.remove('bg-gray-200', 'text-gray-700');
                    renderPortfolioView();
                });
            });

            // AI Insights Button
            getAiInsightsBtn.addEventListener('click', async () => {
                showModal(aiResponseModal);
                aiResponseContent.innerHTML = `<div class="flex items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-2 border-t-2 border-blue-500 border-opacity-75"></div>
                </div>`;
                
                try {
                    const prompt = `Act as a world-class financial analyst. Provide a concise, single-paragraph summary of the key findings for the following investment portfolio. Highlight portfolio concentration, major sectors/markets, and overall performance. Focus on providing actionable insights and avoid generic statements.

                    Portfolio data: ${JSON.stringify(groupedHoldings)}`;

                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        tools: [{ "google_search": {} }],
                        systemInstruction: {
                            parts: [{ text: "You are a financial analyst providing a portfolio summary. Your response must be a single paragraph." }]
                        },
                    };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    const text = candidate?.content?.parts?.[0]?.text || "No insights available.";
                    
                    const sources = candidate?.groundingMetadata?.groundingAttributions?.map(attr => ({
                        uri: attr.web?.uri,
                        title: attr.web?.title
                    })) || [];

                    let sourcesHtml = '';
                    if (sources.length > 0) {
                        sourcesHtml = `<div class="mt-4 text-sm text-gray-500">
                                        <p class="font-bold">Sources:</p>
                                        <ul class="list-disc list-inside">
                                            ${sources.map(s => `<li><a href="${s.uri}" target="_blank" class="text-indigo-600 hover:underline">${s.title}</a></li>`).join('')}
                                        </ul>
                                      </div>`;
                    }

                    aiResponseContent.innerHTML = `
                        <p>${text}</p>
                        ${sourcesHtml}
                    `;
                    
                } catch (error) {
                    console.error("AI Insights Error:", error);
                    aiResponseContent.innerHTML = `<p class="text-red-500">Failed to get AI insights. Please try again later.</p>`;
                }
            });
            closeAiModalBtn.addEventListener('click', () => hideModal(aiResponseModal));
        };
        
        // --- Firebase Auth Listener & App Initialization ---
        const initializeAppAndAuth = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId.slice(0, 8)}...`;
                        profileUserIdDisplay.textContent = userId;
                        hideModal(authModal);
                        showElement(appContainer);
                        listenForTransactions();
                    } else {
                        // Not signed in, show auth modal
                        hideElement(appContainer);
                        showModal(authModal);
                        userIdDisplay.textContent = 'Signed out';
                        profileUserIdDisplay.textContent = 'Not signed in';
                    }
                    hideModal(loadingSpinner);
                });

                // Sign in with custom token or anonymously if the token is not available
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessageBox('Failed to initialize the application. Please refresh the page.', 'Initialization Error');
                hideModal(loadingSpinner);
            }
        };

        // Initialize the app on page load
        initializeAppAndAuth();
        setupEventHandlers();

    </script>
</body>
</html>
